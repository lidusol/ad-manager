import { __decorate } from "tslib";
import { Component, ElementRef, NgZone, Input, ChangeDetectionStrategy, Inject, ViewChild } from '@angular/core';
import { normalizePassiveListenerOptions } from '@angular/cdk/platform';
import { Style, StyleRenderer } from '@alyle/ui';
import { STYLES, LyImageCropper } from './image-cropper';
import { DOCUMENT } from '@angular/common';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@alyle/ui';
import * as ɵngcc2 from '@angular/common';

const _c0 = ["resizer"];
function LyCropperArea_div_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "div", null, 1);
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵclassMap(ctx_r0.classes.resizer);
} }
const activeEventOptions = normalizePassiveListenerOptions({ passive: false });
const pos = (100 * Math.sqrt(2) - 100) / 2 / Math.sqrt(2);
const ɵ0 = (_value, _, { classes: __ }) => ({ after }) => (className) => `${className}{border-radius:50%;}${className} .${__.resizer}{${after}:${pos}%;bottom:${pos}%;transform:translate(4px, 4px);}`;
/**
 * @dynamic
 */
export class LyCropperArea {
    constructor(sRenderer, _elementRef, _ngZone, _cropper, _document) {
        this.sRenderer = sRenderer;
        this._elementRef = _elementRef;
        this._ngZone = _ngZone;
        this._cropper = _cropper;
        this.classes = this.sRenderer.renderSheet(STYLES, 'area');
        this._pointerDown = (event) => {
            // Don't do anything if the
            // user is using anything other than the main mouse button.
            if (this._isSliding || (!isTouchEvent(event) && event.button !== 0)) {
                return;
            }
            event.preventDefault();
            this._ngZone.run(() => {
                this._isSliding = true;
                this._lastPointerEvent = event;
                this._startPointerEvent = getGesturePointFromEvent(event);
                this._startAreaRect = this._cropper._areaCropperRect();
                this._startImgRect = this._cropper._canvasRect();
                event.preventDefault();
                this._bindGlobalEvents(event);
            });
        };
        this._pointerMove = (event) => {
            if (this._isSliding) {
                event.preventDefault();
                this._lastPointerEvent = event;
                const element = this._elementRef.nativeElement;
                const { width, height, minWidth, minHeight } = this._cropper.config;
                const point = getGesturePointFromEvent(event);
                const deltaX = point.x - this._startPointerEvent.x;
                const deltaY = point.y - this._startPointerEvent.y;
                const startAreaRect = this._startAreaRect;
                const startImgRect = this._startImgRect;
                const round = this.round;
                const keepAspectRatio = this._cropper.config.keepAspectRatio || event.shiftKey;
                let newWidth = 0;
                let newHeight = 0;
                const rootRect = this._cropper._rootRect();
                if (round) {
                    // The distance from the center of the cropper area to the pointer
                    const originX = ((width / 2 / Math.sqrt(2)) + deltaX);
                    const originY = ((height / 2 / Math.sqrt(2)) + deltaY);
                    // Leg
                    const side = Math.sqrt(Math.pow(originX, 2) + Math.pow(originY, 2));
                    newWidth = newHeight = side * 2;
                }
                else if (keepAspectRatio) {
                    newWidth = width + deltaX * 2;
                    newHeight = height + deltaY * 2;
                    if (width !== height) {
                        if (width > height) {
                            newHeight = height / (width / newWidth);
                        }
                        else if (height > width) {
                            newWidth = width / (height / newHeight);
                        }
                    }
                    else {
                        newWidth = newHeight = Math.max(newWidth, newHeight);
                    }
                }
                else {
                    newWidth = width + deltaX * 2;
                    newHeight = height + deltaY * 2;
                }
                // To min width
                if (newWidth < minWidth) {
                    newWidth = minWidth;
                }
                // To min height
                if (newHeight < minHeight) {
                    newHeight = minHeight;
                }
                // Do not overflow the cropper area
                const centerX = startAreaRect.x + startAreaRect.width / 2;
                const centerY = startAreaRect.y + startAreaRect.height / 2;
                const topOverflow = startImgRect.y > centerY - (newHeight / 2);
                const bottomOverflow = centerY + (newHeight / 2) > startImgRect.bottom;
                const minHeightOnOverflow = Math.min((centerY - startImgRect.y) * 2, (startImgRect.bottom - centerY) * 2);
                const leftOverflow = startImgRect.x > centerX - (newWidth / 2);
                const rightOverflow = centerX + (newWidth / 2) > startImgRect.right;
                const minWidthOnOverflow = Math.min((centerX - startImgRect.x) * 2, (startImgRect.right - centerX) * 2);
                const minOnOverflow = Math.min(minWidthOnOverflow, minHeightOnOverflow);
                if (round) {
                    if (topOverflow || bottomOverflow || leftOverflow || rightOverflow) {
                        newHeight = newWidth = minOnOverflow;
                    }
                }
                else if (keepAspectRatio) {
                    const newNewWidth = [];
                    const newNewHeight = [];
                    if ((topOverflow || bottomOverflow) && Math.min()) {
                        newHeight = minHeightOnOverflow;
                        newNewHeight.push(newHeight);
                        newWidth = width / (height / minHeightOnOverflow);
                        newNewWidth.push(newWidth);
                    }
                    if ((leftOverflow || rightOverflow)) {
                        newWidth = minWidthOnOverflow;
                        newNewWidth.push(newWidth);
                        newHeight = height / (width / minWidthOnOverflow);
                        newNewHeight.push(newHeight);
                    }
                    if (newNewWidth.length === 2) {
                        newWidth = Math.min(...newNewWidth);
                    }
                    if (newNewHeight.length === 2) {
                        newHeight = Math.min(...newNewHeight);
                    }
                }
                else {
                    if (topOverflow || bottomOverflow) {
                        newHeight = minHeightOnOverflow;
                    }
                    if (leftOverflow || rightOverflow) {
                        newWidth = minWidthOnOverflow;
                    }
                }
                // Do not overflow the container
                if (round) {
                    const min = Math.min(rootRect.width, rootRect.height);
                    if (newWidth > min) {
                        newWidth = newHeight = min;
                    }
                    else if (newHeight > min) {
                        newWidth = newHeight = min;
                    }
                }
                else if (keepAspectRatio) {
                    if (newWidth > rootRect.width) {
                        newWidth = rootRect.width;
                        newHeight = height / (width / rootRect.width);
                    }
                    else if (newHeight > rootRect.height) {
                        newWidth = width / (height / rootRect.height);
                        newHeight = rootRect.height;
                    }
                }
                else {
                    if (newWidth > rootRect.width) {
                        newWidth = rootRect.width;
                    }
                    else if (newHeight > rootRect.height) {
                        newHeight = rootRect.height;
                    }
                }
                // round values
                newWidth = Math.round(newWidth);
                newHeight = Math.round(newHeight);
                element.style.width = `${newWidth}px`;
                element.style.height = `${newHeight}px`;
                this._currentWidth = newWidth;
                this._currentHeight = newHeight;
            }
        };
        /** Called when the user has lifted their pointer. */
        this._pointerUp = (event) => {
            if (this._isSliding) {
                event.preventDefault();
                this._removeGlobalEvents();
                this._cropper._primaryAreaWidth = this._cropper.config.width = this._currentWidth;
                this._cropper._primaryAreaHeight = this._cropper.config.height = this._currentHeight;
                this._cropper.config = this._cropper.config;
                this._cropper._updateMinScale();
                this._isSliding = false;
                this._startPointerEvent = null;
            }
        };
        /** Called when the window has lost focus. */
        this._windowBlur = () => {
            // If the window is blurred while dragging we need to stop dragging because the
            // browser won't dispatch the `mouseup` and `touchend` events anymore.
            if (this._lastPointerEvent) {
                this._pointerUp(this._lastPointerEvent);
            }
        };
        this._document = _document;
    }
    set resizableArea(val) {
        if (val !== this._resizableArea) {
            this._resizableArea = val;
            Promise.resolve(null).then(() => {
                if (val) {
                    this._removeResizableArea();
                    this._addResizableArea();
                }
                else {
                    this._removeResizableArea();
                }
            });
        }
    }
    get resizableArea() {
        return this._resizableArea;
    }
    ngOnDestroy() {
        this._removeResizableArea();
    }
    _addResizableArea() {
        this._ngZone.runOutsideAngular(() => {
            const element = this._resizer.nativeElement;
            element.addEventListener('mousedown', this._pointerDown, activeEventOptions);
            element.addEventListener('touchstart', this._pointerDown, activeEventOptions);
        });
    }
    _removeResizableArea() {
        var _a;
        const element = (_a = this._resizer) === null || _a === void 0 ? void 0 : _a.nativeElement;
        if (element) {
            this._lastPointerEvent = null;
            this._removeGlobalEvents();
            element.removeEventListener('mousedown', this._pointerDown, activeEventOptions);
            element.removeEventListener('touchstart', this._pointerDown, activeEventOptions);
        }
    }
    _bindGlobalEvents(triggerEvent) {
        const element = this._document;
        const isTouch = isTouchEvent(triggerEvent);
        const moveEventName = isTouch ? 'touchmove' : 'mousemove';
        const endEventName = isTouch ? 'touchend' : 'mouseup';
        element.addEventListener(moveEventName, this._pointerMove, activeEventOptions);
        element.addEventListener(endEventName, this._pointerUp, activeEventOptions);
        if (isTouch) {
            element.addEventListener('touchcancel', this._pointerUp, activeEventOptions);
        }
        const window = this._getWindow();
        if (typeof window !== 'undefined' && window) {
            window.addEventListener('blur', this._windowBlur);
        }
    }
    /** Removes any global event listeners that we may have added. */
    _removeGlobalEvents() {
        const element = this._document;
        element.removeEventListener('mousemove', this._pointerMove, activeEventOptions);
        element.removeEventListener('mouseup', this._pointerUp, activeEventOptions);
        element.removeEventListener('touchmove', this._pointerMove, activeEventOptions);
        element.removeEventListener('touchend', this._pointerUp, activeEventOptions);
        element.removeEventListener('touchcancel', this._pointerUp, activeEventOptions);
        const window = this._getWindow();
        if (typeof window !== 'undefined' && window) {
            window.removeEventListener('blur', this._windowBlur);
        }
    }
    /** Use defaultView of injected document if available or fallback to global window reference */
    _getWindow() {
        return this._document.defaultView || window;
    }
}
LyCropperArea.ɵfac = function LyCropperArea_Factory(t) { return new (t || LyCropperArea)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.StyleRenderer), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(LyImageCropper), ɵngcc0.ɵɵdirectiveInject(DOCUMENT)); };
LyCropperArea.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: LyCropperArea, selectors: [["ly-cropper-area"]], viewQuery: function LyCropperArea_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(_c0, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx._resizer = _t.first);
    } }, inputs: { resizableArea: "resizableArea", keepAspectRatio: "keepAspectRatio", round: "round" }, exportAs: ["lyCropperArea"], features: [ɵngcc0.ɵɵProvidersFeature([
            StyleRenderer
        ])], decls: 1, vars: 1, consts: [[3, "class", 4, "ngIf"], ["resizer", ""]], template: function LyCropperArea_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, LyCropperArea_div_0_Template, 2, 2, "div", 0);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", ctx.resizableArea);
    } }, directives: [ɵngcc2.NgIf], encapsulation: 2, changeDetection: 0 });
LyCropperArea.ctorParameters = () => [
    { type: StyleRenderer },
    { type: ElementRef },
    { type: NgZone },
    { type: LyImageCropper },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
LyCropperArea.propDecorators = {
    _resizer: [{ type: ViewChild, args: ['resizer',] }],
    resizableArea: [{ type: Input }],
    keepAspectRatio: [{ type: Input }],
    round: [{ type: Input }]
};
__decorate([
    Style(ɵ0)
], LyCropperArea.prototype, "round", void 0);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(LyCropperArea, [{
        type: Component,
        args: [{
                selector: 'ly-cropper-area',
                template: "<div #resizer\n  *ngIf=\"resizableArea\"\n  [class]=\"classes.resizer\"\n></div>",
                providers: [
                    StyleRenderer
                ],
                changeDetection: ChangeDetectionStrategy.OnPush,
                exportAs: 'lyCropperArea'
            }]
    }], function () { return [{ type: ɵngcc1.StyleRenderer }, { type: ɵngcc0.ElementRef }, { type: ɵngcc0.NgZone }, { type: LyImageCropper }, { type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }]; }, { resizableArea: [{
            type: Input
        }], _resizer: [{
            type: ViewChild,
            args: ['resizer']
        }], keepAspectRatio: [{
            type: Input
        }], round: [{
            type: Input
        }] }); })();
function getGesturePointFromEvent(event) {
    // `touches` will be empty for start/end events so we have to fall back to `changedTouches`.
    const point = isTouchEvent(event)
        ? (event.touches[0] || event.changedTouches[0])
        : event;
    return {
        x: point.clientX,
        y: point.clientY
    };
}
/** Returns whether an event is a touch event. */
function isTouchEvent(event) {
    return event.type[0] === 't';
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY3JvcHBlci1hcmVhLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvaW1hZ2UtY3JvcHBlci9pbWFnZS1jcm9wcGVyLWFyZWEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQWEsdUJBQXVCLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1SCxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN4RSxPQUFPLEVBQ0wsS0FBSyxFQUVMLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuQyxPQUFPLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7Ozs7Ozs7Ozs7O0FBRTNDLE1BQU0sa0JBQWtCLEdBQUcsK0JBQStCLENBQUMsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztBQUU3RSxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFELFdBc0RJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFNBQWlCLEVBQUUsRUFBRSxDQUFDLEdBQUcsU0FBUyx1QkFBdUIsU0FBUyxLQUFLLEVBQUUsQ0FBQyxPQUFPLElBQUksS0FBSyxJQUFJLEdBQUcsWUFBWSxHQUFHLG1DQUFtQztBQXJEdk07QUFDQTtBQUNBLEdBQUc7QUFVSCxNQUFNLE9BQU8sYUFBYTtB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SyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25ELFFBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNaLElBQ0UsT0FBTztBQUNULFFBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxPQUFPO0FBQ3BCLFFBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxPQUFPO0FBQ3BCLEtBQUcsQ0FBQztBQUNKLENBQUM7QUFFRCxpREFBaUQ7QUFDakQsU0FBUyxZQUFZLENBQUMsS0FBOEI7QUFBSSxJQUN0RCxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDO0FBQy9CLENBQUM7QUFDRDtBQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBOZ1pvbmUsIElucHV0LCBPbkRlc3Ryb3ksIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBJbmplY3QsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbm9ybWFsaXplUGFzc2l2ZUxpc3RlbmVyT3B0aW9ucyB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XG5pbXBvcnQge1xuICBTdHlsZSxcbiAgV2l0aFN0eWxlcyxcbiAgU3R5bGVSZW5kZXJlciB9IGZyb20gJ0BhbHlsZS91aSc7XG5pbXBvcnQgeyBTVFlMRVMsIEx5SW1hZ2VDcm9wcGVyIH0gZnJvbSAnLi9pbWFnZS1jcm9wcGVyJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuY29uc3QgYWN0aXZlRXZlbnRPcHRpb25zID0gbm9ybWFsaXplUGFzc2l2ZUxpc3RlbmVyT3B0aW9ucyh7cGFzc2l2ZTogZmFsc2V9KTtcblxuY29uc3QgcG9zID0gKDEwMCAqIE1hdGguc3FydCgyKSAtIDEwMCkgLyAyIC8gTWF0aC5zcXJ0KDIpO1xuXG4vKipcbiAqIEBkeW5hbWljXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2x5LWNyb3BwZXItYXJlYScsXG4gIHRlbXBsYXRlVXJsOiAnLi9pbWFnZS1jcm9wcGVyLWFyZWEuaHRtbCcsXG4gIHByb3ZpZGVyczogW1xuICAgIFN0eWxlUmVuZGVyZXJcbiAgXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGV4cG9ydEFzOiAnbHlDcm9wcGVyQXJlYSdcbn0pXG5leHBvcnQgY2xhc3MgTHlDcm9wcGVyQXJlYSBpbXBsZW1lbnRzIFdpdGhTdHlsZXMsIE9uRGVzdHJveSB7XG4gIHJlYWRvbmx5IGNsYXNzZXMgPSB0aGlzLnNSZW5kZXJlci5yZW5kZXJTaGVldChTVFlMRVMsICdhcmVhJyk7XG5cbiAgcHJpdmF0ZSBfaXNTbGlkaW5nOiBib29sZWFuO1xuICAvKiogS2VlcHMgdHJhY2sgb2YgdGhlIGxhc3QgcG9pbnRlciBldmVudCB0aGF0IHdhcyBjYXB0dXJlZCBieSB0aGUgY3JvcCBhcmVhLiAqL1xuICBwcml2YXRlIF9sYXN0UG9pbnRlckV2ZW50OiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCB8IG51bGw7XG4gIHByaXZhdGUgX3N0YXJ0UG9pbnRlckV2ZW50OiB7XG4gICAgeDogbnVtYmVyXG4gICAgeTogbnVtYmVyXG4gIH0gfCBudWxsO1xuICBwcml2YXRlIF9jdXJyZW50V2lkdGg6IG51bWJlcjtcbiAgcHJpdmF0ZSBfY3VycmVudEhlaWdodDogbnVtYmVyO1xuICBwcml2YXRlIF9zdGFydEFyZWFSZWN0OiBET01SZWN0O1xuICBwcml2YXRlIF9zdGFydEltZ1JlY3Q6IERPTVJlY3Q7XG5cbiAgLyoqIFVzZWQgdG8gc3Vic2NyaWJlIHRvIGdsb2JhbCBtb3ZlIGFuZCBlbmQgZXZlbnRzICovXG4gIHByb3RlY3RlZCBfZG9jdW1lbnQ6IERvY3VtZW50O1xuXG4gIEBWaWV3Q2hpbGQoJ3Jlc2l6ZXInKSByZWFkb25seSBfcmVzaXplcj86IEVsZW1lbnRSZWY7XG5cbiAgQElucHV0KClcbiAgc2V0IHJlc2l6YWJsZUFyZWEodmFsOiBib29sZWFuKSB7XG4gICAgaWYgKHZhbCAhPT0gdGhpcy5fcmVzaXphYmxlQXJlYSkge1xuICAgICAgdGhpcy5fcmVzaXphYmxlQXJlYSA9IHZhbDtcbiAgICAgIFByb21pc2UucmVzb2x2ZShudWxsKS50aGVuKCgpID0+IHtcbiAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgIHRoaXMuX3JlbW92ZVJlc2l6YWJsZUFyZWEoKTtcbiAgICAgICAgICB0aGlzLl9hZGRSZXNpemFibGVBcmVhKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5fcmVtb3ZlUmVzaXphYmxlQXJlYSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgZ2V0IHJlc2l6YWJsZUFyZWEoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3Jlc2l6YWJsZUFyZWE7XG4gIH1cbiAgcHJpdmF0ZSBfcmVzaXphYmxlQXJlYTogYm9vbGVhbjtcbiAgQElucHV0KCkga2VlcEFzcGVjdFJhdGlvOiBib29sZWFuO1xuICBASW5wdXQoKVxuICBAU3R5bGU8Ym9vbGVhbiwgTHlDcm9wcGVyQXJlYT4oXG4gICAgKF92YWx1ZSwgXywgeyBjbGFzc2VzOiBfXyB9KSA9PiAoeyBhZnRlciB9KSA9PiAoY2xhc3NOYW1lOiBzdHJpbmcpID0+IGAke2NsYXNzTmFtZX17Ym9yZGVyLXJhZGl1czo1MCU7fSR7Y2xhc3NOYW1lfSAuJHtfXy5yZXNpemVyfXske2FmdGVyfToke3Bvc30lO2JvdHRvbToke3Bvc30lO3RyYW5zZm9ybTp0cmFuc2xhdGUoNHB4LCA0cHgpO31gXG4gICkgcm91bmQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgc1JlbmRlcmVyOiBTdHlsZVJlbmRlcmVyLFxuICAgIHJlYWRvbmx5IF9lbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgX25nWm9uZTogTmdab25lLFxuICAgIHJlYWRvbmx5IF9jcm9wcGVyOiBMeUltYWdlQ3JvcHBlcixcbiAgICBASW5qZWN0KERPQ1VNRU5UKSBfZG9jdW1lbnQ6IGFueSxcbiAgKSB7XG4gICAgdGhpcy5fZG9jdW1lbnQgPSBfZG9jdW1lbnQ7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLl9yZW1vdmVSZXNpemFibGVBcmVhKCk7XG4gIH1cblxuICBwcml2YXRlIF9hZGRSZXNpemFibGVBcmVhKCkge1xuICAgIHRoaXMuX25nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5fcmVzaXplciEubmF0aXZlRWxlbWVudDtcbiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fcG9pbnRlckRvd24sIGFjdGl2ZUV2ZW50T3B0aW9ucyk7XG4gICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLl9wb2ludGVyRG93biwgYWN0aXZlRXZlbnRPcHRpb25zKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX3JlbW92ZVJlc2l6YWJsZUFyZWEoKSB7XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuX3Jlc2l6ZXI/Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIHRoaXMuX2xhc3RQb2ludGVyRXZlbnQgPSBudWxsO1xuICAgICAgdGhpcy5fcmVtb3ZlR2xvYmFsRXZlbnRzKCk7XG4gICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuX3BvaW50ZXJEb3duLCBhY3RpdmVFdmVudE9wdGlvbnMpO1xuICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5fcG9pbnRlckRvd24sIGFjdGl2ZUV2ZW50T3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfcG9pbnRlckRvd24gPSAoZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSA9PiB7XG4gICAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgaWYgdGhlXG4gICAgLy8gdXNlciBpcyB1c2luZyBhbnl0aGluZyBvdGhlciB0aGFuIHRoZSBtYWluIG1vdXNlIGJ1dHRvbi5cbiAgICBpZiAodGhpcy5faXNTbGlkaW5nIHx8ICghaXNUb3VjaEV2ZW50KGV2ZW50KSAmJiBldmVudC5idXR0b24gIT09IDApKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIHRoaXMuX25nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgdGhpcy5faXNTbGlkaW5nID0gdHJ1ZTtcbiAgICAgIHRoaXMuX2xhc3RQb2ludGVyRXZlbnQgPSBldmVudDtcbiAgICAgIHRoaXMuX3N0YXJ0UG9pbnRlckV2ZW50ID0gZ2V0R2VzdHVyZVBvaW50RnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgIHRoaXMuX3N0YXJ0QXJlYVJlY3QgPSB0aGlzLl9jcm9wcGVyLl9hcmVhQ3JvcHBlclJlY3QoKTtcbiAgICAgIHRoaXMuX3N0YXJ0SW1nUmVjdCA9IHRoaXMuX2Nyb3BwZXIuX2NhbnZhc1JlY3QoKTtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLl9iaW5kR2xvYmFsRXZlbnRzKGV2ZW50KTtcbiAgICB9KTtcblxuICB9XG5cbiAgcHJpdmF0ZSBfcG9pbnRlck1vdmUgPSAoZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KSA9PiB7XG4gICAgaWYgKHRoaXMuX2lzU2xpZGluZykge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHRoaXMuX2xhc3RQb2ludGVyRXZlbnQgPSBldmVudDtcbiAgICAgIGNvbnN0IGVsZW1lbnQ6IEhUTUxEaXZFbGVtZW50ID0gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0LCBtaW5XaWR0aCwgbWluSGVpZ2h0IH0gPSB0aGlzLl9jcm9wcGVyLmNvbmZpZztcbiAgICAgIGNvbnN0IHBvaW50ID0gZ2V0R2VzdHVyZVBvaW50RnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgIGNvbnN0IGRlbHRhWCA9IHBvaW50LnggLSB0aGlzLl9zdGFydFBvaW50ZXJFdmVudCEueDtcbiAgICAgIGNvbnN0IGRlbHRhWSA9IHBvaW50LnkgLSB0aGlzLl9zdGFydFBvaW50ZXJFdmVudCEueTtcbiAgICAgIGNvbnN0IHN0YXJ0QXJlYVJlY3QgPSB0aGlzLl9zdGFydEFyZWFSZWN0O1xuICAgICAgY29uc3Qgc3RhcnRJbWdSZWN0ID0gdGhpcy5fc3RhcnRJbWdSZWN0O1xuICAgICAgY29uc3Qgcm91bmQgPSB0aGlzLnJvdW5kO1xuICAgICAgY29uc3Qga2VlcEFzcGVjdFJhdGlvID0gdGhpcy5fY3JvcHBlci5jb25maWcua2VlcEFzcGVjdFJhdGlvIHx8IGV2ZW50LnNoaWZ0S2V5O1xuICAgICAgbGV0IG5ld1dpZHRoID0gMDtcbiAgICAgIGxldCBuZXdIZWlnaHQgPSAwO1xuICAgICAgY29uc3Qgcm9vdFJlY3QgPSB0aGlzLl9jcm9wcGVyLl9yb290UmVjdCgpO1xuXG4gICAgICBpZiAocm91bmQpIHtcbiAgICAgICAgLy8gVGhlIGRpc3RhbmNlIGZyb20gdGhlIGNlbnRlciBvZiB0aGUgY3JvcHBlciBhcmVhIHRvIHRoZSBwb2ludGVyXG4gICAgICAgIGNvbnN0IG9yaWdpblggPSAoKHdpZHRoIC8gMiAvIE1hdGguc3FydCgyKSkgKyBkZWx0YVgpO1xuICAgICAgICBjb25zdCBvcmlnaW5ZID0gKChoZWlnaHQgLyAyIC8gTWF0aC5zcXJ0KDIpKSArIGRlbHRhWSk7XG5cbiAgICAgICAgLy8gTGVnXG4gICAgICAgIGNvbnN0IHNpZGUgPSBNYXRoLnNxcnQob3JpZ2luWCAqKiAyICsgb3JpZ2luWSAqKiAyKTtcbiAgICAgICAgbmV3V2lkdGggPSBuZXdIZWlnaHQgPSBzaWRlICogMjtcblxuICAgICAgfSBlbHNlIGlmIChrZWVwQXNwZWN0UmF0aW8pIHtcbiAgICAgICAgbmV3V2lkdGggPSB3aWR0aCArIGRlbHRhWCAqIDI7XG4gICAgICAgIG5ld0hlaWdodCA9IGhlaWdodCArIGRlbHRhWSAqIDI7XG4gICAgICAgIGlmICh3aWR0aCAhPT0gaGVpZ2h0KSB7XG4gICAgICAgICAgaWYgKHdpZHRoID4gaGVpZ2h0KSB7XG4gICAgICAgICAgICBuZXdIZWlnaHQgPSBoZWlnaHQgLyAod2lkdGggLyBuZXdXaWR0aCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChoZWlnaHQgPiB3aWR0aCkge1xuICAgICAgICAgICAgbmV3V2lkdGggPSB3aWR0aCAvIChoZWlnaHQgLyBuZXdIZWlnaHQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXdXaWR0aCA9IG5ld0hlaWdodCA9IE1hdGgubWF4KG5ld1dpZHRoLCBuZXdIZWlnaHQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdXaWR0aCA9IHdpZHRoICsgZGVsdGFYICogMjtcbiAgICAgICAgbmV3SGVpZ2h0ID0gaGVpZ2h0ICsgZGVsdGFZICogMjtcbiAgICAgIH1cblxuICAgICAgLy8gVG8gbWluIHdpZHRoXG4gICAgICBpZiAobmV3V2lkdGggPCBtaW5XaWR0aCEpIHtcbiAgICAgICAgbmV3V2lkdGggPSBtaW5XaWR0aCE7XG4gICAgICB9XG4gICAgICAvLyBUbyBtaW4gaGVpZ2h0XG4gICAgICBpZiAobmV3SGVpZ2h0IDwgbWluSGVpZ2h0ISkge1xuICAgICAgICBuZXdIZWlnaHQgPSBtaW5IZWlnaHQhO1xuICAgICAgfVxuXG4gICAgICAvLyBEbyBub3Qgb3ZlcmZsb3cgdGhlIGNyb3BwZXIgYXJlYVxuICAgICAgY29uc3QgY2VudGVyWCA9IHN0YXJ0QXJlYVJlY3QueCArIHN0YXJ0QXJlYVJlY3Qud2lkdGggLyAyO1xuICAgICAgY29uc3QgY2VudGVyWSA9IHN0YXJ0QXJlYVJlY3QueSArIHN0YXJ0QXJlYVJlY3QuaGVpZ2h0IC8gMjtcbiAgICAgIGNvbnN0IHRvcE92ZXJmbG93ID0gc3RhcnRJbWdSZWN0LnkgPiBjZW50ZXJZIC0gKG5ld0hlaWdodCAvIDIpO1xuICAgICAgY29uc3QgYm90dG9tT3ZlcmZsb3cgPSBjZW50ZXJZICsgKG5ld0hlaWdodCAvIDIpID4gc3RhcnRJbWdSZWN0LmJvdHRvbTtcbiAgICAgIGNvbnN0IG1pbkhlaWdodE9uT3ZlcmZsb3cgPSBNYXRoLm1pbigoY2VudGVyWSAtIHN0YXJ0SW1nUmVjdC55KSAqIDIsIChzdGFydEltZ1JlY3QuYm90dG9tIC0gY2VudGVyWSkgKiAyKTtcbiAgICAgIGNvbnN0IGxlZnRPdmVyZmxvdyA9IHN0YXJ0SW1nUmVjdC54ID4gY2VudGVyWCAtIChuZXdXaWR0aCAvIDIpO1xuICAgICAgY29uc3QgcmlnaHRPdmVyZmxvdyA9IGNlbnRlclggKyAobmV3V2lkdGggLyAyKSA+IHN0YXJ0SW1nUmVjdC5yaWdodDtcbiAgICAgIGNvbnN0IG1pbldpZHRoT25PdmVyZmxvdyA9IE1hdGgubWluKChjZW50ZXJYIC0gc3RhcnRJbWdSZWN0LngpICogMiwgKHN0YXJ0SW1nUmVjdC5yaWdodCAtIGNlbnRlclgpICogMik7XG4gICAgICBjb25zdCBtaW5Pbk92ZXJmbG93ID0gTWF0aC5taW4obWluV2lkdGhPbk92ZXJmbG93LCBtaW5IZWlnaHRPbk92ZXJmbG93KTtcbiAgICAgIGlmIChyb3VuZCkge1xuICAgICAgICBpZiAodG9wT3ZlcmZsb3cgfHwgYm90dG9tT3ZlcmZsb3cgfHwgbGVmdE92ZXJmbG93IHx8IHJpZ2h0T3ZlcmZsb3cpIHtcbiAgICAgICAgICBuZXdIZWlnaHQgPSBuZXdXaWR0aCA9IG1pbk9uT3ZlcmZsb3c7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoa2VlcEFzcGVjdFJhdGlvKSB7XG4gICAgICAgIGNvbnN0IG5ld05ld1dpZHRoOiBudW1iZXJbXSA9IFtdO1xuICAgICAgICBjb25zdCBuZXdOZXdIZWlnaHQ6IG51bWJlcltdID0gW107XG4gICAgICAgIGlmICgodG9wT3ZlcmZsb3cgfHwgYm90dG9tT3ZlcmZsb3cpICYmIE1hdGgubWluKCkpIHtcbiAgICAgICAgICBuZXdIZWlnaHQgPSBtaW5IZWlnaHRPbk92ZXJmbG93O1xuICAgICAgICAgIG5ld05ld0hlaWdodC5wdXNoKG5ld0hlaWdodCk7XG4gICAgICAgICAgbmV3V2lkdGggPSB3aWR0aCAvIChoZWlnaHQgLyBtaW5IZWlnaHRPbk92ZXJmbG93KTtcbiAgICAgICAgICBuZXdOZXdXaWR0aC5wdXNoKG5ld1dpZHRoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoKGxlZnRPdmVyZmxvdyB8fCByaWdodE92ZXJmbG93KSkge1xuICAgICAgICAgIG5ld1dpZHRoID0gbWluV2lkdGhPbk92ZXJmbG93O1xuICAgICAgICAgIG5ld05ld1dpZHRoLnB1c2gobmV3V2lkdGgpO1xuICAgICAgICAgIG5ld0hlaWdodCA9IGhlaWdodCAvICh3aWR0aCAvIG1pbldpZHRoT25PdmVyZmxvdyk7XG4gICAgICAgICAgbmV3TmV3SGVpZ2h0LnB1c2gobmV3SGVpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobmV3TmV3V2lkdGgubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgbmV3V2lkdGggPSBNYXRoLm1pbiguLi5uZXdOZXdXaWR0aCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5ld05ld0hlaWdodC5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICBuZXdIZWlnaHQgPSBNYXRoLm1pbiguLi5uZXdOZXdIZWlnaHQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodG9wT3ZlcmZsb3cgfHwgYm90dG9tT3ZlcmZsb3cpIHtcbiAgICAgICAgICBuZXdIZWlnaHQgPSBtaW5IZWlnaHRPbk92ZXJmbG93O1xuICAgICAgICB9XG4gICAgICAgIGlmIChsZWZ0T3ZlcmZsb3cgfHwgcmlnaHRPdmVyZmxvdykge1xuICAgICAgICAgIG5ld1dpZHRoID0gbWluV2lkdGhPbk92ZXJmbG93O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIERvIG5vdCBvdmVyZmxvdyB0aGUgY29udGFpbmVyXG4gICAgICBpZiAocm91bmQpIHtcbiAgICAgICAgY29uc3QgbWluID0gTWF0aC5taW4ocm9vdFJlY3Qud2lkdGgsIHJvb3RSZWN0LmhlaWdodCk7XG4gICAgICAgIGlmIChuZXdXaWR0aCA+IG1pbikge1xuICAgICAgICAgIG5ld1dpZHRoID0gbmV3SGVpZ2h0ID0gbWluO1xuICAgICAgICB9IGVsc2UgaWYgKG5ld0hlaWdodCA+IG1pbikge1xuICAgICAgICAgIG5ld1dpZHRoID0gbmV3SGVpZ2h0ID0gbWluO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGtlZXBBc3BlY3RSYXRpbykge1xuICAgICAgICBpZiAobmV3V2lkdGggPiByb290UmVjdC53aWR0aCkge1xuICAgICAgICAgIG5ld1dpZHRoID0gcm9vdFJlY3Qud2lkdGg7XG4gICAgICAgICAgbmV3SGVpZ2h0ID0gaGVpZ2h0IC8gKHdpZHRoIC8gcm9vdFJlY3Qud2lkdGgpO1xuICAgICAgICB9IGVsc2UgaWYgKG5ld0hlaWdodCA+IHJvb3RSZWN0LmhlaWdodCkge1xuICAgICAgICAgIG5ld1dpZHRoID0gd2lkdGggLyAoaGVpZ2h0IC8gcm9vdFJlY3QuaGVpZ2h0KTtcbiAgICAgICAgICBuZXdIZWlnaHQgPSByb290UmVjdC5oZWlnaHQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChuZXdXaWR0aCA+IHJvb3RSZWN0LndpZHRoKSB7XG4gICAgICAgICAgbmV3V2lkdGggPSByb290UmVjdC53aWR0aDtcbiAgICAgICAgfSBlbHNlIGlmIChuZXdIZWlnaHQgPiByb290UmVjdC5oZWlnaHQpIHtcbiAgICAgICAgICBuZXdIZWlnaHQgPSByb290UmVjdC5oZWlnaHQ7XG4gICAgICAgIH1cbiAgICAgIH1cblxuXG4gICAgICAvLyByb3VuZCB2YWx1ZXNcbiAgICAgIG5ld1dpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7XG4gICAgICBuZXdIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7XG5cbiAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSBgJHtuZXdXaWR0aH1weGA7XG4gICAgICBlbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke25ld0hlaWdodH1weGA7XG4gICAgICB0aGlzLl9jdXJyZW50V2lkdGggPSBuZXdXaWR0aDtcbiAgICAgIHRoaXMuX2N1cnJlbnRIZWlnaHQgPSBuZXdIZWlnaHQ7XG4gICAgfVxuICB9XG5cbiAgLyoqIENhbGxlZCB3aGVuIHRoZSB1c2VyIGhhcyBsaWZ0ZWQgdGhlaXIgcG9pbnRlci4gKi9cbiAgcHJpdmF0ZSBfcG9pbnRlclVwID0gKGV2ZW50OiBUb3VjaEV2ZW50IHwgTW91c2VFdmVudCkgPT4ge1xuICAgIGlmICh0aGlzLl9pc1NsaWRpbmcpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLl9yZW1vdmVHbG9iYWxFdmVudHMoKTtcbiAgICAgIHRoaXMuX2Nyb3BwZXIuX3ByaW1hcnlBcmVhV2lkdGggPSB0aGlzLl9jcm9wcGVyLmNvbmZpZy53aWR0aCA9IHRoaXMuX2N1cnJlbnRXaWR0aDtcbiAgICAgIHRoaXMuX2Nyb3BwZXIuX3ByaW1hcnlBcmVhSGVpZ2h0ID0gdGhpcy5fY3JvcHBlci5jb25maWcuaGVpZ2h0ID0gdGhpcy5fY3VycmVudEhlaWdodDtcbiAgICAgIHRoaXMuX2Nyb3BwZXIuY29uZmlnID0gdGhpcy5fY3JvcHBlci5jb25maWc7XG4gICAgICB0aGlzLl9jcm9wcGVyLl91cGRhdGVNaW5TY2FsZSgpO1xuICAgICAgdGhpcy5faXNTbGlkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLl9zdGFydFBvaW50ZXJFdmVudCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqIENhbGxlZCB3aGVuIHRoZSB3aW5kb3cgaGFzIGxvc3QgZm9jdXMuICovXG4gIHByaXZhdGUgX3dpbmRvd0JsdXIgPSAoKSA9PiB7XG4gICAgLy8gSWYgdGhlIHdpbmRvdyBpcyBibHVycmVkIHdoaWxlIGRyYWdnaW5nIHdlIG5lZWQgdG8gc3RvcCBkcmFnZ2luZyBiZWNhdXNlIHRoZVxuICAgIC8vIGJyb3dzZXIgd29uJ3QgZGlzcGF0Y2ggdGhlIGBtb3VzZXVwYCBhbmQgYHRvdWNoZW5kYCBldmVudHMgYW55bW9yZS5cbiAgICBpZiAodGhpcy5fbGFzdFBvaW50ZXJFdmVudCkge1xuICAgICAgdGhpcy5fcG9pbnRlclVwKHRoaXMuX2xhc3RQb2ludGVyRXZlbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2JpbmRHbG9iYWxFdmVudHModHJpZ2dlckV2ZW50OiBUb3VjaEV2ZW50IHwgTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLl9kb2N1bWVudDtcbiAgICBjb25zdCBpc1RvdWNoID0gaXNUb3VjaEV2ZW50KHRyaWdnZXJFdmVudCk7XG4gICAgY29uc3QgbW92ZUV2ZW50TmFtZSA9IGlzVG91Y2ggPyAndG91Y2htb3ZlJyA6ICdtb3VzZW1vdmUnO1xuICAgIGNvbnN0IGVuZEV2ZW50TmFtZSA9IGlzVG91Y2ggPyAndG91Y2hlbmQnIDogJ21vdXNldXAnO1xuICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihtb3ZlRXZlbnROYW1lLCB0aGlzLl9wb2ludGVyTW92ZSwgYWN0aXZlRXZlbnRPcHRpb25zKTtcbiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZW5kRXZlbnROYW1lLCB0aGlzLl9wb2ludGVyVXAsIGFjdGl2ZUV2ZW50T3B0aW9ucyk7XG5cbiAgICBpZiAoaXNUb3VjaCkge1xuICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRoaXMuX3BvaW50ZXJVcCwgYWN0aXZlRXZlbnRPcHRpb25zKTtcbiAgICB9XG5cbiAgICBjb25zdCB3aW5kb3cgPSB0aGlzLl9nZXRXaW5kb3coKTtcblxuICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cpIHtcbiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdibHVyJywgdGhpcy5fd2luZG93Qmx1cik7XG4gICAgfVxuICB9XG5cbiAgLyoqIFJlbW92ZXMgYW55IGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgdGhhdCB3ZSBtYXkgaGF2ZSBhZGRlZC4gKi9cbiAgcHJpdmF0ZSBfcmVtb3ZlR2xvYmFsRXZlbnRzKCkge1xuICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLl9kb2N1bWVudDtcbiAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX3BvaW50ZXJNb3ZlLCBhY3RpdmVFdmVudE9wdGlvbnMpO1xuICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuX3BvaW50ZXJVcCwgYWN0aXZlRXZlbnRPcHRpb25zKTtcbiAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX3BvaW50ZXJNb3ZlLCBhY3RpdmVFdmVudE9wdGlvbnMpO1xuICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLl9wb2ludGVyVXAsIGFjdGl2ZUV2ZW50T3B0aW9ucyk7XG4gICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRoaXMuX3BvaW50ZXJVcCwgYWN0aXZlRXZlbnRPcHRpb25zKTtcblxuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMuX2dldFdpbmRvdygpO1xuXG4gICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdykge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2JsdXInLCB0aGlzLl93aW5kb3dCbHVyKTtcbiAgICB9XG4gIH1cblxuICAvKiogVXNlIGRlZmF1bHRWaWV3IG9mIGluamVjdGVkIGRvY3VtZW50IGlmIGF2YWlsYWJsZSBvciBmYWxsYmFjayB0byBnbG9iYWwgd2luZG93IHJlZmVyZW5jZSAqL1xuICBwcml2YXRlIF9nZXRXaW5kb3coKTogV2luZG93IHtcbiAgICByZXR1cm4gdGhpcy5fZG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93O1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEdlc3R1cmVQb2ludEZyb21FdmVudChldmVudDogVG91Y2hFdmVudCB8IE1vdXNlRXZlbnQpIHtcblxuICAvLyBgdG91Y2hlc2Agd2lsbCBiZSBlbXB0eSBmb3Igc3RhcnQvZW5kIGV2ZW50cyBzbyB3ZSBoYXZlIHRvIGZhbGwgYmFjayB0byBgY2hhbmdlZFRvdWNoZXNgLlxuICBjb25zdCBwb2ludCA9IGlzVG91Y2hFdmVudChldmVudClcbiAgICA/IChldmVudC50b3VjaGVzWzBdIHx8IGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKVxuICAgIDogZXZlbnQ7XG5cbiAgcmV0dXJuIHtcbiAgICB4OiBwb2ludC5jbGllbnRYLFxuICAgIHk6IHBvaW50LmNsaWVudFlcbiAgfTtcbn1cblxuLyoqIFJldHVybnMgd2hldGhlciBhbiBldmVudCBpcyBhIHRvdWNoIGV2ZW50LiAqL1xuZnVuY3Rpb24gaXNUb3VjaEV2ZW50KGV2ZW50OiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCk6IGV2ZW50IGlzIFRvdWNoRXZlbnQge1xuICByZXR1cm4gZXZlbnQudHlwZVswXSA9PT0gJ3QnO1xufVxuIl19