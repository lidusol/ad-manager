import { Color } from '@alyle/ui/color';
import { shadowBuilder } from '../shadow';
import { getNativeElement } from '../minimal/common';
const DEFAULT_VALUE = '';
const STYLE_PRIORITY = -1;
export function mixinStyleUpdater(base) {
    return class extends base {
        constructor(...args) { super(...args); }
        setAutoContrast() {
            this._autoContrast = true;
        }
        updateStyle(element) {
            const __bg = this._superHyperInternalPropertyBg;
            const __color = this._superHyperInternalPropertyColor === 'auto'
                ? ''
                : this._superHyperInternalPropertyColor;
            const __raised = this._superHyperInternalPropertyRaised;
            const __elevation = this._superHyperInternalPropertyElevation;
            const __disabled = this._superHyperInternalPropertyDisabled;
            const __outlined = this._superHyperInternalPropertyOutlined;
            const __shadowColor = this._superHyperInternalPropertyShadowColor;
            const __isContrast = this._autoContrast || this._superHyperInternalPropertyColor === 'auto';
            const el = getNativeElement(element);
            const newKey = `c--${__bg || DEFAULT_VALUE}_${__color || DEFAULT_VALUE}_${__raised || DEFAULT_VALUE}_${__elevation || DEFAULT_VALUE}_${__disabled || DEFAULT_VALUE}_${__outlined || DEFAULT_VALUE}_${__shadowColor || DEFAULT_VALUE}_${__isContrast || DEFAULT_VALUE}`;
            const newClass = this._theme.renderStyle(newKey, (theme) => {
                let sColor;
                let sBackground;
                let sBorder;
                let sPointerEvents;
                let sBoxShadow;
                let sBoxShadowActive;
                if (__outlined) {
                    sBorder = '1px solid currentColor';
                }
                if (__disabled) {
                    sColor = theme.disabled.contrast;
                    sPointerEvents = 'none';
                    if (__bg || __raised) {
                        sBackground = theme.disabled.default;
                    }
                }
                else {
                    if (__bg) {
                        sBackground = colorOf(theme, __bg);
                        if (__isContrast && !__color) {
                            sColor = theme.colorOf(`${__bg}:contrast`);
                            // Generate auto contrast if is necessary
                            if (sColor.css().includes('invalid')) {
                                const lum = (__bg instanceof Color ? __bg : theme.colorOf(__bg)).luminance();
                                sColor = lum < 0.5 ? theme.text.light : theme.text.dark;
                            }
                        }
                    }
                    if (!sColor && __color) {
                        sColor = colorOf(theme, __color);
                    }
                    if (__raised || (__elevation != null)) {
                        if (!__bg) {
                            sBackground = theme.background.primary.default;
                        }
                        const backgroundColorCss = sBackground !== __bg && colorOf(theme, __bg || 'background:primary', 'shadow');
                        const shadowColor = (__shadowColor && colorOf(theme, __shadowColor)) || backgroundColorCss || sBackground || sColor || theme.shadow;
                        if (__elevation != null) {
                            sBoxShadow = shadowBuilder(__elevation, shadowColor);
                        }
                        else {
                            sBoxShadow = shadowBuilder(3, shadowColor);
                            sBoxShadowActive = shadowBuilder(8, shadowColor);
                        }
                    }
                }
                return (className) => `${className}{${sColor ? 'color:' + sColor : ''};${sBackground ? 'background:' + sBackground : ''};${sBorder ? 'border:' + sBorder : ''};${sPointerEvents ? 'pointer-events:' + sPointerEvents : ''};${sBoxShadow ? 'box-shadow:' + sBoxShadow : ''};}${className}:active{${sBoxShadowActive ? 'box-shadow:' + sBoxShadowActive : ''};}`;
            }, STYLE_PRIORITY);
            el.classList.remove(this._classNameAnonymous);
            el.classList.add(newClass);
            this._classNameAnonymous = newClass;
        }
    };
}
function colorOf(theme, color, optional) {
    return color instanceof Color ? color : theme.colorOf(color, optional);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtY29tbW9uLWJlaGF2aW9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYi9zcmMvY29tbW9uL2J1aWxkLWNvbW1vbi1iZWhhdmlvcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXhDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFVMUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFLckQsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLE1BQU0sY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBYTFCLE1BQU0sVUFBVSxpQkFBaUIsQ0FBZ0MsSUFBTztJQUN0RSxPQUFPLEtBQU0sU0FBUSxJQUFJO1FBbUZ2QixZQUFZLEdBQUcsSUFBVyxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQWhGL0MsZUFBZTtZQUNiLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1FBQzVCLENBQUM7UUFDRCxXQUFXLENBQUMsT0FBc0M7WUFDaEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixDQUFDO1lBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQ0FBZ0MsS0FBSyxNQUFNO2dCQUM5RCxDQUFDLENBQUMsRUFBRTtnQkFDSixDQUFDLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxDQUFDO1lBQzFDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQztZQUN4RCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsb0NBQW9DLENBQUM7WUFDOUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLG1DQUFtQyxDQUFDO1lBQzVELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQztZQUM1RCxNQUFNLGFBQWEsR0FB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QUUsUUFBaUI7SUFDdkYsT0FBTyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3pFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb2xvciB9IGZyb20gJ0BhbHlsZS91aS9jb2xvcic7XG5pbXBvcnQgeyBDb25zdHJ1Y3RvciB9IGZyb20gJy4vY29uc3RydWN0b3InO1xuaW1wb3J0IHsgc2hhZG93QnVpbGRlciB9IGZyb20gJy4uL3NoYWRvdyc7XG5pbXBvcnQgeyBDYW5Db2xvciB9IGZyb20gJy4vY29sb3InO1xuaW1wb3J0IHsgQ2FuQmcgfSBmcm9tICcuL2JnJztcbmltcG9ydCB7IENhbkRpc2FibGUgfSBmcm9tICcuL2Rpc2FibGVkJztcbmltcG9ydCB7IENhblJhaXNlZCB9IGZyb20gJy4vcmFpc2VkJztcbmltcG9ydCB7IENhbkVsZXZhdGlvbiB9IGZyb20gJy4vZWxldmF0aW9uJztcbmltcG9ydCB7IENhbk91dGxpbmVkIH0gZnJvbSAnLi9vdXRsaW5lZCc7XG5pbXBvcnQgeyBDYW5TaGFkb3dDb2xvciB9IGZyb20gJy4vc2hhZG93LWNvbG9yJztcbmltcG9ydCB7IEx5VGhlbWUyIH0gZnJvbSAnLi4vdGhlbWUvdGhlbWUyLnNlcnZpY2UnO1xuaW1wb3J0IHsgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZ2V0TmF0aXZlRWxlbWVudCB9IGZyb20gJy4uL21pbmltYWwvY29tbW9uJztcbmltcG9ydCB7IFRoZW1lVmFyaWFibGVzIH0gZnJvbSAnLi4vdGhlbWUvdGhlbWUtY29uZmlnJztcbmltcG9ydCB7XG4gICB9IGZyb20gJy4uL3BhcnNlJztcblxuY29uc3QgREVGQVVMVF9WQUxVRSA9ICcnO1xuY29uc3QgU1RZTEVfUFJJT1JJVFkgPSAtMTtcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1aXJlUGFyYW1zU3R5bGVVcGRhdGVyIHtcbiAgX3RoZW1lOiBMeVRoZW1lMjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYW5TdHlsZVVwZGF0ZXIge1xuICBfdGhlbWU6IEx5VGhlbWUyO1xuICB1cGRhdGVTdHlsZTogKGVsZW1lbnQ6IEVsZW1lbnRSZWYgfCBFbGVtZW50KSA9PiB2b2lkO1xuICBzZXRBdXRvQ29udHJhc3Q6ICgpID0+IHZvaWQ7XG59XG5leHBvcnQgdHlwZSBDYW5TdHlsZVVwZGF0ZXJDdG9yID0gQ29uc3RydWN0b3I8UmVxdWlyZVBhcmFtc1N0eWxlVXBkYXRlciAmIFBhcnRpYWw8Q2FuQ29sb3IgJiBDYW5CZyAmIENhbkRpc2FibGUgJiBDYW5SYWlzZWQgJiBDYW5FbGV2YXRpb24gJiBDYW5PdXRsaW5lZCAmIENhblNoYWRvd0NvbG9yPj47XG5cbmV4cG9ydCBmdW5jdGlvbiBtaXhpblN0eWxlVXBkYXRlcjxUIGV4dGVuZHMgQ2FuU3R5bGVVcGRhdGVyQ3Rvcj4oYmFzZTogVCk6IENvbnN0cnVjdG9yPENhblN0eWxlVXBkYXRlcj4gJiBUIHtcbiAgcmV0dXJuIGNsYXNzIGV4dGVuZHMgYmFzZSB7XG4gICAgX2NsYXNzTmFtZUFub255bW91czogc3RyaW5nO1xuICAgIF9hdXRvQ29udHJhc3Q6IGJvb2xlYW47XG4gICAgc2V0QXV0b0NvbnRyYXN0KCkge1xuICAgICAgdGhpcy5fYXV0b0NvbnRyYXN0ID0gdHJ1ZTtcbiAgICB9XG4gICAgdXBkYXRlU3R5bGUoZWxlbWVudDogRWxlbWVudFJlZjxhbnk+IHwgSFRNTEVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IF9fYmcgPSB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eUJnO1xuICAgICAgY29uc3QgX19jb2xvciA9IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5Q29sb3IgPT09ICdhdXRvJ1xuICAgICAgICA/ICcnXG4gICAgICAgIDogdGhpcy5fc3VwZXJIeXBlckludGVybmFsUHJvcGVydHlDb2xvcjtcbiAgICAgIGNvbnN0IF9fcmFpc2VkID0gdGhpcy5fc3VwZXJIeXBlckludGVybmFsUHJvcGVydHlSYWlzZWQ7XG4gICAgICBjb25zdCBfX2VsZXZhdGlvbiA9IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5RWxldmF0aW9uO1xuICAgICAgY29uc3QgX19kaXNhYmxlZCA9IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5RGlzYWJsZWQ7XG4gICAgICBjb25zdCBfX291dGxpbmVkID0gdGhpcy5fc3VwZXJIeXBlckludGVybmFsUHJvcGVydHlPdXRsaW5lZDtcbiAgICAgIGNvbnN0IF9fc2hhZG93Q29sb3IgPSB0aGlzLl9zdXBlckh5cGVySW50ZXJuYWxQcm9wZXJ0eVNoYWRvd0NvbG9yO1xuICAgICAgY29uc3QgX19pc0NvbnRyYXN0ID0gdGhpcy5fYXV0b0NvbnRyYXN0IHx8IHRoaXMuX3N1cGVySHlwZXJJbnRlcm5hbFByb3BlcnR5Q29sb3IgPT09ICdhdXRvJztcbiAgICAgIGNvbnN0IGVsID0gZ2V0TmF0aXZlRWxlbWVudChlbGVtZW50KTtcblxuICAgICAgY29uc3QgbmV3S2V5ID0gYGMtLSR7XG4gICAgICAgIF9fYmcgfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICBfX2NvbG9yIHx8IERFRkFVTFRfVkFMVUV9XyR7XG4gICAgICAgICAgICBfX3JhaXNlZCB8fCBERUZBVUxUX1ZBTFVFfV8ke1xuICAgICAgICAgICAgICBfX2VsZXZhdGlvbiB8fCBERUZBVUxUX1ZBTFVFfV8ke1xuICAgICAgICAgICAgICAgIF9fZGlzYWJsZWQgfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICAgICAgICAgIF9fb3V0bGluZWQgfHwgREVGQVVMVF9WQUxVRX1fJHtcbiAgICAgICAgICAgICAgICAgICAgX19zaGFkb3dDb2xvciB8fCBERUZBVUxUX1ZBTFVFfV8ke1xuICAgICAgICAgICAgICAgICAgICAgIF9faXNDb250cmFzdCB8fCBERUZBVUxUX1ZBTFVFfWA7XG4gICAgICBjb25zdCBuZXdDbGFzcyA9IHRoaXMuX3RoZW1lLnJlbmRlclN0eWxlKG5ld0tleSwgKHRoZW1lOiBUaGVtZVZhcmlhYmxlcykgPT4ge1xuICAgICAgICBsZXQgc0NvbG9yOiBDb2xvciB8IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHNCYWNrZ3JvdW5kOiBDb2xvciB8IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHNCb3JkZXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHNQb2ludGVyRXZlbnRzOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzQm94U2hhZG93OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICAgIGxldCBzQm94U2hhZG93QWN0aXZlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAgICAgaWYgKF9fb3V0bGluZWQpIHtcbiAgICAgICAgICBzQm9yZGVyID0gJzFweCBzb2xpZCBjdXJyZW50Q29sb3InO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfX2Rpc2FibGVkKSB7XG4gICAgICAgICAgc0NvbG9yID0gdGhlbWUuZGlzYWJsZWQuY29udHJhc3Q7XG4gICAgICAgICAgc1BvaW50ZXJFdmVudHMgPSAnbm9uZSc7XG4gICAgICAgICAgaWYgKF9fYmcgfHwgX19yYWlzZWQpIHtcbiAgICAgICAgICAgIHNCYWNrZ3JvdW5kID0gdGhlbWUuZGlzYWJsZWQuZGVmYXVsdDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKF9fYmcpIHtcbiAgICAgICAgICAgIHNCYWNrZ3JvdW5kID0gY29sb3JPZih0aGVtZSwgX19iZyk7XG4gICAgICAgICAgICBpZiAoX19pc0NvbnRyYXN0ICYmICFfX2NvbG9yKSB7XG4gICAgICAgICAgICAgIHNDb2xvciA9IHRoZW1lLmNvbG9yT2YoYCR7X19iZ306Y29udHJhc3RgKTtcblxuICAgICAgICAgICAgICAvLyBHZW5lcmF0ZSBhdXRvIGNvbnRyYXN0IGlmIGlzIG5lY2Vzc2FyeVxuICAgICAgICAgICAgICBpZiAoc0NvbG9yLmNzcygpLmluY2x1ZGVzKCdpbnZhbGlkJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsdW0gPSAoX19iZyBpbnN0YW5jZW9mIENvbG9yID8gX19iZyA6IHRoZW1lLmNvbG9yT2YoX19iZykpLmx1bWluYW5jZSgpO1xuICAgICAgICAgICAgICAgIHNDb2xvciA9IGx1bSA8IDAuNSA/IHRoZW1lLnRleHQubGlnaHQgOiB0aGVtZS50ZXh0LmRhcms7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFzQ29sb3IgJiYgX19jb2xvcikge1xuICAgICAgICAgICAgc0NvbG9yID0gY29sb3JPZih0aGVtZSwgX19jb2xvcik7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChfX3JhaXNlZCB8fCAoX19lbGV2YXRpb24gIT0gbnVsbCkpIHtcbiAgICAgICAgICAgIGlmICghX19iZykge1xuICAgICAgICAgICAgICBzQmFja2dyb3VuZCA9IHRoZW1lLmJhY2tncm91bmQucHJpbWFyeS5kZWZhdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgYmFja2dyb3VuZENvbG9yQ3NzID0gc0JhY2tncm91bmQgIT09IF9fYmcgJiYgY29sb3JPZih0aGVtZSwgX19iZyB8fCAnYmFja2dyb3VuZDpwcmltYXJ5JywgJ3NoYWRvdycpO1xuICAgICAgICAgICAgY29uc3Qgc2hhZG93Q29sb3IgPSAoX19zaGFkb3dDb2xvciAmJiBjb2xvck9mKHRoZW1lLCBfX3NoYWRvd0NvbG9yKSkgfHwgYmFja2dyb3VuZENvbG9yQ3NzIHx8IHNCYWNrZ3JvdW5kIHx8IHNDb2xvciB8fCB0aGVtZS5zaGFkb3c7XG4gICAgICAgICAgICBpZiAoX19lbGV2YXRpb24gIT0gbnVsbCkge1xuICAgICAgICAgICAgICBzQm94U2hhZG93ID0gc2hhZG93QnVpbGRlcihfX2VsZXZhdGlvbiwgc2hhZG93Q29sb3IpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc0JveFNoYWRvdyA9IHNoYWRvd0J1aWxkZXIoMywgc2hhZG93Q29sb3IpO1xuICAgICAgICAgICAgICBzQm94U2hhZG93QWN0aXZlID0gc2hhZG93QnVpbGRlcig4LCBzaGFkb3dDb2xvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiAoY2xhc3NOYW1lOiBzdHJpbmcpID0+IGAke2NsYXNzTmFtZX17JHtzQ29sb3IgPyAnY29sb3I6JyArIHNDb2xvciA6ICcnfTske3NCYWNrZ3JvdW5kID8gJ2JhY2tncm91bmQ6JyArIHNCYWNrZ3JvdW5kIDogJyd9OyR7c0JvcmRlciA/ICdib3JkZXI6JyArIHNCb3JkZXIgOiAnJ307JHtzUG9pbnRlckV2ZW50cyA/ICdwb2ludGVyLWV2ZW50czonICsgc1BvaW50ZXJFdmVudHMgOiAnJ307JHtzQm94U2hhZG93ID8gJ2JveC1zaGFkb3c6JyArIHNCb3hTaGFkb3cgOiAnJ307fSR7Y2xhc3NOYW1lfTphY3RpdmV7JHtzQm94U2hhZG93QWN0aXZlID8gJ2JveC1zaGFkb3c6JyArIHNCb3hTaGFkb3dBY3RpdmUgOiAnJ307fWA7XG4gICAgICB9LCBTVFlMRV9QUklPUklUWSk7XG5cbiAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUodGhpcy5fY2xhc3NOYW1lQW5vbnltb3VzKTtcbiAgICAgIGVsLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MpO1xuICAgICAgdGhpcy5fY2xhc3NOYW1lQW5vbnltb3VzID0gbmV3Q2xhc3M7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoLi4uYXJnczogYW55W10pIHsgc3VwZXIoLi4uYXJncyk7IH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gY29sb3JPZih0aGVtZTogVGhlbWVWYXJpYWJsZXMsIGNvbG9yOiBzdHJpbmcgfCBudW1iZXIgfCBDb2xvciwgb3B0aW9uYWw/OiBzdHJpbmcpIHtcbiAgcmV0dXJuIGNvbG9yIGluc3RhbmNlb2YgQ29sb3IgPyBjb2xvciA6IHRoZW1lLmNvbG9yT2YoY29sb3IsIG9wdGlvbmFsKTtcbn1cbiJdfQ==