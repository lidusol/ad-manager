import { Injectable, ElementRef, Renderer2, Optional } from '@angular/core';
import { LyTheme2 } from '../theme/theme2.service';
import { TypeStyle } from '../theme/style';
import { parseMediaQueriesFromString, parseMediaQueryFromString } from '../style-utils';
import * as ɵngcc0 from '@angular/core';
export class StyleRenderer {
    constructor(_theme, _el, _renderer) {
        this._theme = _theme;
        this._renderer = _renderer;
        this._set = new Set();
        if (_el) {
            this._nEl = _el.nativeElement;
            this._set = new Set();
        }
    }
    /**
     * Build multiple styles and render them in the DOM.
     * @param styles Styles
     * @param applyRootClass If `applyToRoot` is `true` and the root property is defined,
     * it will automatically be added to the component.
     *
     * e.g.
     *
     * ```ts
     * const STYLES = () => ({
     *   root: lyl `{...}`, // this class will be added to the root component
     *   item: lyl `{...}`
     * })
     * ```
     *
     * Also accepts the name of a class.
     *
     * e.g.
     *
     * ```ts
     * renderSheet(STYLES, 'item')
     * ```
     */
    renderSheet(styles, applyRootClass) {
        const classes = this._theme.renderStyleSheet(styles);
        if (applyRootClass === true && classes.root) {
            this.addClass(classes.root);
            return classes;
        }
        if (applyRootClass) {
            const customClass = classes[applyRootClass];
            if (customClass) {
                this.addClass(customClass);
            }
        }
        return classes;
    }
    /**
     * Render style and apply class name to host Component or Directive,
     * require provide `StyleRenderer` in your Component.
     * e.g.
     * @Component({
     *   ...
     *   providers: [ StyleRenderer ]
     * })
     */
    add(id, style, priority, oldClass) {
        const args = arguments;
        /** Class name or keyframe name */
        let className;
        let len = args.length;
        // clean
        if (len === 4 && args[3] == null) {
            len -= 1;
        }
        if (len === 3 && args[2] == null) {
            len -= 1;
        }
        if (len === 1) {
            className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
        }
        else if (len === 2) {
            if (typeof id === 'string') {
                className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
            }
            else if (typeof style === 'number') {
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
            }
            else {
                className = this._theme._createStyleContent2(id, null, null, TypeStyle.LylStyle);
                oldClass = style;
            }
        }
        else if (len === 3) {
            if (typeof id === 'string') {
                if (typeof priority === 'number') {
                    // (id, style, priority)
                    className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
                }
                else {
                    // (id, style, oldClass)
                    className = this._theme._createStyleContent2(style, id, null, TypeStyle.LylStyle);
                    oldClass = priority;
                }
            }
            else {
                // (style, priority, oldClass)
                className = this._theme._createStyleContent2(id, null, style, TypeStyle.LylStyle);
                oldClass = priority;
            }
        }
        else if (len === 4) {
            className = this._theme._createStyleContent2(style, id, priority, TypeStyle.LylStyle);
        }
        if (this._nEl) {
            return this.updateClass(className, oldClass);
        }
        throw new Error(`StyleRenderer is required on the Component!\n`
            + `Add provider for StyleRenderer in Component or Directive:\n\n`
            + `e.g:\n\n`
            + `@Component({\n`
            + `  providers: [ StyleRenderer ]\n`
            + `})\n`);
    }
    /**
     * Only render style and return class name.
     */
    render(styleOrId, priorityOrStyle, priority) {
        if (typeof styleOrId === 'string') {
            return this._theme._createStyleContent2(priorityOrStyle, styleOrId, priority, TypeStyle.LylStyle);
        }
        return this._theme._createStyleContent2(styleOrId, null, priority, TypeStyle.LylStyle);
    }
    addClass(className) {
        if (!this._set.has(className)) {
            this._set.add(className);
            this._renderer.addClass(this._nEl, className);
        }
    }
    removeClass(className) {
        if (className && this._set.has(className)) {
            this._set.delete(className);
            this._renderer.removeClass(this._nEl, className);
        }
    }
    removeClasses(rawClassVal) {
        if (rawClassVal) {
            rawClassVal.forEach(klass => this.removeClass(klass));
        }
    }
    toggleClass(className, enabled) {
        if (enabled) {
            this.addClass(className);
        }
        else {
            this.removeClass(className);
        }
    }
    updateClass(newClassName, oldClassName) {
        this.removeClass(oldClassName);
        this.addClass(newClassName);
        return newClassName;
    }
}
StyleRenderer.ɵfac = function StyleRenderer_Factory(t) { return new (t || StyleRenderer)(ɵngcc0.ɵɵinject(LyTheme2), ɵngcc0.ɵɵinject(ɵngcc0.ElementRef, 8), ɵngcc0.ɵɵinject(ɵngcc0.Renderer2, 8)); };
StyleRenderer.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: StyleRenderer, factory: StyleRenderer.ɵfac });
StyleRenderer.ctorParameters = () => [
    { type: LyTheme2 },
    { type: ElementRef, decorators: [{ type: Optional }] },
    { type: Renderer2, decorators: [{ type: Optional }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(StyleRenderer, [{
        type: Injectable
    }], function () { return [{ type: LyTheme2 }, { type: ɵngcc0.ElementRef, decorators: [{
                type: Optional
            }] }, { type: ɵngcc0.Renderer2, decorators: [{
                type: Optional
            }] }]; }, null); })();
/**
 * Parameter decorator to be used for create Dynamic style together with `@Input`
 * @param style style
 * @param priority priority of style, default: 0
 * @decorator
 */
export function Style(style, priority) {
    return function (target, propertyKey, descriptor) {
        target.constructor[propertyKey] = style;
        // const _propertyKeyClass = `_${propertyKey}Class`;
        const _propertyKey = `_${propertyKey}`;
        if (descriptor) {
            const set = descriptor.set;
            descriptor.set = function (val) {
                createStyle(this, propertyKey, val, style, priority);
                set.call(this, val);
            };
            if (!descriptor.get) {
                descriptor.get = function () {
                    return this[_propertyKey];
                };
            }
        }
        else {
            Object.defineProperty(target, propertyKey, {
                configurable: true,
                enumerable: true,
                set(val) {
                    createStyle(this, propertyKey, val, style, priority);
                },
                get() {
                    return this[_propertyKey];
                }
            });
        }
    };
}
/**
 * Create a responsive style for component with a key
 * @param c The component
 * @param propertyKeyConfig Style key
 * @param value value
 * @param style style template
 * @param priority priority of style
 */
export function createStyle(c, propertyKeyConfig, value, style, priority) {
    const propertyKey = typeof propertyKeyConfig === 'string' ? propertyKeyConfig : propertyKeyConfig.key;
    const _propertyKeyClass = `_${propertyKey}Class`;
    const _propertyKey = `_${propertyKey}`;
    const oldValue = c[_propertyKey];
    c[_propertyKey] = value;
    if (value === null || value === undefined || value === false) {
        // Remove classes
        const classesForRemove = c[_propertyKeyClass];
        if (classesForRemove && classesForRemove.length) {
            classesForRemove.forEach((className) => c.sRenderer.removeClass(className));
        }
    }
    else if (typeof value === 'string') {
        if (oldValue !== value) {
            c.sRenderer.removeClasses(c[_propertyKeyClass]);
            const values = parseMediaQueriesFromString(value);
            for (let index = 0; index < values.length; index++) {
                const valAndMediaKey = values[index];
                parseMediaQueryFromString(valAndMediaKey).forEach((_) => {
                    _renderStyle(c, propertyKeyConfig, _[0], _[1], style, priority);
                });
            }
        }
    }
    else if (typeof value === 'number' || value === true) {
        if (oldValue !== value) {
            c.sRenderer.removeClasses(c[_propertyKeyClass]);
            _renderStyle(c, propertyKeyConfig, value, null, style, priority);
        }
    }
    else if (oldValue !== `${value}`) {
        c.sRenderer.removeClasses(c[_propertyKeyClass]);
        // Is array
        for (let index = 0; index < value.length; index++) {
            const val = value[index];
            if (typeof val === 'number' || val === null || val === undefined) {
                _renderStyle(c, propertyKeyConfig, val, null, style, priority);
            }
            else if (typeof val === 'string') {
                parseMediaQueryFromString(val).forEach((_) => {
                    _renderStyle(c, propertyKeyConfig, _[0], _[1], style, priority);
                });
            }
        }
    }
}
export function _renderStyle(c, propertyKeyConfig, val, media, style, priority) {
    const propertyKey = typeof propertyKeyConfig === 'string' ? propertyKeyConfig : propertyKeyConfig.key;
    const _propertyKeyClass = `_${propertyKey}Class`;
    const styleTemplate = style(val, media, c);
    if (styleTemplate == null) {
        // Remove classes
        const classesForRemove = c[_propertyKeyClass];
        if (classesForRemove && classesForRemove.length) {
            classesForRemove.forEach((className) => c.sRenderer.removeClass(className));
            c[_propertyKeyClass] = [];
        }
    }
    else {
        if (c[_propertyKeyClass] === undefined) {
            c[_propertyKeyClass] = [];
        }
        c[_propertyKeyClass].push(c.sRenderer.add(`${typeof propertyKeyConfig === 'string' ? getComponentName(c) : propertyKeyConfig.и}--${propertyKey}-${media ? val + '_' + media : val}`, styleTemplate, getComponentPriority(c, priority), c[_propertyKeyClass]));
    }
}
function getComponentName(comp) {
    return comp.constructor.и || comp.constructor.name || 'unnamed';
}
function getComponentPriority(comp, priority) {
    var _a, _b;
    return (_b = (_a = priority !== null && priority !== void 0 ? priority : comp.$priority) !== null && _a !== void 0 ? _a : comp.constructor.$priority) !== null && _b !== void 0 ? _b : 0;
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXItc3R5bGUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYi9zcmMvbWluaW1hbC9yZW5kZXJlci1zdHlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVFLE9BQU8sRUFBRSxRQUFRLEVBQVksTUFBTSx5QkFBeUIsQ0FBQztBQUU3RCxPQUFPLEVBQUUsU0FBUyxFQUF1QixNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSx5QkFBeUIsRUFBbUIsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHekcsTUFBTSxPQUFPLGFBQWE7QUFDMUIsSUFHRSxZQUNVLE1BQWdCLEVBQ1osR0FBZSxFQUNQLFNBQW9CO0FBQ3pDLFFBSFMsV0FBTSxHQUFOLE1BQU0sQ0FBVTtBQUFDLFFBRUwsY0FBUyxHQUFULFNBQVMsQ0FBVztBQUM1QyxRQVBtQixTQUFJLEdBQWdCLElBQUksR0FBRyxFQUFVLENBQUM7QUFDekQsUUFPSSxJQUFJLEdBQUcsRUFBRTtBQUNiLFlBQU0sSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDO0FBQ3BDLFlBQU0sSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0FBQ3BDLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNFO0FBQ0Y7QUFDRTtBQUNFO0FBQ0U7QUFFSDtBQUNIO0FBQ087QUFDSjtBQUFhO0FBQ0U7QUFDRTtBQUlwQjtBQUFVO0FBQVc7QUFBTztBQUlsQjtBQUNKO0FBQVk7QUFBTztBQUNwQjtBQUVvQjtBQUFXLE9BRC9CO0FBQ0wsSUFBRSxXQUFXLENBQUksTUFBb0IsRUFBRSxjQUE2QztBQUFJLFFBQ3BGLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENB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bnRSZWYsIFJlbmRlcmVyMiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEx5VGhlbWUyLCBUaGVtZVJlZiB9IGZyb20gJy4uL3RoZW1lL3RoZW1lMi5zZXJ2aWNlJztcbmltcG9ydCB7IFN0eWxlVGVtcGxhdGUgfSBmcm9tICcuLi9wYXJzZSc7XG5pbXBvcnQgeyBUeXBlU3R5bGUsIEx5U3R5bGVzLCBMeUNsYXNzZXMgfSBmcm9tICcuLi90aGVtZS9zdHlsZSc7XG5pbXBvcnQgeyBwYXJzZU1lZGlhUXVlcmllc0Zyb21TdHJpbmcsIHBhcnNlTWVkaWFRdWVyeUZyb21TdHJpbmcsIE1lZGlhUXVlcnlBcnJheSB9IGZyb20gJy4uL3N0eWxlLXV0aWxzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFN0eWxlUmVuZGVyZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IF9zZXQ6IFNldDxzdHJpbmc+ID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIHByaXZhdGUgX25FbDogSFRNTEVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfdGhlbWU6IEx5VGhlbWUyLFxuICAgIEBPcHRpb25hbCgpIF9lbDogRWxlbWVudFJlZixcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIF9yZW5kZXJlcjogUmVuZGVyZXIyXG4gICkge1xuICAgIGlmIChfZWwpIHtcbiAgICAgIHRoaXMuX25FbCA9IF9lbC5uYXRpdmVFbGVtZW50O1xuICAgICAgdGhpcy5fc2V0ID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIG11bHRpcGxlIHN0eWxlcyBhbmQgcmVuZGVyIHRoZW0gaW4gdGhlIERPTS5cbiAgICogQHBhcmFtIHN0eWxlcyBTdHlsZXNcbiAgICogQHBhcmFtIGFwcGx5Um9vdENsYXNzIElmIGBhcHBseVRvUm9vdGAgaXMgYHRydWVgIGFuZCB0aGUgcm9vdCBwcm9wZXJ0eSBpcyBkZWZpbmVkLFxuICAgKiBpdCB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgYWRkZWQgdG8gdGhlIGNvbXBvbmVudC5cbiAgICpcbiAgICogZS5nLlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBTVFlMRVMgPSAoKSA9PiAoe1xuICAgKiAgIHJvb3Q6IGx5bCBgey4uLn1gLCAvLyB0aGlzIGNsYXNzIHdpbGwgYmUgYWRkZWQgdG8gdGhlIHJvb3QgY29tcG9uZW50XG4gICAqICAgaXRlbTogbHlsIGB7Li4ufWBcbiAgICogfSlcbiAgICogYGBgXG4gICAqXG4gICAqIEFsc28gYWNjZXB0cyB0aGUgbmFtZSBvZiBhIGNsYXNzLlxuICAgKlxuICAgKiBlLmcuXG4gICAqXG4gICAqIGBgYHRzXG4gICAqIHJlbmRlclNoZWV0KFNUWUxFUywgJ2l0ZW0nKVxuICAgKiBgYGBcbiAgICovXG4gIHJlbmRlclNoZWV0PFQ+KHN0eWxlczogVCAmIEx5U3R5bGVzLCBhcHBseVJvb3RDbGFzcz86IGJvb2xlYW4gfCBrZXlvZiBMeUNsYXNzZXM8VD4pOiBMeUNsYXNzZXM8VD4ge1xuICAgIGNvbnN0IGNsYXNzZXMgPSB0aGlzLl90aGVtZS5yZW5kZXJTdHlsZVNoZWV0KHN0eWxlcyk7XG4gICAgaWYgKGFwcGx5Um9vdENsYXNzID09PSB0cnVlICYmIChjbGFzc2VzIGFzIGFueSkucm9vdCkge1xuICAgICAgdGhpcy5hZGRDbGFzcygoY2xhc3NlcyBhcyBhbnkpLnJvb3QpO1xuICAgICAgcmV0dXJuIGNsYXNzZXM7XG4gICAgfVxuICAgIGlmIChhcHBseVJvb3RDbGFzcykge1xuICAgICAgY29uc3QgY3VzdG9tQ2xhc3MgPSAoY2xhc3NlcyBhcyBhbnkpW2FwcGx5Um9vdENsYXNzXTtcbiAgICAgIGlmIChjdXN0b21DbGFzcykge1xuICAgICAgICB0aGlzLmFkZENsYXNzKGN1c3RvbUNsYXNzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNsYXNzZXM7XG4gIH1cblxuICBhZGQoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcbiAgYWRkKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyXG4gICk6IHN0cmluZztcbiAgYWRkKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBvbGRDbGFzczogc3RyaW5nXG4gICk6IHN0cmluZztcbiAgYWRkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcblxuICBhZGQoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXIsXG4gICAgb2xkQ2xhc3M6IHN0cmluZyB8IG51bGxcbiAgKTogc3RyaW5nO1xuICBhZGQoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBzdHlsZTogKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgcHJpb3JpdHk6IG51bWJlclxuICApOiBzdHJpbmc7XG4gIGFkZChcbiAgICBpZDogc3RyaW5nLFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBvbGRDbGFzczogc3RyaW5nIHwgbnVsbFxuICApOiBzdHJpbmc7XG5cbiAgYWRkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXIsXG4gICAgb2xkQ2xhc3M6IHN0cmluZyB8IG51bGxcbiAgKTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBSZW5kZXIgc3R5bGUgYW5kIGFwcGx5IGNsYXNzIG5hbWUgdG8gaG9zdCBDb21wb25lbnQgb3IgRGlyZWN0aXZlLFxuICAgKiByZXF1aXJlIHByb3ZpZGUgYFN0eWxlUmVuZGVyZXJgIGluIHlvdXIgQ29tcG9uZW50LlxuICAgKiBlLmcuXG4gICAqIEBDb21wb25lbnQoe1xuICAgKiAgIC4uLlxuICAgKiAgIHByb3ZpZGVyczogWyBTdHlsZVJlbmRlcmVyIF1cbiAgICogfSlcbiAgICovXG4gIGFkZChcbiAgICBpZDogc3RyaW5nIHwgKCh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlKSxcbiAgICBzdHlsZT86ICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSkgfCBudW1iZXIgfCBzdHJpbmcsXG4gICAgcHJpb3JpdHk/OiBudW1iZXIgfCBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsLFxuICAgIG9sZENsYXNzPzogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbFxuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IGFyZ3MgPSBhcmd1bWVudHM7XG4gICAgLyoqIENsYXNzIG5hbWUgb3Iga2V5ZnJhbWUgbmFtZSAqL1xuICAgIGxldCBjbGFzc05hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgbGVuID0gYXJncy5sZW5ndGg7XG5cbiAgICAvLyBjbGVhblxuICAgIGlmIChsZW4gPT09IDQgJiYgYXJnc1szXSA9PSBudWxsKSB7XG4gICAgICBsZW4gLT0gMTtcbiAgICB9XG4gICAgaWYgKGxlbiA9PT0gMyAmJiBhcmdzWzJdID09IG51bGwpIHtcbiAgICAgIGxlbiAtPSAxO1xuICAgIH1cblxuICAgIGlmIChsZW4gPT09IDEpIHtcbiAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKGlkLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgIH0gZWxzZSBpZiAobGVuID09PSAyKSB7XG4gICAgICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykge1xuICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihzdHlsZSBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBpZCxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHlsZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoaWQgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBzdHlsZSxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoaWQgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgICAgIG9sZENsYXNzID0gc3R5bGUgYXMgc3RyaW5nO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAobGVuID09PSAzKSB7XG4gICAgICBpZiAodHlwZW9mIGlkID09PSAnc3RyaW5nJykge1xuICAgICAgICBpZiAodHlwZW9mIHByaW9yaXR5ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgIC8vIChpZCwgc3R5bGUsIHByaW9yaXR5KVxuICAgICAgICAgIGNsYXNzTmFtZSA9IHRoaXMuX3RoZW1lLl9jcmVhdGVTdHlsZUNvbnRlbnQyKHN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICAgIGlkLFxuICAgICAgICAgIHByaW9yaXR5LFxuICAgICAgICAgIFR5cGVTdHlsZS5MeWxTdHlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gKGlkLCBzdHlsZSwgb2xkQ2xhc3MpXG4gICAgICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGUgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgICAgaWQsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICAgIG9sZENsYXNzID0gcHJpb3JpdHk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIChzdHlsZSwgcHJpb3JpdHksIG9sZENsYXNzKVxuICAgICAgICBjbGFzc05hbWUgPSB0aGlzLl90aGVtZS5fY3JlYXRlU3R5bGVDb250ZW50MihpZCBhcyAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIHN0eWxlIGFzIG51bWJlcixcbiAgICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgICAgICBvbGRDbGFzcyA9IHByaW9yaXR5IGFzIHN0cmluZztcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGxlbiA9PT0gNCkge1xuICAgICAgY2xhc3NOYW1lID0gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGUgYXMgKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUsXG4gICAgICAgIGlkIGFzIHN0cmluZyxcbiAgICAgICAgcHJpb3JpdHkgYXMgbnVtYmVyLFxuICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbkVsKSB7XG4gICAgICByZXR1cm4gdGhpcy51cGRhdGVDbGFzcyhjbGFzc05hbWUhLCBvbGRDbGFzcyk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBTdHlsZVJlbmRlcmVyIGlzIHJlcXVpcmVkIG9uIHRoZSBDb21wb25lbnQhXFxuYFxuICAgICAgKyBgQWRkIHByb3ZpZGVyIGZvciBTdHlsZVJlbmRlcmVyIGluIENvbXBvbmVudCBvciBEaXJlY3RpdmU6XFxuXFxuYFxuICAgICAgKyBgZS5nOlxcblxcbmBcbiAgICAgICsgYEBDb21wb25lbnQoe1xcbmBcbiAgICAgICsgYCAgcHJvdmlkZXJzOiBbIFN0eWxlUmVuZGVyZXIgXVxcbmBcbiAgICAgICsgYH0pXFxuYFxuICAgICk7XG4gIH1cblxuICByZW5kZXIoXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIHN0eWxlOiAodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSxcbiAgICBwcmlvcml0eTogbnVtYmVyXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlXG4gICk6IHN0cmluZztcbiAgcmVuZGVyKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgc3R5bGU6ICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgIHByaW9yaXR5OiBudW1iZXJcbiAgKTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBPbmx5IHJlbmRlciBzdHlsZSBhbmQgcmV0dXJuIGNsYXNzIG5hbWUuXG4gICAqL1xuICByZW5kZXIoXG4gICAgc3R5bGVPcklkOiBzdHJpbmcgfCAoKHRoZW1lOiBhbnksIHJlZjogVGhlbWVSZWYpID0+IFN0eWxlVGVtcGxhdGUpLFxuICAgIHByaW9yaXR5T3JTdHlsZT86ICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSkgfCBudW1iZXIgfCBzdHJpbmcsXG4gICAgcHJpb3JpdHk/OiBudW1iZXIgfCB1bmRlZmluZWQgfCBudWxsXG4gICk6IHN0cmluZyB7XG4gICAgaWYgKHR5cGVvZiBzdHlsZU9ySWQgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIocHJpb3JpdHlPclN0eWxlIGFzICh0aGVtZTogYW55LCByZWY6IFRoZW1lUmVmKSA9PiBTdHlsZVRlbXBsYXRlLFxuICAgICAgICBzdHlsZU9ySWQsXG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBUeXBlU3R5bGUuTHlsU3R5bGUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdGhlbWUuX2NyZWF0ZVN0eWxlQ29udGVudDIoc3R5bGVPcklkLFxuICAgICAgbnVsbCxcbiAgICAgIHByaW9yaXR5LFxuICAgICAgVHlwZVN0eWxlLkx5bFN0eWxlKTtcbiAgfVxuXG4gIGFkZENsYXNzKGNsYXNzTmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCF0aGlzLl9zZXQuaGFzKGNsYXNzTmFtZSkpIHtcbiAgICAgIHRoaXMuX3NldC5hZGQoY2xhc3NOYW1lKTtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRoaXMuX25FbCwgY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVDbGFzcyhjbGFzc05hbWU/OiBzdHJpbmcgfCBudWxsKSB7XG4gICAgaWYgKGNsYXNzTmFtZSAmJiB0aGlzLl9zZXQuaGFzKGNsYXNzTmFtZSkpIHtcbiAgICAgIHRoaXMuX3NldC5kZWxldGUoY2xhc3NOYW1lKTtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuX25FbCwgY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVDbGFzc2VzKHJhd0NsYXNzVmFsPzogc3RyaW5nW10gfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHJhd0NsYXNzVmFsKSB7XG4gICAgICByYXdDbGFzc1ZhbC5mb3JFYWNoKGtsYXNzID0+XG4gICAgICAgIHRoaXMucmVtb3ZlQ2xhc3Moa2xhc3MpXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHRvZ2dsZUNsYXNzKGNsYXNzTmFtZTogc3RyaW5nLCBlbmFibGVkOiBib29sZWFuKSB7XG4gICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgIHRoaXMuYWRkQ2xhc3MoY2xhc3NOYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZUNsYXNzKG5ld0NsYXNzTmFtZTogc3RyaW5nLCBvbGRDbGFzc05hbWU6IHN0cmluZyB8IG51bGwgfCB1bmRlZmluZWQpIHtcbiAgICB0aGlzLnJlbW92ZUNsYXNzKG9sZENsYXNzTmFtZSk7XG4gICAgdGhpcy5hZGRDbGFzcyhuZXdDbGFzc05hbWUpO1xuICAgIHJldHVybiBuZXdDbGFzc05hbWU7XG4gIH1cblxufVxuXG5leHBvcnQgdHlwZSBJbnB1dFN0eWxlPElOUFVULCBDID0gYW55PiA9ICh2YWw6IEV4Y2x1ZGU8Tm9uTnVsbGFibGU8SU5QVVQ+LCBNZWRpYVF1ZXJ5QXJyYXk+LCBtZWRpYTogc3RyaW5nIHwgbnVsbCwgY29tcDogQykgPT5cbiAgKFxuICAgICgodGhlbWU6IGFueSwgcmVmOiBUaGVtZVJlZikgPT4gU3R5bGVUZW1wbGF0ZSkgfCBudWxsXG4gICk7XG5cbi8qKlxuICogUGFyYW1ldGVyIGRlY29yYXRvciB0byBiZSB1c2VkIGZvciBjcmVhdGUgRHluYW1pYyBzdHlsZSB0b2dldGhlciB3aXRoIGBASW5wdXRgXG4gKiBAcGFyYW0gc3R5bGUgc3R5bGVcbiAqIEBkZWNvcmF0b3JcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIFN0eWxlPElOUFVUID0gYW55LCBDID0gYW55PihcbiAgc3R5bGU6IElucHV0U3R5bGU8SU5QVVQsIEM+XG4pOiAodGFyZ2V0OiBXaXRoU3R5bGVzLCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yPzogVHlwZWRQcm9wZXJ0eURlc2NyaXB0b3I8SU5QVVQ+IHwgdW5kZWZpbmVkKSA9PiB2b2lkO1xuXG4vKipcbiAqIFBhcmFtZXRlciBkZWNvcmF0b3IgdG8gYmUgdXNlZCBmb3IgY3JlYXRlIER5bmFtaWMgc3R5bGUgdG9nZXRoZXIgd2l0aCBgQElucHV0YFxuICogQHBhcmFtIHN0eWxlIHN0eWxlXG4gKiBAZGVjb3JhdG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBTdHlsZTxJTlBVVCA9IGFueSwgQyA9IGFueT4oXG4gIHN0eWxlOiBJbnB1dFN0eWxlPElOUFVULCBDPixcbiAgcHJpb3JpdHk6IG51bWJlclxuKTogKHRhcmdldDogV2l0aFN0eWxlcywgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcj86IFR5cGVkUHJvcGVydHlEZXNjcmlwdG9yPElOUFVUPiB8IHVuZGVmaW5lZCkgPT4gdm9pZDtcblxuLyoqXG4gKiBQYXJhbWV0ZXIgZGVjb3JhdG9yIHRvIGJlIHVzZWQgZm9yIGNyZWF0ZSBEeW5hbWljIHN0eWxlIHRvZ2V0aGVyIHdpdGggYEBJbnB1dGBcbiAqIEBwYXJhbSBzdHlsZSBzdHlsZVxuICogQHBhcmFtIHByaW9yaXR5IHByaW9yaXR5IG9mIHN0eWxlLCBkZWZhdWx0OiAwXG4gKiBAZGVjb3JhdG9yXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBTdHlsZTxJTlBVVCA9IGFueSwgQyA9IGFueT4oXG4gIHN0eWxlOiBJbnB1dFN0eWxlPElOUFVULCBDPixcbiAgcHJpb3JpdHk/OiBudW1iZXJcbikge1xuXG4gIHJldHVybiBmdW5jdGlvbih0YXJnZXQ6IFdpdGhTdHlsZXMsIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I/OiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxJTlBVVD4pIHtcbiAgICB0YXJnZXQuY29uc3RydWN0b3JbcHJvcGVydHlLZXldID0gc3R5bGU7XG4gICAgLy8gY29uc3QgX3Byb3BlcnR5S2V5Q2xhc3MgPSBgXyR7cHJvcGVydHlLZXl9Q2xhc3NgO1xuICAgIGNvbnN0IF9wcm9wZXJ0eUtleSA9IGBfJHtwcm9wZXJ0eUtleX1gO1xuICAgIGlmIChkZXNjcmlwdG9yKSB7XG4gICAgICBjb25zdCBzZXQgPSBkZXNjcmlwdG9yLnNldCE7XG4gICAgICBkZXNjcmlwdG9yLnNldCA9IGZ1bmN0aW9uKHZhbDogSU5QVVQpIHtcbiAgICAgICAgY3JlYXRlU3R5bGUoXG4gICAgICAgICAgdGhpcyxcbiAgICAgICAgICBwcm9wZXJ0eUtleSxcbiAgICAgICAgICB2YWwsXG4gICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgcHJpb3JpdHlcbiAgICAgICAgKTtcbiAgICAgICAgc2V0LmNhbGwodGhpcywgdmFsKTtcbiAgICAgIH07XG4gICAgICBpZiAoIWRlc2NyaXB0b3IuZ2V0KSB7XG4gICAgICAgIGRlc2NyaXB0b3IuZ2V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXNbX3Byb3BlcnR5S2V5XTtcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcGVydHlLZXksIHtcbiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBzZXQodmFsOiBJTlBVVCkge1xuICAgICAgICAgIGNyZWF0ZVN0eWxlKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIHByb3BlcnR5S2V5LFxuICAgICAgICAgICAgdmFsLFxuICAgICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgICBwcmlvcml0eVxuICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICAgIGdldCgpIHtcbiAgICAgICAgICByZXR1cm4gdGhpc1tfcHJvcGVydHlLZXldO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgcmVzcG9uc2l2ZSBzdHlsZSBmb3IgY29tcG9uZW50IHdpdGggYSBrZXlcbiAqIEBwYXJhbSBjIFRoZSBjb21wb25lbnRcbiAqIEBwYXJhbSBwcm9wZXJ0eUtleUNvbmZpZyBTdHlsZSBrZXlcbiAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxuICogQHBhcmFtIHN0eWxlIHN0eWxlIHRlbXBsYXRlXG4gKiBAcGFyYW0gcHJpb3JpdHkgcHJpb3JpdHkgb2Ygc3R5bGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0eWxlPElOUFVULCBDPihcbiAgYzogV2l0aFN0eWxlcyxcbiAgcHJvcGVydHlLZXlDb25maWc6IHN0cmluZyB8IFN0eWxlUHJvcGVydHlLZXksXG4gIHZhbHVlOiBJTlBVVCxcbiAgc3R5bGU6IElucHV0U3R5bGU8SU5QVVQsIEM+LFxuICBwcmlvcml0eT86IG51bWJlclxuKSB7XG4gIGNvbnN0IHByb3BlcnR5S2V5ID0gdHlwZW9mIHByb3BlcnR5S2V5Q29uZmlnID09PSAnc3RyaW5nJyA/IHByb3BlcnR5S2V5Q29uZmlnIDogcHJvcGVydHlLZXlDb25maWcua2V5O1xuICBjb25zdCBfcHJvcGVydHlLZXlDbGFzcyA9IGBfJHtwcm9wZXJ0eUtleX1DbGFzc2A7XG4gIGNvbnN0IF9wcm9wZXJ0eUtleSA9IGBfJHtwcm9wZXJ0eUtleX1gO1xuICBjb25zdCBvbGRWYWx1ZSA9IGNbX3Byb3BlcnR5S2V5XTtcbiAgY1tfcHJvcGVydHlLZXldID0gdmFsdWU7XG4gIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8ICh2YWx1ZSBhcyBhbnkpID09PSBmYWxzZSkge1xuICAgIC8vIFJlbW92ZSBjbGFzc2VzXG4gICAgY29uc3QgY2xhc3Nlc0ZvclJlbW92ZTogbnVsbCB8IHN0cmluZ1tdID0gY1tfcHJvcGVydHlLZXlDbGFzc107XG4gICAgaWYgKGNsYXNzZXNGb3JSZW1vdmUgJiYgY2xhc3Nlc0ZvclJlbW92ZS5sZW5ndGgpIHtcbiAgICAgIGNsYXNzZXNGb3JSZW1vdmUuZm9yRWFjaCgoY2xhc3NOYW1lOiBzdHJpbmcpID0+XG4gICAgICAgIGMuc1JlbmRlcmVyLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSlcbiAgICAgICk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICBpZiAob2xkVmFsdWUgIT09IHZhbHVlKSB7XG4gICAgICBjLnNSZW5kZXJlci5yZW1vdmVDbGFzc2VzKGNbX3Byb3BlcnR5S2V5Q2xhc3NdKTtcbiAgICAgIGNvbnN0IHZhbHVlcyA9IHBhcnNlTWVkaWFRdWVyaWVzRnJvbVN0cmluZyh2YWx1ZSk7XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdmFsdWVzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCB2YWxBbmRNZWRpYUtleSA9IHZhbHVlc1tpbmRleF07XG4gICAgICAgIHBhcnNlTWVkaWFRdWVyeUZyb21TdHJpbmcodmFsQW5kTWVkaWFLZXkpLmZvckVhY2goKF8pID0+IHtcbiAgICAgICAgICBfcmVuZGVyU3R5bGUoYywgcHJvcGVydHlLZXlDb25maWcsIF9bMF0sIF9bMV0sIHN0eWxlLCBwcmlvcml0eSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8ICh2YWx1ZSBhcyBhbnkpID09PSB0cnVlKSB7XG4gICAgaWYgKG9sZFZhbHVlICE9PSB2YWx1ZSkge1xuICAgICAgYy5zUmVuZGVyZXIucmVtb3ZlQ2xhc3NlcyhjW19wcm9wZXJ0eUtleUNsYXNzXSk7XG4gICAgICBfcmVuZGVyU3R5bGUoYywgcHJvcGVydHlLZXlDb25maWcsIHZhbHVlIGFzIGFueSwgbnVsbCwgc3R5bGUsIHByaW9yaXR5KTtcbiAgICB9XG4gIH0gZWxzZSBpZiAob2xkVmFsdWUgIT09IGAke3ZhbHVlfWApIHtcbiAgICBjLnNSZW5kZXJlci5yZW1vdmVDbGFzc2VzKGNbX3Byb3BlcnR5S2V5Q2xhc3NdKTtcbiAgICAvLyBJcyBhcnJheVxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCAodmFsdWUgYXMgYW55KS5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IHZhbCA9IHZhbHVlW2luZGV4XTtcbiAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJyB8fCB2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgX3JlbmRlclN0eWxlKGMsIHByb3BlcnR5S2V5Q29uZmlnLCB2YWwsIG51bGwsIHN0eWxlLCBwcmlvcml0eSk7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHBhcnNlTWVkaWFRdWVyeUZyb21TdHJpbmcodmFsKS5mb3JFYWNoKChfKSA9PiB7XG4gICAgICAgICAgX3JlbmRlclN0eWxlKGMsIHByb3BlcnR5S2V5Q29uZmlnLCBfWzBdLCBfWzFdLCBzdHlsZSwgcHJpb3JpdHkpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9yZW5kZXJTdHlsZTxJTlBVVCwgQz4oXG4gIGM6IFdpdGhTdHlsZXMsXG4gIHByb3BlcnR5S2V5Q29uZmlnOiBzdHJpbmcgfCBTdHlsZVByb3BlcnR5S2V5LFxuICB2YWw6IHN0cmluZyB8IG51bWJlcixcbiAgbWVkaWE6IHN0cmluZyB8IG51bGwsXG4gIHN0eWxlOiBJbnB1dFN0eWxlPElOUFVULCBDPixcbiAgcHJpb3JpdHk/OiBudW1iZXJcbikge1xuICBjb25zdCBwcm9wZXJ0eUtleSA9IHR5cGVvZiBwcm9wZXJ0eUtleUNvbmZpZyA9PT0gJ3N0cmluZycgPyBwcm9wZXJ0eUtleUNvbmZpZyA6IHByb3BlcnR5S2V5Q29uZmlnLmtleTtcbiAgY29uc3QgX3Byb3BlcnR5S2V5Q2xhc3MgPSBgXyR7cHJvcGVydHlLZXl9Q2xhc3NgO1xuICBjb25zdCBzdHlsZVRlbXBsYXRlID0gc3R5bGUodmFsIGFzIGFueSwgbWVkaWEsIGMgYXMgYW55KTtcbiAgaWYgKHN0eWxlVGVtcGxhdGUgPT0gbnVsbCkge1xuICAgIC8vIFJlbW92ZSBjbGFzc2VzXG4gICAgY29uc3QgY2xhc3Nlc0ZvclJlbW92ZTogbnVsbCB8IHN0cmluZ1tdID0gY1tfcHJvcGVydHlLZXlDbGFzc107XG4gICAgaWYgKGNsYXNzZXNGb3JSZW1vdmUgJiYgY2xhc3Nlc0ZvclJlbW92ZS5sZW5ndGgpIHtcbiAgICAgIGNsYXNzZXNGb3JSZW1vdmUuZm9yRWFjaCgoY2xhc3NOYW1lOiBzdHJpbmcpID0+XG4gICAgICAgIGMuc1JlbmRlcmVyLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSlcbiAgICAgICk7XG4gICAgICBjW19wcm9wZXJ0eUtleUNsYXNzXSA9IFtdO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoY1tfcHJvcGVydHlLZXlDbGFzc10gPT09IHVuZGVmaW5lZCkge1xuICAgICAgY1tfcHJvcGVydHlLZXlDbGFzc10gPSBbXTtcbiAgICB9XG4gICAgY1tfcHJvcGVydHlLZXlDbGFzc10ucHVzaChjLnNSZW5kZXJlci5hZGQoXG4gICAgICBgJHt0eXBlb2YgcHJvcGVydHlLZXlDb25maWcgPT09ICdzdHJpbmcnID8gZ2V0Q29tcG9uZW50TmFtZShjKSA6IHByb3BlcnR5S2V5Q29uZmlnLtC4fS0tJHtwcm9wZXJ0eUtleX0tJHttZWRpYSA/IHZhbCArICdfJyArIG1lZGlhIDogdmFsfWAsXG4gICAgICBzdHlsZVRlbXBsYXRlLFxuICAgICAgZ2V0Q29tcG9uZW50UHJpb3JpdHkoYywgcHJpb3JpdHkpLFxuICAgICAgY1tfcHJvcGVydHlLZXlDbGFzc11cbiAgICApKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0eWxlUHJvcGVydHlLZXkge1xuICDQuDogc3RyaW5nO1xuICBrZXk6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaXRoU3R5bGVzIHtcbiAgLyoqIFN0eWxlIFByaW9yaXR5LCBkZWZhdWx0OiAwICovXG4gIHJlYWRvbmx5ICRwcmlvcml0eT86IG51bWJlcjtcbiAgcmVhZG9ubHkgc1JlbmRlcmVyOiBTdHlsZVJlbmRlcmVyO1xufVxuXG5mdW5jdGlvbiBnZXRDb21wb25lbnROYW1lKGNvbXA6IGFueSkge1xuICByZXR1cm4gY29tcC5jb25zdHJ1Y3Rvci7QuCB8fCBjb21wLmNvbnN0cnVjdG9yLm5hbWUgfHwgJ3VubmFtZWQnO1xufVxuZnVuY3Rpb24gZ2V0Q29tcG9uZW50UHJpb3JpdHkoY29tcDogYW55LCBwcmlvcml0eT86IG51bWJlcikge1xuICByZXR1cm4gcHJpb3JpdHkgPz8gY29tcC4kcHJpb3JpdHkgPz8gKGNvbXAuY29uc3RydWN0b3IgYXMgYW55KS4kcHJpb3JpdHkgPz8gMDtcbn1cbiJdfQ==