const LINE_FEED_REGEX = () => /(\n?[^\n]+\n?)/g;
const ɵ0 = LINE_FEED_REGEX;
const AMPERSAND_REGEX = () => /&/g;
const ɵ1 = AMPERSAND_REGEX;
const STYLE_TEMPLATE_REGEX = () => /__LY_EXPRESSION__\[[\w]+\]/g;
const ɵ2 = STYLE_TEMPLATE_REGEX;
let id = 0;
/**
 * Transform a lyl style block to CSS
 */
export class LylParse {
    constructor(_template, _className = '${className}') {
        this._template = _template;
        this._className = _className;
    }
    toCss() {
        const selectors = [];
        let selector = null;
        const rules = new Map();
        this._template
            .replace(/(\/\/\s[^\n\r]*(?:[\n\r]+|$))/g, '')
            .replace(/,\n/g, ',')
            .replace(LINE_FEED_REGEX(), (_ex, fullLine) => {
            fullLine = fullLine.trim();
            if (fullLine.endsWith('{')) {
                if (selectors.length === 0) {
                    selectors.push([this._className]);
                    selector = selectors[0][0];
                }
                else {
                    const line_1 = fullLine.slice(0, fullLine.length - 1).trim();
                    const isMediaQuery = line_1.includes('@');
                    if (isMediaQuery) {
                        selectors.push([line_1.trim()]);
                        if (!rules.has(line_1)) {
                            rules.set(line_1, []);
                        }
                    }
                    else {
                        selectors.push(line_1
                            .split(',')
                            .map(_ => _.trim()));
                    }
                    selector = this._resolveSelectors(selectors);
                }
                if (!rules.has(selector)) {
                    rules.set(selector, []);
                }
            }
            else if (fullLine.length === 1 && fullLine.endsWith('}')) {
                selectors.pop();
                if (selectors.length) {
                    selector = this._resolveSelectors(selectors);
                    if (!rules.has(selector)) {
                        rules.set(selector, []);
                    }
                }
            }
            else if (fullLine.startsWith('/* >> ds')) {
                selector = this._resolveSelectors(selectors);
                const lin = fullLine;
                // Ignore compiled css
                rules.get(selector).push(lin);
                // fullLine = lin;
                // /** For non LylModule< */else {
                //   fullLine = `\${(${lin.slice(2, lin.length - 1)})(\`${selector}\`)}`;
                //   rules.set(createUniqueCommentSelector('ds'), fullLine);
                // } /** for non LylModule>  */
            }
            else if (fullLine.startsWith('...')) {
                // for non LylModule>
                const content = fullLine.slice(3);
                selector = this._resolveSelectors(selectors);
                // Ignore compiled css
                rules.get(selector).push(`${createUniqueCommentSelector('cc')}${content}`);
            }
            else {
                if (fullLine) {
                    if (fullLine.includes('undefined') || fullLine.startsWith('// ')) {
                        return '';
                    }
                    if (fullLine.endsWith(';')) {
                        throw new Error(`Do not require semicolon in [${fullLine}]`);
                    }
                    if (fullLine.includes(': ')) {
                        fullLine = fullLine.replace(': ', ':');
                    }
                    fullLine += ';';
                    rules.get(selector).push(fullLine);
                }
            }
            return '';
        });
        // Join media queries & keyframes
        rules.forEach((val, key) => {
            const matchArray = key.match(/(@[^\${]*(?:\${[^{]*)*){/);
            if (matchArray) {
                const media = matchArray[1];
                if (media !== key && val.length) {
                    const after = rules.get(media);
                    const sel = key.replace(media + '{', '');
                    const newValue = after + val.reduce((previous, current) => {
                        const last = previous[previous.length - 1];
                        // __READY__ is added to be ignored by content.startsWith ('/ * >> xx')
                        if (current.startsWith('/* >> ds')) {
                            previous.push('/* __READY__ */' + current.replace(/\|\|\&\|\|/g, sel));
                        }
                        else if (current.startsWith('/* >> cc')) {
                            previous.push('/* __READY__ */' + transformCC(current, sel));
                        }
                        else {
                            if (Array.isArray(last)) {
                                last.push(current);
                            }
                            else {
                                previous.push([current]);
                            }
                        }
                        return previous;
                    }, [])
                        .map(item => Array.isArray(item) ? `${sel}{${item.join('')}}` : item).join('');
                    // const newValue = after
                    // + sel
                    // + `{${val.join('')}}`;
                    rules.set(media, [newValue]);
                    rules.delete(key);
                }
            }
        });
        return Array.from(rules.entries())
            .filter(rule => rule[1])
            .map(rule => {
            const sel = rule[0];
            const contents = rule[1];
            const css = [];
            const contentRendered = [];
            const set = new Set();
            for (let index = 0; index < contents.length; index++) {
                const content = contents[index];
                if (content) {
                    if (content.startsWith('/* >> ds')) {
                        contentRendered.push(content.replace(/\|\|\&\|\|/g, sel));
                        set.add(contentRendered);
                    }
                    else if (content.startsWith('/* >> cc')) {
                        contentRendered.push(transformCC(content, sel));
                        set.add(contentRendered);
                    }
                    else {
                        // css += `${sel}{${content}}`;
                        css.push(content);
                        set.add(css);
                    }
                }
            }
            return Array.from(set).map((_) => {
                if (_ === css) {
                    return css.length
                        ? `${sel}{${css.join('')}}`
                        : '';
                }
                else {
                    return _.join('');
                }
            }).join('');
        }).join('');
    }
    _resolveSelectors(selectors) {
        let media = null;
        const sel = selectors
            .map(_ => _.filter(__ => {
            if (__.startsWith('@')) {
                // save media
                media = __;
                return false;
            }
            return __;
        }))
            .filter(_ => _.length)
            .reduce((prev, current) => {
            const result = prev.map(item => current.map(cu => {
                if (cu.includes('&')) {
                    return cu.replace(AMPERSAND_REGEX(), item);
                }
                return `${item} ${cu}`;
            }));
            return Array.prototype.concat.apply([], result);
        })
            .join(',');
        if (media) {
            return `${media}{${sel}`;
        }
        return sel;
    }
}
function transformCC(content, sel) {
    content = content.replace(/\/\* >> cc[^\/\*]+\*\//g, '');
    let expression = content.slice(2, content.length - 1);
    expression = `st2c((${expression}), \`${sel}\`)`;
    return `\${${expression}}`;
}
export function lyl(literals, ...placeholders) {
    return (className) => {
        let result = '';
        // Save expressions
        const exMap = {};
        for (let i = 0; i < placeholders.length; i++) {
            const placeholder = placeholders[i];
            result += literals[i];
            if (result.endsWith('...')) {
                result = result.slice(0, result.length - 3);
                if (typeof placeholder === 'function'
                    || placeholder instanceof StyleCollection) {
                    result += `${createUniqueCommentSelector('ds')}${st2c(placeholder, '||&||')}`;
                }
            }
            else {
                const newID = `__LY_EXPRESSION__[__${(id++).toString(36)}]`;
                result += newID;
                exMap[newID] = `${placeholder}`;
            }
        }
        // add the last literal
        result += literals[literals.length - 1];
        const css = new LylParse(result, className).toCss();
        return css.replace(STYLE_TEMPLATE_REGEX(), (str) => {
            if (str in exMap) {
                return exMap[str];
            }
            return '';
        });
    };
}
function createUniqueCommentSelector(text = 'id') {
    return `/* >> ${text} -- ${Math.floor(new Date().valueOf() * Math.random()).toString(36)} */`;
}
export class StyleCollection {
    constructor(...templates) {
        this._templates = templates;
        this.css = this.css.bind(this);
    }
    add(...templates) {
        // return new StyleCollection(...[...this._templates, ...templates]);
        this._templates.push(...templates);
        return this;
    }
    /** Transform style */
    setTransformer(transformer) {
        this._transformer = transformer;
        return this;
    }
    /**
     * @return StyleTemplate
     * @docs-private
     */
    css(className) {
        let lin = '';
        const templates = this._templates;
        for (let index = 0; index < templates.length; index++) {
            let template;
            if (this._transformer) {
                template = ((this._transformer(templates[index])));
            }
            else {
                template = templates[index];
            }
            lin += template(className);
        }
        return lin;
    }
}
/**
 * Transform a ...{style} to css
 * For internal use purposes only
 * @param fn StyleTemplate or StyleCollection
 * @param className class name
 */
export function st2c(fn, className) {
    if (fn == null) {
        return '';
    }
    if (fn instanceof StyleCollection) {
        return fn.css(className);
    }
    return fn(className);
}
// export function normalizeStyleTemplate(
//   fn: StyleTemplate
//   ) {
//   if (fn.length) {
//     return fn as StyleTemplate;
//   } else {
//     return (fn as (() => StyleTemplate))();
//   }
// }
export class StringIdGenerator {
    constructor(chars = 'abcdefghijklmnopqrstuvwxyz') {
        this._chars = chars;
        this._nextId = [0];
    }
    next() {
        const r = [];
        for (const char of this._nextId) {
            r.unshift(this._chars[char]);
        }
        this._increment();
        return r.join('');
    }
    _increment() {
        for (let i = 0; i < this._nextId.length; i++) {
            const val = ++this._nextId[i];
            if (val >= this._chars.length) {
                this._nextId[i] = 0;
            }
            else {
                return;
            }
        }
        this._nextId.push(0);
    }
}
export { ɵ0, ɵ1, ɵ2 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvc3JjL3BhcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE1BQU0sZUFBZSxHQUFHLEdBQUcsRUFBRSxDQUFDLGlCQUFpQixDQUFDOztBQUNoRCxNQUFNLGVBQWUsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUM7O0FBQ25DLE1BQU0sb0JBQW9CLEdBQUcsR0FBRyxFQUFFLENBQUMsNkJBQTZCLENBQUM7O0FBQ2pFLElBQUksRUFBRSxHQUFXLENBQUMsQ0FBQztBQUVuQjs7R0FFRztBQUNILE1BQU0sT0FBTyxRQUFRO0lBRW5CLFlBQ1UsU0FBaUIsRUFDakIsYUFBcUIsY0FBYztRQURuQyxjQUFTLEdBQVQsU0FBUyxDQUFRO1FBQ2pCLGVBQVUsR0FBVixVQUFVLENBQXlCO0lBQ3pDLENBQUM7SUFFTCxLQUFLO1FBQ0gsTUFBTSxTQUFTLEdBQWlCLEVBQUUsQ0FBQztRQUNuQyxJQUFJLFFBQVEsR0FBa0IsSUFBSSxDQUFDO1FBQ25DLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxFQUFvQixDQUFDO1FBQzFDLElBQUksQ0FBQyxTQUFTO2FBQ1gsT0FBTyxDQUFDLGdDQUFnQyxFQUFFLEVBQUUsQ0FBQzthQUM3QyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQzthQUNwQixPQUFPLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsUUFBZ0IsRUFBRSxFQUFFO1lBQ3RELFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFM0IsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUMxQixJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUMxQixTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xDLFFBQVEsR0FBRyxT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QyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDNUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUM3QixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNyQjtpQkFBTTtnQkFDTCxPQUFPO2FBQ1I7U0FDRjtRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbG9yIH0gZnJvbSAnQGFseWxlL3VpL2NvbG9yJztcblxuY29uc3QgTElORV9GRUVEX1JFR0VYID0gKCkgPT4gLyhcXG4/W15cXG5dK1xcbj8pL2c7XG5jb25zdCBBTVBFUlNBTkRfUkVHRVggPSAoKSA9PiAvJi9nO1xuY29uc3QgU1RZTEVfVEVNUExBVEVfUkVHRVggPSAoKSA9PiAvX19MWV9FWFBSRVNTSU9OX19cXFtbXFx3XStcXF0vZztcbmxldCBpZDogbnVtYmVyID0gMDtcblxuLyoqXG4gKiBUcmFuc2Zvcm0gYSBseWwgc3R5bGUgYmxvY2sgdG8gQ1NTXG4gKi9cbmV4cG9ydCBjbGFzcyBMeWxQYXJzZSB7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfdGVtcGxhdGU6IHN0cmluZyxcbiAgICBwcml2YXRlIF9jbGFzc05hbWU6IHN0cmluZyA9ICcke2NsYXNzTmFtZX0nXG4gICkgeyB9XG5cbiAgdG9Dc3MoKSB7XG4gICAgY29uc3Qgc2VsZWN0b3JzOiAoc3RyaW5nW10pW10gPSBbXTtcbiAgICBsZXQgc2VsZWN0b3I6IG51bGwgfCBzdHJpbmcgPSBudWxsO1xuICAgIGNvbnN0IHJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZ1tdPigpO1xuICAgIHRoaXMuX3RlbXBsYXRlXG4gICAgICAucmVwbGFjZSgvKFxcL1xcL1xcc1teXFxuXFxyXSooPzpbXFxuXFxyXSt8JCkpL2csICcnKVxuICAgICAgLnJlcGxhY2UoLyxcXG4vZywgJywnKVxuICAgICAgLnJlcGxhY2UoTElORV9GRUVEX1JFR0VYKCksIChfZXgsIGZ1bGxMaW5lOiBzdHJpbmcpID0+IHtcbiAgICAgIGZ1bGxMaW5lID0gZnVsbExpbmUudHJpbSgpO1xuXG4gICAgICBpZiAoZnVsbExpbmUuZW5kc1dpdGgoJ3snKSkge1xuICAgICAgICBpZiAoc2VsZWN0b3JzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHNlbGVjdG9ycy5wdXNoKFt0aGlzLl9jbGFzc05hbWVdKTtcbiAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yc1swXVswXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBsaW5lXzEgPSBmdWxsTGluZS5zbGljZSgwLCBmdWxsTGluZS5sZW5ndGggLSAxKS50cmltKCk7XG4gICAgICAgICAgY29uc3QgaXNNZWRpYVF1ZXJ5ID0gbGluZV8xLmluY2x1ZGVzKCdAJyk7XG4gICAgICAgICAgaWYgKGlzTWVkaWFRdWVyeSkge1xuICAgICAgICAgICAgc2VsZWN0b3JzLnB1c2goXG4gICAgICAgICAgICAgIFtsaW5lXzEudHJpbSgpXVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmICghcnVsZXMuaGFzKGxpbmVfMSkpIHtcbiAgICAgICAgICAgICAgcnVsZXMuc2V0KGxpbmVfMSwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWxlY3RvcnMucHVzaChcbiAgICAgICAgICAgICAgbGluZV8xXG4gICAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAgIC5tYXAoXyA9PiBfLnRyaW0oKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNlbGVjdG9yID0gdGhpcy5fcmVzb2x2ZVNlbGVjdG9ycyhzZWxlY3RvcnMpO1xuXG4gICAgICAgIH1cblxuXG4gICAgICAgIGlmICghcnVsZXMuaGFzKHNlbGVjdG9yKSkge1xuICAgICAgICAgIHJ1bGVzLnNldChzZWxlY3RvciwgW10pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGZ1bGxMaW5lLmxlbmd0aCA9PT0gMSAmJiBmdWxsTGluZS5lbmRzV2l0aCgnfScpKSB7XG4gICAgICAgIHNlbGVjdG9ycy5wb3AoKTtcbiAgICAgICAgaWYgKHNlbGVjdG9ycy5sZW5ndGgpIHtcbiAgICAgICAgICBzZWxlY3RvciA9IHRoaXMuX3Jlc29sdmVTZWxlY3RvcnMoc2VsZWN0b3JzKTtcbiAgICAgICAgICBpZiAoIXJ1bGVzLmhhcyhzZWxlY3RvcikpIHtcbiAgICAgICAgICAgIHJ1bGVzLnNldChzZWxlY3RvciwgW10pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChmdWxsTGluZS5zdGFydHNXaXRoKCcvKiA+PiBkcycpKSB7XG4gICAgICAgIHNlbGVjdG9yID0gdGhpcy5fcmVzb2x2ZVNlbGVjdG9ycyhzZWxlY3RvcnMpO1xuICAgICAgICBjb25zdCBsaW4gPSBmdWxsTGluZTtcblxuICAgICAgICAvLyBJZ25vcmUgY29tcGlsZWQgY3NzXG4gICAgICAgIHJ1bGVzLmdldChzZWxlY3RvcikhLnB1c2gobGluKTtcbiAgICAgICAgLy8gZnVsbExpbmUgPSBsaW47XG4gICAgICAgIC8vIC8qKiBGb3Igbm9uIEx5bE1vZHVsZTwgKi9lbHNlIHtcbiAgICAgICAgLy8gICBmdWxsTGluZSA9IGBcXCR7KCR7bGluLnNsaWNlKDIsIGxpbi5sZW5ndGggLSAxKX0pKFxcYCR7c2VsZWN0b3J9XFxgKX1gO1xuICAgICAgICAvLyAgIHJ1bGVzLnNldChjcmVhdGVVbmlxdWVDb21tZW50U2VsZWN0b3IoJ2RzJyksIGZ1bGxMaW5lKTtcbiAgICAgICAgLy8gfSAvKiogZm9yIG5vbiBMeWxNb2R1bGU+ICAqL1xuICAgICAgfSBlbHNlIGlmIChmdWxsTGluZS5zdGFydHNXaXRoKCcuLi4nKSkge1xuICAgICAgICAvLyBmb3Igbm9uIEx5bE1vZHVsZT5cbiAgICAgICAgY29uc3QgY29udGVudCA9IGZ1bGxMaW5lLnNsaWNlKDMpO1xuICAgICAgICBzZWxlY3RvciA9IHRoaXMuX3Jlc29sdmVTZWxlY3RvcnMoc2VsZWN0b3JzKTtcbiAgICAgICAgLy8gSWdub3JlIGNvbXBpbGVkIGNzc1xuICAgICAgICBydWxlcy5nZXQoc2VsZWN0b3IpIS5wdXNoKGAke2NyZWF0ZVVuaXF1ZUNvbW1lbnRTZWxlY3RvcignY2MnKX0ke2NvbnRlbnR9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZnVsbExpbmUpIHtcbiAgICAgICAgICBpZiAoZnVsbExpbmUuaW5jbHVkZXMoJ3VuZGVmaW5lZCcpIHx8IGZ1bGxMaW5lLnN0YXJ0c1dpdGgoJy8vICcpKSB7XG4gICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChmdWxsTGluZS5lbmRzV2l0aCgnOycpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERvIG5vdCByZXF1aXJlIHNlbWljb2xvbiBpbiBbJHtmdWxsTGluZX1dYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChmdWxsTGluZS5pbmNsdWRlcygnOiAnKSkge1xuICAgICAgICAgICAgZnVsbExpbmUgPSBmdWxsTGluZS5yZXBsYWNlKCc6ICcsICc6Jyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZ1bGxMaW5lICs9ICc7JztcbiAgICAgICAgICBydWxlcy5nZXQoc2VsZWN0b3IhKSEucHVzaChmdWxsTGluZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiAnJztcbiAgICB9KTtcblxuICAgIC8vIEpvaW4gbWVkaWEgcXVlcmllcyAmIGtleWZyYW1lc1xuICAgIHJ1bGVzLmZvckVhY2goKHZhbCwga2V5KSA9PiB7XG4gICAgICBjb25zdCBtYXRjaEFycmF5ID0ga2V5Lm1hdGNoKC8oQFteXFwke10qKD86XFwke1tee10qKSopey8pO1xuICAgICAgaWYgKG1hdGNoQXJyYXkpIHtcbiAgICAgICAgY29uc3QgbWVkaWEgPSBtYXRjaEFycmF5WzFdO1xuICAgICAgICBpZiAobWVkaWEgIT09IGtleSAmJiB2YWwubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgYWZ0ZXIgPSBydWxlcy5nZXQobWVkaWEpITtcbiAgICAgICAgICBjb25zdCBzZWwgPSBrZXkucmVwbGFjZShtZWRpYSArICd7JywgJycpO1xuICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gYWZ0ZXIgKyB2YWwucmVkdWNlKChwcmV2aW91cywgY3VycmVudCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBsYXN0ID0gcHJldmlvdXNbcHJldmlvdXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAvLyBfX1JFQURZX18gaXMgYWRkZWQgdG8gYmUgaWdub3JlZCBieSBjb250ZW50LnN0YXJ0c1dpdGggKCcvICogPj4geHgnKVxuICAgICAgICAgICAgaWYgKGN1cnJlbnQuc3RhcnRzV2l0aCgnLyogPj4gZHMnKSkge1xuICAgICAgICAgICAgICBwcmV2aW91cy5wdXNoKCcvKiBfX1JFQURZX18gKi8nICsgY3VycmVudC5yZXBsYWNlKC9cXHxcXHxcXCZcXHxcXHwvZywgc2VsKSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQuc3RhcnRzV2l0aCgnLyogPj4gY2MnKSkge1xuICAgICAgICAgICAgICBwcmV2aW91cy5wdXNoKCcvKiBfX1JFQURZX18gKi8nICsgdHJhbnNmb3JtQ0MoY3VycmVudCwgc2VsKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsYXN0KSkge1xuICAgICAgICAgICAgICAgIGxhc3QucHVzaChjdXJyZW50KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwcmV2aW91cy5wdXNoKFtjdXJyZW50XSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2aW91cztcbiAgICAgICAgICB9LCBbXSBhcyAoc3RyaW5nIHwgc3RyaW5nW10pW10pXG4gICAgICAgICAgICAubWFwKGl0ZW0gPT4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGAke3NlbH17JHtpdGVtLmpvaW4oJycpfX1gIDogaXRlbSkuam9pbignJyk7XG4gICAgICAgICAgLy8gY29uc3QgbmV3VmFsdWUgPSBhZnRlclxuICAgICAgICAgIC8vICsgc2VsXG4gICAgICAgICAgLy8gKyBgeyR7dmFsLmpvaW4oJycpfX1gO1xuICAgICAgICAgIHJ1bGVzLnNldChtZWRpYSwgW25ld1ZhbHVlXSk7XG4gICAgICAgICAgcnVsZXMuZGVsZXRlKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBBcnJheS5mcm9tKHJ1bGVzLmVudHJpZXMoKSlcbiAgICAgIC5maWx0ZXIocnVsZSA9PiBydWxlWzFdKVxuICAgICAgLm1hcChydWxlID0+IHtcbiAgICAgICAgY29uc3Qgc2VsID0gcnVsZVswXTtcbiAgICAgICAgY29uc3QgY29udGVudHMgPSBydWxlWzFdO1xuICAgICAgICBjb25zdCBjc3M6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IGNvbnRlbnRSZW5kZXJlZDogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3Qgc2V0ID0gbmV3IFNldDxzdHJpbmdbXT4oKTtcblxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29udGVudHMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgY29uc3QgY29udGVudCA9IGNvbnRlbnRzW2luZGV4XTtcbiAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgaWYgKGNvbnRlbnQuc3RhcnRzV2l0aCgnLyogPj4gZHMnKSkge1xuICAgICAgICAgICAgICBjb250ZW50UmVuZGVyZWQucHVzaChjb250ZW50LnJlcGxhY2UoL1xcfFxcfFxcJlxcfFxcfC9nLCBzZWwpKTtcbiAgICAgICAgICAgICAgc2V0LmFkZChjb250ZW50UmVuZGVyZWQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZW50LnN0YXJ0c1dpdGgoJy8qID4+IGNjJykpIHtcbiAgICAgICAgICAgICAgY29udGVudFJlbmRlcmVkLnB1c2godHJhbnNmb3JtQ0MoY29udGVudCwgc2VsKSk7XG4gICAgICAgICAgICAgIHNldC5hZGQoY29udGVudFJlbmRlcmVkKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIC8vIGNzcyArPSBgJHtzZWx9eyR7Y29udGVudH19YDtcbiAgICAgICAgICAgICAgY3NzLnB1c2goY29udGVudCk7XG4gICAgICAgICAgICAgIHNldC5hZGQoY3NzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20oc2V0KS5tYXAoKF8pID0+IHtcbiAgICAgICAgICBpZiAoXyA9PT0gY3NzKSB7XG4gICAgICAgICAgICByZXR1cm4gY3NzLmxlbmd0aFxuICAgICAgICAgICAgPyBgJHtzZWx9eyR7Y3NzLmpvaW4oJycpfX1gXG4gICAgICAgICAgICA6ICcnO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gXy5qb2luKCcnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLmpvaW4oJycpO1xuICAgICAgfSkuam9pbignJyk7XG5cbiAgfVxuXG4gIHByaXZhdGUgX3Jlc29sdmVTZWxlY3RvcnMoc2VsZWN0b3JzOiAoc3RyaW5nW10pW10pIHtcbiAgICBsZXQgbWVkaWE6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICAgIGNvbnN0IHNlbCA9IHNlbGVjdG9yc1xuICAgICAgLm1hcChfID0+IF8uZmlsdGVyKF9fID0+IHtcbiAgICAgICAgaWYgKF9fLnN0YXJ0c1dpdGgoJ0AnKSkge1xuICAgICAgICAgIC8vIHNhdmUgbWVkaWFcbiAgICAgICAgICBtZWRpYSA9IF9fO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gX187XG4gICAgICB9KSlcbiAgICAgIC5maWx0ZXIoXyA9PiBfLmxlbmd0aClcbiAgICAgIC5yZWR1Y2UoKHByZXYsIGN1cnJlbnQpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcHJldi5tYXAoaXRlbSA9PiBjdXJyZW50Lm1hcChjdSA9PiB7XG4gICAgICAgICAgaWYgKGN1LmluY2x1ZGVzKCcmJykpIHtcbiAgICAgICAgICAgIHJldHVybiBjdS5yZXBsYWNlKEFNUEVSU0FORF9SRUdFWCgpLCBpdGVtKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGAke2l0ZW19ICR7Y3V9YDtcbiAgICAgICAgfSkpO1xuICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgcmVzdWx0KTtcbiAgICAgIH0pXG4gICAgICAuam9pbignLCcpO1xuXG4gICAgaWYgKG1lZGlhKSB7XG4gICAgICByZXR1cm4gYCR7bWVkaWF9eyR7c2VsfWA7XG4gICAgfVxuICAgIHJldHVybiBzZWw7XG4gIH1cblxufVxuXG5mdW5jdGlvbiB0cmFuc2Zvcm1DQyhjb250ZW50OiBzdHJpbmcsIHNlbDogc3RyaW5nKSB7XG4gIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoL1xcL1xcKiA+PiBjY1teXFwvXFwqXStcXCpcXC8vZywgJycpO1xuICBsZXQgZXhwcmVzc2lvbiA9IGNvbnRlbnQuc2xpY2UoMiwgY29udGVudC5sZW5ndGggLSAxKTtcbiAgZXhwcmVzc2lvbiA9IGBzdDJjKCgke2V4cHJlc3Npb259KSwgXFxgJHtzZWx9XFxgKWA7XG4gIHJldHVybiBgXFwkeyR7ZXhwcmVzc2lvbn19YDtcbn1cblxuZXhwb3J0IHR5cGUgU3R5bGVUZW1wbGF0ZSA9IChjbGFzc05hbWU6IHN0cmluZykgPT4gc3RyaW5nO1xuXG5leHBvcnQgZnVuY3Rpb24gbHlsKGxpdGVyYWxzOiBUZW1wbGF0ZVN0cmluZ3NBcnJheSwgLi4ucGxhY2Vob2xkZXJzOiAoc3RyaW5nIHwgQ29sb3IgfCBTdHlsZUNvbGxlY3Rpb24gfCBudW1iZXIgfCBTdHlsZVRlbXBsYXRlIHwgbnVsbCB8IHVuZGVmaW5lZClbXSkge1xuICByZXR1cm4gKGNsYXNzTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgbGV0IHJlc3VsdCA9ICcnO1xuICAgIC8vIFNhdmUgZXhwcmVzc2lvbnNcbiAgICBjb25zdCBleE1hcDoge1trZXk6IHN0cmluZ106IHN0cmluZ30gPSB7fTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBsYWNlaG9sZGVycy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgcGxhY2Vob2xkZXIgPSBwbGFjZWhvbGRlcnNbaV07XG4gICAgICByZXN1bHQgKz0gbGl0ZXJhbHNbaV07XG4gICAgICBpZiAocmVzdWx0LmVuZHNXaXRoKCcuLi4nKSkge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoMCwgcmVzdWx0Lmxlbmd0aCAtIDMpO1xuICAgICAgICBpZiAodHlwZW9mIHBsYWNlaG9sZGVyID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgfHwgcGxhY2Vob2xkZXIgaW5zdGFuY2VvZiBTdHlsZUNvbGxlY3Rpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgcmVzdWx0ICs9IGAke2NyZWF0ZVVuaXF1ZUNvbW1lbnRTZWxlY3RvcignZHMnKX0ke3N0MmMocGxhY2Vob2xkZXIsICd8fCZ8fCcpfWA7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5ld0lEID0gYF9fTFlfRVhQUkVTU0lPTl9fW19fJHsoaWQrKykudG9TdHJpbmcoMzYpfV1gO1xuICAgICAgICByZXN1bHQgKz0gbmV3SUQ7XG4gICAgICAgIGV4TWFwW25ld0lEXSA9IGAke3BsYWNlaG9sZGVyfWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gYWRkIHRoZSBsYXN0IGxpdGVyYWxcbiAgICByZXN1bHQgKz0gbGl0ZXJhbHNbbGl0ZXJhbHMubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgY3NzID0gbmV3IEx5bFBhcnNlKHJlc3VsdCwgY2xhc3NOYW1lKS50b0NzcygpO1xuICAgIHJldHVybiBjc3MucmVwbGFjZShTVFlMRV9URU1QTEFURV9SRUdFWCgpLCAoc3RyKSA9PiB7XG4gICAgICBpZiAoc3RyIGluIGV4TWFwKSB7XG4gICAgICAgIHJldHVybiBleE1hcFtzdHJdO1xuICAgICAgfVxuICAgICAgcmV0dXJuICcnO1xuICAgIH0pO1xuICB9O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVVbmlxdWVDb21tZW50U2VsZWN0b3IodGV4dCA9ICdpZCcpIHtcbiAgcmV0dXJuIGAvKiA+PiAke3RleHR9IC0tICR7TWF0aC5mbG9vcihuZXcgRGF0ZSgpLnZhbHVlT2YoKSAqIE1hdGgucmFuZG9tKCkpLnRvU3RyaW5nKDM2KX0gKi9gO1xufVxuXG50eXBlIFRyYW5zZm9ybWVyPFQ+ID0gKHN0OiBUKSA9PiAoU3R5bGVUZW1wbGF0ZSk7XG5cbmV4cG9ydCBjbGFzcyBTdHlsZUNvbGxlY3Rpb248VCA9IGFueT4ge1xuICBwcml2YXRlIF90ZW1wbGF0ZXM6IChTdHlsZVRlbXBsYXRlIHwgVClbXTtcbiAgcHJpdmF0ZSBfdHJhbnNmb3JtZXI/OiBUcmFuc2Zvcm1lcjxUPjtcblxuICBjb25zdHJ1Y3RvciguLi50ZW1wbGF0ZXM6IChUKVtdKVxuICBjb25zdHJ1Y3RvciguLi50ZW1wbGF0ZXM6IChTdHlsZVRlbXBsYXRlIHwgVClbXSkge1xuICAgIHRoaXMuX3RlbXBsYXRlcyA9IHRlbXBsYXRlcztcbiAgICB0aGlzLmNzcyA9IHRoaXMuY3NzLmJpbmQodGhpcyk7XG4gIH1cblxuICBhZGQoLi4udGVtcGxhdGVzOiAoVClbXSk6IFN0eWxlQ29sbGVjdGlvbjxUPjtcbiAgYWRkKC4uLnRlbXBsYXRlczogKFN0eWxlVGVtcGxhdGUgfCBUKVtdKTogU3R5bGVDb2xsZWN0aW9uO1xuICBhZGQoLi4udGVtcGxhdGVzOiAoU3R5bGVUZW1wbGF0ZSB8IFQpW10pOiBTdHlsZUNvbGxlY3Rpb24gfCBTdHlsZUNvbGxlY3Rpb248VD4ge1xuICAgIC8vIHJldHVybiBuZXcgU3R5bGVDb2xsZWN0aW9uKC4uLlsuLi50aGlzLl90ZW1wbGF0ZXMsIC4uLnRlbXBsYXRlc10pO1xuICAgIHRoaXMuX3RlbXBsYXRlcy5wdXNoKC4uLnRlbXBsYXRlcyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogVHJhbnNmb3JtIHN0eWxlICovXG4gIHNldFRyYW5zZm9ybWVyKHRyYW5zZm9ybWVyOiBUcmFuc2Zvcm1lcjxUPikge1xuICAgIHRoaXMuX3RyYW5zZm9ybWVyID0gdHJhbnNmb3JtZXI7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiBTdHlsZVRlbXBsYXRlXG4gICAqIEBkb2NzLXByaXZhdGVcbiAgICovXG4gIGNzcyhjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGxldCBsaW4gPSAnJztcbiAgICBjb25zdCB0ZW1wbGF0ZXMgPSB0aGlzLl90ZW1wbGF0ZXM7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRlbXBsYXRlcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGxldCB0ZW1wbGF0ZTogU3R5bGVUZW1wbGF0ZTtcbiAgICAgIGlmICh0aGlzLl90cmFuc2Zvcm1lcikge1xuICAgICAgICB0ZW1wbGF0ZSA9ICgodGhpcy5fdHJhbnNmb3JtZXIodGVtcGxhdGVzW2luZGV4XSBhcyBUKSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGVtcGxhdGUgPSAodGVtcGxhdGVzW2luZGV4XSBhcyBTdHlsZVRlbXBsYXRlKTtcbiAgICAgIH1cbiAgICAgIGxpbiArPSB0ZW1wbGF0ZShjbGFzc05hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbGluO1xuICB9XG5cbn1cblxuLyoqXG4gKiBUcmFuc2Zvcm0gYSAuLi57c3R5bGV9IHRvIGNzc1xuICogRm9yIGludGVybmFsIHVzZSBwdXJwb3NlcyBvbmx5XG4gKiBAcGFyYW0gZm4gU3R5bGVUZW1wbGF0ZSBvciBTdHlsZUNvbGxlY3Rpb25cbiAqIEBwYXJhbSBjbGFzc05hbWUgY2xhc3MgbmFtZVxuICovXG5leHBvcnQgZnVuY3Rpb24gc3QyYyhcbiAgZm46IFN0eWxlVGVtcGxhdGUgfCBTdHlsZUNvbGxlY3Rpb24gfCBudWxsIHwgdW5kZWZpbmVkLFxuICBjbGFzc05hbWU6IHN0cmluZykge1xuICBpZiAoZm4gPT0gbnVsbCkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICBpZiAoZm4gaW5zdGFuY2VvZiBTdHlsZUNvbGxlY3Rpb24pIHtcbiAgICByZXR1cm4gZm4uY3NzKGNsYXNzTmFtZSk7XG4gIH1cbiAgcmV0dXJuIGZuKGNsYXNzTmFtZSk7XG59XG5cbi8vIGV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVTdHlsZVRlbXBsYXRlKFxuLy8gICBmbjogU3R5bGVUZW1wbGF0ZVxuLy8gICApIHtcbi8vICAgaWYgKGZuLmxlbmd0aCkge1xuLy8gICAgIHJldHVybiBmbiBhcyBTdHlsZVRlbXBsYXRlO1xuLy8gICB9IGVsc2Uge1xuLy8gICAgIHJldHVybiAoZm4gYXMgKCgpID0+IFN0eWxlVGVtcGxhdGUpKSgpO1xuLy8gICB9XG4vLyB9XG5cbmV4cG9ydCBjbGFzcyBTdHJpbmdJZEdlbmVyYXRvciB7XG4gIHByaXZhdGUgX2NoYXJzOiBzdHJpbmc7XG4gIHByaXZhdGUgX25leHRJZDogbnVtYmVyW107XG4gIGNvbnN0cnVjdG9yKGNoYXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6Jykge1xuICAgIHRoaXMuX2NoYXJzID0gY2hhcnM7XG4gICAgdGhpcy5fbmV4dElkID0gWzBdO1xuICB9XG5cbiAgbmV4dCgpIHtcbiAgICBjb25zdCByOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAoY29uc3QgY2hhciBvZiB0aGlzLl9uZXh0SWQpIHtcbiAgICAgIHIudW5zaGlmdCh0aGlzLl9jaGFyc1tjaGFyXSk7XG4gICAgfVxuICAgIHRoaXMuX2luY3JlbWVudCgpO1xuICAgIHJldHVybiByLmpvaW4oJycpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaW5jcmVtZW50KCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fbmV4dElkLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2YWwgPSArK3RoaXMuX25leHRJZFtpXTtcbiAgICAgIGlmICh2YWwgPj0gdGhpcy5fY2hhcnMubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuX25leHRJZFtpXSA9IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX25leHRJZC5wdXNoKDApO1xuICB9XG59XG4iXX0=