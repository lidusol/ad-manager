import { __decorate, __read, __spread } from "tslib";
import { ChangeDetectionStrategy, Component, EventEmitter, Input, Output } from '@angular/core';
import { FormControl, Validators } from '@angular/forms';
import { Criteria } from '../../enum/criteria.enum';
import { Colors } from '../../enum/colors.enum';
import { MatPasswordStrengthValidator } from '../../validator/mat-password-strength-validator';
import { RegExpValidator } from '../../validator/regexp.class';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/material/progress-bar';
var MatPasswordStrengthComponent = /** @class */ (function () {
    function MatPasswordStrengthComponent() {
        this.enableLengthRule = true;
        this.enableLowerCaseLetterRule = true;
        this.enableUpperCaseLetterRule = true;
        this.enableDigitRule = true;
        this.enableSpecialCharRule = true;
        this.min = 8;
        this.max = 30;
        this.warnThreshold = 21;
        this.accentThreshold = 81;
        this.onStrengthChanged = new EventEmitter();
        this.criteriaMap = new Map();
        // TO ACCESS VIA CONTENT CHILD
        this.passwordFormControl = new FormControl();
        this.passwordConfirmationFormControl = new FormControl();
        this.validatorsArray = [];
        this._strength = 0;
        this.matPasswordStrengthValidator = new MatPasswordStrengthValidator();
    }
    MatPasswordStrengthComponent.prototype.ngOnInit = function () {
        this.setRulesAndValidators();
        if (this.password) {
            this.calculatePasswordStrength();
        }
    };
    MatPasswordStrengthComponent.prototype.ngOnChanges = function (changes) {
        if ((changes.externalError && changes.externalError.firstChange) || changes.password.isFirstChange()) {
            return;
        }
        else if (changes.externalError && changes.externalError.currentValue) {
            this._color = Colors.warn;
            return;
        }
        else if (changes.password.previousValue === changes.password.currentValue && !changes.password.firstChange) {
            this.calculatePasswordStrength();
        }
        else {
            this.password && this.password.length > 0 ?
                this.calculatePasswordStrength() : this.reset();
        }
    };
    Object.defineProperty(MatPasswordStrengthComponent.prototype, "strength", {
        get: function () {
            return this._strength ? this._strength : 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MatPasswordStrengthComponent.prototype, "color", {
        get: function () {
            if (this._strength < this.warnThreshold) {
                return Colors.warn;
            }
            else if (this._strength < this.accentThreshold) {
                return Colors.accent;
            }
            else {
                return Colors.primary;
            }
        },
        enumerable: true,
        configurable: true
    });
    MatPasswordStrengthComponent.prototype._containAtLeastMinChars = function () {
        this.containAtLeastMinChars = this.password.length >= this.min;
        return this.containAtLeastMinChars;
    };
    MatPasswordStrengthComponent.prototype._containAtLeastOneLowerCaseLetter = function () {
        this.containAtLeastOneLowerCaseLetter =
            this.criteriaMap
                .get(Criteria.at_least_one_lower_case_char)
                .test(this.password);
        return this.containAtLeastOneLowerCaseLetter;
    };
    MatPasswordStrengthComponent.prototype._containAtLeastOneUpperCaseLetter = function () {
        this.containAtLeastOneUpperCaseLetter =
            this.criteriaMap
                .get(Criteria.at_least_one_upper_case_char)
                .test(this.password);
        return this.containAtLeastOneUpperCaseLetter;
    };
    MatPasswordStrengthComponent.prototype._containAtLeastOneDigit = function () {
        this.containAtLeastOneDigit =
            this.criteriaMap
                .get(Criteria.at_least_one_digit_char)
                .test(this.password);
        return this.containAtLeastOneDigit;
    };
    MatPasswordStrengthComponent.prototype._containAtLeastOneSpecialChar = function () {
        this.containAtLeastOneSpecialChar =
            this.criteriaMap
                .get(Criteria.at_least_one_special_char)
                .test(this.password);
        return this.containAtLeastOneSpecialChar;
    };
    MatPasswordStrengthComponent.prototype._containCustomChars = function () {
        this.containAtCustomChars =
            this.criteriaMap
                .get(Criteria.at_custom_chars)
                .test(this.password);
        return this.containAtCustomChars;
    };
    MatPasswordStrengthComponent.prototype.parseCustomValidatorsRegex = function (value) {
        if (value === void 0) { value = this.customValidator; }
        if (this.customValidator instanceof RegExp) {
            return this.customValidator;
        }
        else if (typeof this.customValidator === 'string') {
            return RegExp(this.customValidator);
        }
    };
    MatPasswordStrengthComponent.prototype.setRulesAndValidators = function () {
        var _this = this;
        this.validatorsArray = [];
        this.criteriaMap = new Map();
        this.passwordConfirmationFormControl
            .setValidators(Validators.compose([
            Validators.required, this.matPasswordStrengthValidator.confirm(this.password)
        ]));
        this.validatorsArray.push(Validators.required);
        if (this.enableLengthRule) {
            this.criteriaMap.set(Criteria.at_least_eight_chars, RegExp("^.{" + this.min + "," + this.max + "}$"));
            this.validatorsArray.push(Validators.minLength(this.min));
            this.validatorsArray.push(Validators.maxLength(this.max));
        }
        if (this.enableLowerCaseLetterRule) {
            this.criteriaMap.set(Criteria.at_least_one_lower_case_char, RegExpValidator.lowerCase);
            this.validatorsArray.push(Validators.pattern(RegExpValidator.lowerCase));
        }
        if (this.enableUpperCaseLetterRule) {
            this.criteriaMap.set(Criteria.at_least_one_upper_case_char, RegExpValidator.upperCase);
            this.validatorsArray.push(Validators.pattern(RegExpValidator.upperCase));
        }
        if (this.enableDigitRule) {
            this.criteriaMap.set(Criteria.at_least_one_digit_char, RegExpValidator.digit);
            this.validatorsArray.push(Validators.pattern(RegExpValidator.digit));
        }
        if (this.enableSpecialCharRule) {
            this.criteriaMap.set(Criteria.at_least_one_special_char, RegExpValidator.specialChar);
            this.validatorsArray.push(Validators.pattern(RegExpValidator.specialChar));
        }
        if (this.customValidator) {
            this.criteriaMap.set(Criteria.at_custom_chars, this.parseCustomValidatorsRegex());
            this.validatorsArray.push(Validators.pattern(this.parseCustomValidatorsRegex()));
        }
        this.criteriaMap.forEach(function (value, key) {
            _this.validatorsArray.push(_this.matPasswordStrengthValidator.validate(key, value));
        });
        this.passwordFormControl.setValidators(Validators.compose(__spread(this.validatorsArray)));
        this.Validators = Validators.compose(__spread(this.validatorsArray));
    };
    MatPasswordStrengthComponent.prototype.calculatePasswordStrength = function () {
        var requirements = [];
        var unit = 100 / this.criteriaMap.size;
        // console.log('this.criteriaMap.size = ', this.criteriaMap.size);
        // console.log('unit = ', unit);
        requirements.push(this.enableLengthRule ? this._containAtLeastMinChars() : false, this.enableLowerCaseLetterRule ? this._containAtLeastOneLowerCaseLetter() : false, this.enableUpperCaseLetterRule ? this._containAtLeastOneUpperCaseLetter() : false, this.enableDigitRule ? this._containAtLeastOneDigit() : false, this.enableSpecialCharRule ? this._containAtLeastOneSpecialChar() : false, this.customValidator ? this._containCustomChars() : false);
        this._strength = requirements.filter(function (v) { return v; }).length * unit;
        // console.log('length = ', this._strength / unit);
        this.onStrengthChanged.emit(this.strength);
        this.setRulesAndValidators();
    };
    MatPasswordStrengthComponent.prototype.reset = function () {
        this._strength = 0;
        this.containAtLeastMinChars =
            this.containAtLeastOneLowerCaseLetter =
                this.containAtLeastOneUpperCaseLetter =
                    this.containAtLeastOneDigit =
                        this.containAtCustomChars =
                            this.containAtLeastOneSpecialChar = false;
    };
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "password", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "externalError", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "enableLengthRule", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "enableLowerCaseLetterRule", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "enableUpperCaseLetterRule", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "enableDigitRule", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "enableSpecialCharRule", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "min", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "max", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "customValidator", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "warnThreshold", void 0);
    __decorate([
        Input()
    ], MatPasswordStrengthComponent.prototype, "accentThreshold", void 0);
    __decorate([
        Output()
    ], MatPasswordStrengthComponent.prototype, "onStrengthChanged", void 0);
MatPasswordStrengthComponent.ɵfac = function MatPasswordStrengthComponent_Factory(t) { return new (t || MatPasswordStrengthComponent)(); };
MatPasswordStrengthComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: MatPasswordStrengthComponent, selectors: [["mat-password-strength"]], inputs: { enableLengthRule: "enableLengthRule", enableLowerCaseLetterRule: "enableLowerCaseLetterRule", enableUpperCaseLetterRule: "enableUpperCaseLetterRule", enableDigitRule: "enableDigitRule", enableSpecialCharRule: "enableSpecialCharRule", min: "min", max: "max", warnThreshold: "warnThreshold", accentThreshold: "accentThreshold", password: "password", externalError: "externalError", customValidator: "customValidator" }, outputs: { onStrengthChanged: "onStrengthChanged" }, exportAs: ["matPasswordStrength"], features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 1, vars: 2, consts: [["mode", "determinate", 3, "color", "value"]], template: function MatPasswordStrengthComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelement(0, "mat-progress-bar", 0);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("color", ctx.color)("value", ctx.strength);
    } }, directives: [ɵngcc1.MatProgressBar], styles: [".green   [_nghost-%COMP%]  .mat-progress-bar.mat-primary .mat-progress-bar-fill::after{background-color:#43a047}"], changeDetection: 0 });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(MatPasswordStrengthComponent, [{
        type: Component,
        args: [{
                selector: 'mat-password-strength',
                exportAs: 'matPasswordStrength',
                template: "<mat-progress-bar mode=\"determinate\"\n                  [color]=\"color\"\n                  [value]=\"strength\">\n</mat-progress-bar>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".green :host::ng-deep .mat-progress-bar.mat-primary .mat-progress-bar-fill::after{background-color:#43a047}"]
            }]
    }], function () { return []; }, { enableLengthRule: [{
            type: Input
        }], enableLowerCaseLetterRule: [{
            type: Input
        }], enableUpperCaseLetterRule: [{
            type: Input
        }], enableDigitRule: [{
            type: Input
        }], enableSpecialCharRule: [{
            type: Input
        }], min: [{
            type: Input
        }], max: [{
            type: Input
        }], warnThreshold: [{
            type: Input
        }], accentThreshold: [{
            type: Input
        }], onStrengthChanged: [{
            type: Output
        }], password: [{
            type: Input
        }], externalError: [{
            type: Input
        }], customValidator: [{
            type: Input
        }] }); })();
    return MatPasswordStrengthComponent;
}());
export { MatPasswordStrengthComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0LXBhc3N3b3JkLXN0cmVuZ3RoLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L0Bhbmd1bGFyLW1hdGVyaWFsLWV4dGVuc2lvbnMvcGFzc3dvcmQtc3RyZW5ndGgvbGliL2NvbXBvbmVudC9tYXQtcGFzc3dvcmQtc3RyZW5ndGgvbWF0LXBhc3N3b3JkLXN0cmVuZ3RoLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLHVCQUF1QixFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQWdCLE1BQU0sZUFBZSxDQUFDO0FBQ2hJLE9BQU8sRUFBQyxXQUFXLEVBQWUsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEUsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQ2xELE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUM5QyxPQUFPLEVBQUMsNEJBQTRCLEVBQUMsTUFBTSxpREFBaUQsQ0FBQztBQUM3RixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sOEJBQThCLENBQUM7OztBQVc3RDtBQUFnRSxJQUFoRTtBQUEwQyxRQUsvQixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7QUFDbkMsUUFBVyw4QkFBeUIsR0FBRyxJQUFJLENBQUM7QUFDNUMsUUFBVyw4QkFBeUIsR0FBRyxJQUFJLENBQUM7QUFDNUMsUUFBVyxvQkFBZSxHQUFHLElBQUksQ0FBQztBQUNsQyxRQUFXLDBCQUFxQixHQUFHLElBQUksQ0FBQztBQUN4QyxRQUNXLFFBQUcsR0FBRyxDQUFDLENBQUM7QUFDbkIsUUFBVyxRQUFHLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLFFBRVcsa0JBQWEsR0FBRyxFQUFFLENBQUM7QUFDOUIsUUFBVyxvQkFBZSxHQUFHLEVBQUUsQ0FBQztBQUNoQyxRQUVFLHNCQUFpQixHQUF5QixJQUFJLFlBQVksRUFBRSxDQUFDO0FBQy9ELFFBQ0UsZ0JBQVcs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USxFQUFFO2tCQUFxQixjQUMvQix1SkFBcUQsY0FFckQsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU0sK0lBQ2hELENBQUMsUUFDVyw0QkFBNEIsQ0E4TXhDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUNEO0FBQUMsSUFERCxtQ0FBQztBQUNBLENBREEsQUE5TUQsSUE4TUM7QUFDRCxTQS9NYSw0QkFBNEI7QUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkluaXQsIE91dHB1dCwgU2ltcGxlQ2hhbmdlc30gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Zvcm1Db250cm9sLCBWYWxpZGF0b3JGbiwgVmFsaWRhdG9yc30gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtDcml0ZXJpYX0gZnJvbSAnLi4vLi4vZW51bS9jcml0ZXJpYS5lbnVtJztcbmltcG9ydCB7Q29sb3JzfSBmcm9tICcuLi8uLi9lbnVtL2NvbG9ycy5lbnVtJztcbmltcG9ydCB7TWF0UGFzc3dvcmRTdHJlbmd0aFZhbGlkYXRvcn0gZnJvbSAnLi4vLi4vdmFsaWRhdG9yL21hdC1wYXNzd29yZC1zdHJlbmd0aC12YWxpZGF0b3InO1xuaW1wb3J0IHtSZWdFeHBWYWxpZGF0b3J9IGZyb20gJy4uLy4uL3ZhbGlkYXRvci9yZWdleHAuY2xhc3MnO1xuaW1wb3J0IHtUaGVtZVBhbGV0dGV9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2NvcmUnO1xuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ21hdC1wYXNzd29yZC1zdHJlbmd0aCcsXG4gIGV4cG9ydEFzOiAnbWF0UGFzc3dvcmRTdHJlbmd0aCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9tYXQtcGFzc3dvcmQtc3RyZW5ndGguY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9tYXQtcGFzc3dvcmQtc3RyZW5ndGguY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgTWF0UGFzc3dvcmRTdHJlbmd0aENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICBASW5wdXQoKSBwYXNzd29yZDogc3RyaW5nO1xuICBASW5wdXQoKSBleHRlcm5hbEVycm9yOiBib29sZWFuO1xuXG4gIEBJbnB1dCgpIGVuYWJsZUxlbmd0aFJ1bGUgPSB0cnVlO1xuICBASW5wdXQoKSBlbmFibGVMb3dlckNhc2VMZXR0ZXJSdWxlID0gdHJ1ZTtcbiAgQElucHV0KCkgZW5hYmxlVXBwZXJDYXNlTGV0dGVyUnVsZSA9IHRydWU7XG4gIEBJbnB1dCgpIGVuYWJsZURpZ2l0UnVsZSA9IHRydWU7XG4gIEBJbnB1dCgpIGVuYWJsZVNwZWNpYWxDaGFyUnVsZSA9IHRydWU7XG5cbiAgQElucHV0KCkgbWluID0gODtcbiAgQElucHV0KCkgbWF4ID0gMzA7XG4gIEBJbnB1dCgpIGN1c3RvbVZhbGlkYXRvcjogUmVnRXhwO1xuXG4gIEBJbnB1dCgpIHdhcm5UaHJlc2hvbGQgPSAyMTtcbiAgQElucHV0KCkgYWNjZW50VGhyZXNob2xkID0gODE7XG5cbiAgQE91dHB1dCgpXG4gIG9uU3RyZW5ndGhDaGFuZ2VkOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjcml0ZXJpYU1hcCA9IG5ldyBNYXA8Q3JpdGVyaWEsIFJlZ0V4cD4oKTtcblxuICBjb250YWluQXRMZWFzdE1pbkNoYXJzOiBib29sZWFuO1xuICBjb250YWluQXRMZWFzdE9uZUxvd2VyQ2FzZUxldHRlcjogYm9vbGVhbjtcbiAgY29udGFpbkF0TGVhc3RPbmVVcHBlckNhc2VMZXR0ZXI6IGJvb2xlYW47XG4gIGNvbnRhaW5BdExlYXN0T25lRGlnaXQ6IGJvb2xlYW47XG4gIGNvbnRhaW5BdExlYXN0T25lU3BlY2lhbENoYXI6IGJvb2xlYW47XG4gIGNvbnRhaW5BdEN1c3RvbUNoYXJzOiBib29sZWFuO1xuXG4gIC8vIFRPIEFDQ0VTUyBWSUEgQ09OVEVOVCBDSElMRFxuICBwYXNzd29yZEZvcm1Db250cm9sOiBGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuICBwYXNzd29yZENvbmZpcm1hdGlvbkZvcm1Db250cm9sOiBGb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbCgpO1xuXG4gIHZhbGlkYXRvcnNBcnJheTogVmFsaWRhdG9yRm5bXSA9IFtdO1xuXG4gIHByaXZhdGUgX3N0cmVuZ3RoID0gMDtcbiAgcHJpdmF0ZSBfY29sb3I6IFRoZW1lUGFsZXR0ZTtcblxuICBWYWxpZGF0b3JzOiBWYWxpZGF0b3JGbjtcbiAgbWF0UGFzc3dvcmRTdHJlbmd0aFZhbGlkYXRvciA9IG5ldyBNYXRQYXNzd29yZFN0cmVuZ3RoVmFsaWRhdG9yKCk7XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5zZXRSdWxlc0FuZFZhbGlkYXRvcnMoKTtcblxuICAgIGlmICh0aGlzLnBhc3N3b3JkKSB7XG4gICAgICB0aGlzLmNhbGN1bGF0ZVBhc3N3b3JkU3RyZW5ndGgoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKChjaGFuZ2VzLmV4dGVybmFsRXJyb3IgJiYgY2hhbmdlcy5leHRlcm5hbEVycm9yLmZpcnN0Q2hhbmdlKSB8fCBjaGFuZ2VzLnBhc3N3b3JkLmlzRmlyc3RDaGFuZ2UoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAoY2hhbmdlcy5leHRlcm5hbEVycm9yICYmIGNoYW5nZXMuZXh0ZXJuYWxFcnJvci5jdXJyZW50VmFsdWUpIHtcbiAgICAgIHRoaXMuX2NvbG9yID0gQ29sb3JzLndhcm47XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzLnBhc3N3b3JkLnByZXZpb3VzVmFsdWUgPT09IGNoYW5nZXMucGFzc3dvcmQuY3VycmVudFZhbHVlICYmICFjaGFuZ2VzLnBhc3N3b3JkLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLmNhbGN1bGF0ZVBhc3N3b3JkU3RyZW5ndGgoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wYXNzd29yZCAmJiB0aGlzLnBhc3N3b3JkLmxlbmd0aCA+IDAgP1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZVBhc3N3b3JkU3RyZW5ndGgoKSA6IHRoaXMucmVzZXQoKTtcbiAgICB9XG4gIH1cblxuICBnZXQgc3RyZW5ndGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fc3RyZW5ndGggPyB0aGlzLl9zdHJlbmd0aCA6IDA7XG4gIH1cblxuICBnZXQgY29sb3IoKTogVGhlbWVQYWxldHRlIHtcblxuICAgIGlmICh0aGlzLl9zdHJlbmd0aCA8IHRoaXMud2FyblRocmVzaG9sZCkge1xuICAgICAgcmV0dXJuIENvbG9ycy53YXJuO1xuICAgIH0gZWxzZSBpZiAodGhpcy5fc3RyZW5ndGggPCB0aGlzLmFjY2VudFRocmVzaG9sZCkge1xuICAgICAgcmV0dXJuIENvbG9ycy5hY2NlbnQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBDb2xvcnMucHJpbWFyeTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9jb250YWluQXRMZWFzdE1pbkNoYXJzKCk6IGJvb2xlYW4ge1xuICAgIHRoaXMuY29udGFpbkF0TGVhc3RNaW5DaGFycyA9IHRoaXMucGFzc3dvcmQubGVuZ3RoID49IHRoaXMubWluO1xuICAgIHJldHVybiB0aGlzLmNvbnRhaW5BdExlYXN0TWluQ2hhcnM7XG4gIH1cblxuICBwcml2YXRlIF9jb250YWluQXRMZWFzdE9uZUxvd2VyQ2FzZUxldHRlcigpOiBib29sZWFuIHtcbiAgICB0aGlzLmNvbnRhaW5BdExlYXN0T25lTG93ZXJDYXNlTGV0dGVyID1cbiAgICAgIHRoaXMuY3JpdGVyaWFNYXBcbiAgICAgICAgLmdldChDcml0ZXJpYS5hdF9sZWFzdF9vbmVfbG93ZXJfY2FzZV9jaGFyKVxuICAgICAgICAudGVzdCh0aGlzLnBhc3N3b3JkKTtcbiAgICByZXR1cm4gdGhpcy5jb250YWluQXRMZWFzdE9uZUxvd2VyQ2FzZUxldHRlcjtcbiAgfVxuXG4gIHByaXZhdGUgX2NvbnRhaW5BdExlYXN0T25lVXBwZXJDYXNlTGV0dGVyKCk6IGJvb2xlYW4ge1xuICAgIHRoaXMuY29udGFpbkF0TGVhc3RPbmVVcHBlckNhc2VMZXR0ZXIgPVxuICAgICAgdGhpcy5jcml0ZXJpYU1hcFxuICAgICAgICAuZ2V0KENyaXRlcmlhLmF0X2xlYXN0X29uZV91cHBlcl9jYXNlX2NoYXIpXG4gICAgICAgIC50ZXN0KHRoaXMucGFzc3dvcmQpO1xuICAgIHJldHVybiB0aGlzLmNvbnRhaW5BdExlYXN0T25lVXBwZXJDYXNlTGV0dGVyO1xuICB9XG5cbiAgcHJpdmF0ZSBfY29udGFpbkF0TGVhc3RPbmVEaWdpdCgpOiBib29sZWFuIHtcbiAgICB0aGlzLmNvbnRhaW5BdExlYXN0T25lRGlnaXQgPVxuICAgICAgdGhpcy5jcml0ZXJpYU1hcFxuICAgICAgICAuZ2V0KENyaXRlcmlhLmF0X2xlYXN0X29uZV9kaWdpdF9jaGFyKVxuICAgICAgICAudGVzdCh0aGlzLnBhc3N3b3JkKTtcbiAgICByZXR1cm4gdGhpcy5jb250YWluQXRMZWFzdE9uZURpZ2l0O1xuICB9XG5cbiAgcHJpdmF0ZSBfY29udGFpbkF0TGVhc3RPbmVTcGVjaWFsQ2hhcigpOiBib29sZWFuIHtcbiAgICB0aGlzLmNvbnRhaW5BdExlYXN0T25lU3BlY2lhbENoYXIgPVxuICAgICAgdGhpcy5jcml0ZXJpYU1hcFxuICAgICAgICAuZ2V0KENyaXRlcmlhLmF0X2xlYXN0X29uZV9zcGVjaWFsX2NoYXIpXG4gICAgICAgIC50ZXN0KHRoaXMucGFzc3dvcmQpO1xuICAgIHJldHVybiB0aGlzLmNvbnRhaW5BdExlYXN0T25lU3BlY2lhbENoYXI7XG4gIH1cblxuICBwcml2YXRlIF9jb250YWluQ3VzdG9tQ2hhcnMoKTogYm9vbGVhbiB7XG4gICAgdGhpcy5jb250YWluQXRDdXN0b21DaGFycyA9XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwXG4gICAgICAgIC5nZXQoQ3JpdGVyaWEuYXRfY3VzdG9tX2NoYXJzKVxuICAgICAgICAudGVzdCh0aGlzLnBhc3N3b3JkKTtcbiAgICByZXR1cm4gdGhpcy5jb250YWluQXRDdXN0b21DaGFycztcbiAgfVxuXG4gIHBhcnNlQ3VzdG9tVmFsaWRhdG9yc1JlZ2V4KHZhbHVlOiBzdHJpbmcgfCBSZWdFeHAgPSB0aGlzLmN1c3RvbVZhbGlkYXRvcikge1xuICAgIGlmICh0aGlzLmN1c3RvbVZhbGlkYXRvciBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tVmFsaWRhdG9yO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMuY3VzdG9tVmFsaWRhdG9yID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIFJlZ0V4cCh0aGlzLmN1c3RvbVZhbGlkYXRvcik7XG4gICAgfVxuICB9XG5cbiAgc2V0UnVsZXNBbmRWYWxpZGF0b3JzKCk6IHZvaWQge1xuICAgIHRoaXMudmFsaWRhdG9yc0FycmF5ID0gW107XG4gICAgdGhpcy5jcml0ZXJpYU1hcCA9IG5ldyBNYXA8Q3JpdGVyaWEsIFJlZ0V4cD4oKTtcbiAgICB0aGlzLnBhc3N3b3JkQ29uZmlybWF0aW9uRm9ybUNvbnRyb2xcbiAgICAgIC5zZXRWYWxpZGF0b3JzKFZhbGlkYXRvcnMuY29tcG9zZShbXG4gICAgICAgIFZhbGlkYXRvcnMucmVxdWlyZWQsIHRoaXMubWF0UGFzc3dvcmRTdHJlbmd0aFZhbGlkYXRvci5jb25maXJtKHRoaXMucGFzc3dvcmQpXG4gICAgICBdKSk7XG4gICAgdGhpcy52YWxpZGF0b3JzQXJyYXkucHVzaChWYWxpZGF0b3JzLnJlcXVpcmVkKTtcbiAgICBpZiAodGhpcy5lbmFibGVMZW5ndGhSdWxlKSB7XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwLnNldChDcml0ZXJpYS5hdF9sZWFzdF9laWdodF9jaGFycywgUmVnRXhwKGBeLnske3RoaXMubWlufSwke3RoaXMubWF4fX0kYCkpO1xuICAgICAgdGhpcy52YWxpZGF0b3JzQXJyYXkucHVzaChWYWxpZGF0b3JzLm1pbkxlbmd0aCh0aGlzLm1pbikpO1xuICAgICAgdGhpcy52YWxpZGF0b3JzQXJyYXkucHVzaChWYWxpZGF0b3JzLm1heExlbmd0aCh0aGlzLm1heCkpO1xuICAgIH1cbiAgICBpZiAodGhpcy5lbmFibGVMb3dlckNhc2VMZXR0ZXJSdWxlKSB7XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwLnNldChDcml0ZXJpYS5hdF9sZWFzdF9vbmVfbG93ZXJfY2FzZV9jaGFyLCBSZWdFeHBWYWxpZGF0b3IubG93ZXJDYXNlKTtcbiAgICAgIHRoaXMudmFsaWRhdG9yc0FycmF5LnB1c2goVmFsaWRhdG9ycy5wYXR0ZXJuKFJlZ0V4cFZhbGlkYXRvci5sb3dlckNhc2UpKVxuICAgIH1cbiAgICBpZiAodGhpcy5lbmFibGVVcHBlckNhc2VMZXR0ZXJSdWxlKSB7XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwLnNldChDcml0ZXJpYS5hdF9sZWFzdF9vbmVfdXBwZXJfY2FzZV9jaGFyLCBSZWdFeHBWYWxpZGF0b3IudXBwZXJDYXNlKTtcbiAgICAgIHRoaXMudmFsaWRhdG9yc0FycmF5LnB1c2goVmFsaWRhdG9ycy5wYXR0ZXJuKFJlZ0V4cFZhbGlkYXRvci51cHBlckNhc2UpKVxuICAgIH1cbiAgICBpZiAodGhpcy5lbmFibGVEaWdpdFJ1bGUpIHtcbiAgICAgIHRoaXMuY3JpdGVyaWFNYXAuc2V0KENyaXRlcmlhLmF0X2xlYXN0X29uZV9kaWdpdF9jaGFyLCBSZWdFeHBWYWxpZGF0b3IuZGlnaXQpO1xuICAgICAgdGhpcy52YWxpZGF0b3JzQXJyYXkucHVzaChWYWxpZGF0b3JzLnBhdHRlcm4oUmVnRXhwVmFsaWRhdG9yLmRpZ2l0KSlcbiAgICB9XG4gICAgaWYgKHRoaXMuZW5hYmxlU3BlY2lhbENoYXJSdWxlKSB7XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwLnNldChDcml0ZXJpYS5hdF9sZWFzdF9vbmVfc3BlY2lhbF9jaGFyLCBSZWdFeHBWYWxpZGF0b3Iuc3BlY2lhbENoYXIpO1xuICAgICAgdGhpcy52YWxpZGF0b3JzQXJyYXkucHVzaChWYWxpZGF0b3JzLnBhdHRlcm4oUmVnRXhwVmFsaWRhdG9yLnNwZWNpYWxDaGFyKSlcbiAgICB9XG4gICAgaWYgKHRoaXMuY3VzdG9tVmFsaWRhdG9yKSB7XG4gICAgICB0aGlzLmNyaXRlcmlhTWFwLnNldChDcml0ZXJpYS5hdF9jdXN0b21fY2hhcnMsIHRoaXMucGFyc2VDdXN0b21WYWxpZGF0b3JzUmVnZXgoKSk7XG4gICAgICB0aGlzLnZhbGlkYXRvcnNBcnJheS5wdXNoKFZhbGlkYXRvcnMucGF0dGVybih0aGlzLnBhcnNlQ3VzdG9tVmFsaWRhdG9yc1JlZ2V4KCkpKVxuICAgIH1cblxuICAgIHRoaXMuY3JpdGVyaWFNYXAuZm9yRWFjaCgodmFsdWU6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdG9yc0FycmF5LnB1c2godGhpcy5tYXRQYXNzd29yZFN0cmVuZ3RoVmFsaWRhdG9yLnZhbGlkYXRlKGtleSwgdmFsdWUpKTtcbiAgICB9KTtcblxuICAgIHRoaXMucGFzc3dvcmRGb3JtQ29udHJvbC5zZXRWYWxpZGF0b3JzKFZhbGlkYXRvcnMuY29tcG9zZShbLi4udGhpcy52YWxpZGF0b3JzQXJyYXldKSk7XG4gICAgdGhpcy5WYWxpZGF0b3JzID0gVmFsaWRhdG9ycy5jb21wb3NlKFsuLi50aGlzLnZhbGlkYXRvcnNBcnJheV0pO1xuXG4gIH1cblxuICBjYWxjdWxhdGVQYXNzd29yZFN0cmVuZ3RoKCk6IHZvaWQge1xuICAgIGNvbnN0IHJlcXVpcmVtZW50czogQXJyYXk8Ym9vbGVhbj4gPSBbXTtcbiAgICBjb25zdCB1bml0ID0gMTAwIC8gdGhpcy5jcml0ZXJpYU1hcC5zaXplO1xuXG4gICAgLy8gY29uc29sZS5sb2coJ3RoaXMuY3JpdGVyaWFNYXAuc2l6ZSA9ICcsIHRoaXMuY3JpdGVyaWFNYXAuc2l6ZSk7XG4gICAgLy8gY29uc29sZS5sb2coJ3VuaXQgPSAnLCB1bml0KTtcblxuICAgIHJlcXVpcmVtZW50cy5wdXNoKFxuICAgICAgdGhpcy5lbmFibGVMZW5ndGhSdWxlID8gdGhpcy5fY29udGFpbkF0TGVhc3RNaW5DaGFycygpIDogZmFsc2UsXG4gICAgICB0aGlzLmVuYWJsZUxvd2VyQ2FzZUxldHRlclJ1bGUgPyB0aGlzLl9jb250YWluQXRMZWFzdE9uZUxvd2VyQ2FzZUxldHRlcigpIDogZmFsc2UsXG4gICAgICB0aGlzLmVuYWJsZVVwcGVyQ2FzZUxldHRlclJ1bGUgPyB0aGlzLl9jb250YWluQXRMZWFzdE9uZVVwcGVyQ2FzZUxldHRlcigpIDogZmFsc2UsXG4gICAgICB0aGlzLmVuYWJsZURpZ2l0UnVsZSA/IHRoaXMuX2NvbnRhaW5BdExlYXN0T25lRGlnaXQoKSA6IGZhbHNlLFxuICAgICAgdGhpcy5lbmFibGVTcGVjaWFsQ2hhclJ1bGUgPyB0aGlzLl9jb250YWluQXRMZWFzdE9uZVNwZWNpYWxDaGFyKCkgOiBmYWxzZSxcbiAgICAgIHRoaXMuY3VzdG9tVmFsaWRhdG9yID8gdGhpcy5fY29udGFpbkN1c3RvbUNoYXJzKCkgOiBmYWxzZVxuICAgICk7XG5cbiAgICB0aGlzLl9zdHJlbmd0aCA9IHJlcXVpcmVtZW50cy5maWx0ZXIodiA9PiB2KS5sZW5ndGggKiB1bml0O1xuICAgIC8vIGNvbnNvbGUubG9nKCdsZW5ndGggPSAnLCB0aGlzLl9zdHJlbmd0aCAvIHVuaXQpO1xuICAgIHRoaXMub25TdHJlbmd0aENoYW5nZWQuZW1pdCh0aGlzLnN0cmVuZ3RoKTtcbiAgICB0aGlzLnNldFJ1bGVzQW5kVmFsaWRhdG9ycygpO1xuICB9XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy5fc3RyZW5ndGggPSAwO1xuICAgIHRoaXMuY29udGFpbkF0TGVhc3RNaW5DaGFycyA9XG4gICAgICB0aGlzLmNvbnRhaW5BdExlYXN0T25lTG93ZXJDYXNlTGV0dGVyID1cbiAgICAgICAgdGhpcy5jb250YWluQXRMZWFzdE9uZVVwcGVyQ2FzZUxldHRlciA9XG4gICAgICAgICAgdGhpcy5jb250YWluQXRMZWFzdE9uZURpZ2l0ID1cbiAgICAgICAgICAgIHRoaXMuY29udGFpbkF0Q3VzdG9tQ2hhcnMgPVxuICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5BdExlYXN0T25lU3BlY2lhbENoYXIgPSBmYWxzZTtcbiAgfVxufVxuIl19