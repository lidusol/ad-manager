(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),exports, require('rxjs'), require('rxjs/operators'), require('@angular/core'), require('@angular/fire'), require('firebase/database')) :
    typeof define === 'function' && define.amd ? define(['@angular/core','exports', 'rxjs', 'rxjs/operators', '@angular/core', '@angular/fire', 'firebase/database'], factory) :
    (factory(global.ng.core,(global.angularfire2 = global.angularfire2 || {}, global.angularfire2.database = {}),global.rxjs,global.rxjs.operators,global.ng.core,global.angularfire2));
}(this, (function (ɵngcc0,exports,rxjs,operators,core,fire) { 'use strict';

    function isString(value) {
        return typeof value === 'string';
    }
    function isFirebaseDataSnapshot(value) {
        return typeof value.exportVal === 'function';
    }
    function isNil(obj) {
        return obj === undefined || obj === null;
    }
    function isFirebaseRef(value) {
        return typeof value.set === 'function';
    }
    function getRef(database$$1, pathRef) {
        return isFirebaseRef(pathRef) ? pathRef
            : database$$1.ref(pathRef);
    }
    function checkOperationCases(item, cases) {
        if (isString(item)) {
            return cases.stringCase();
        }
        else if (isFirebaseRef(item)) {
            return cases.firebaseCase();
        }
        else if (isFirebaseDataSnapshot(item)) {
            return cases.snapshotCase();
        }
        throw new Error("Expects a string, snapshot, or reference. Got: " + typeof item);
    }

    function fromRef(ref, event, listenType, scheduler) {
        if (listenType === void 0) { listenType = 'on'; }
        if (scheduler === void 0) { scheduler = rxjs.asyncScheduler; }
        return new rxjs.Observable(function (subscriber) {
            var fn = null;
            fn = ref[listenType](event, function (snapshot, prevKey) {
                scheduler.schedule(function () {
                    subscriber.next({ snapshot: snapshot, prevKey: prevKey });
                });
                if (listenType == 'once') {
                    scheduler.schedule(function () { return subscriber.complete(); });
                }
            }, function (err) {
                scheduler.schedule(function () { return subscriber.error(err); });
            });
            if (listenType == 'on') {
                return {
                    unsubscribe: function () {
                        if (fn != null) {
                            ref.off(event, fn);
                        }
                    }
                };
            }
            else {
                return { unsubscribe: function () { } };
            }
        }).pipe(operators.map(function (payload) {
            var snapshot = payload.snapshot, prevKey = payload.prevKey;
            var key = null;
            if (snapshot.exists()) {
                key = snapshot.key;
            }
            return { type: event, payload: snapshot, prevKey: prevKey, key: key };
        }), operators.share());
    }

    function listChanges(ref, events, scheduler) {
        return fromRef(ref, 'value', 'once', scheduler).pipe(operators.switchMap(function (snapshotAction) {
            var childEvent$ = [rxjs.of(snapshotAction)];
            events.forEach(function (event) { return childEvent$.push(fromRef(ref, event, 'on', scheduler)); });
            return rxjs.merge.apply(void 0, childEvent$).pipe(operators.scan(buildView, []));
        }), operators.distinctUntilChanged());
    }
    function positionFor(changes, key) {
        var len = changes.length;
        for (var i = 0; i < len; i++) {
            if (changes[i].payload.key === key) {
                return i;
            }
        }
        return -1;
    }
    function positionAfter(changes, prevKey) {
        if (isNil(prevKey)) {
            return 0;
        }
        else {
            var i = positionFor(changes, prevKey);
            if (i === -1) {
                return changes.length;
            }
            else {
                return i + 1;
            }
        }
    }
    function buildView(current, action) {
        var payload = action.payload, type = action.type, prevKey = action.prevKey, key = action.key;
        var currentKeyPosition = positionFor(current, key);
        var afterPreviousKeyPosition = positionAfter(current, prevKey);
        switch (action.type) {
            case 'value':
                if (action.payload && action.payload.exists()) {
                    var prevKey_1 = null;
                    action.payload.forEach(function (payload) {
                        var action = { payload: payload, type: 'value', prevKey: prevKey_1, key: payload.key };
                        prevKey_1 = payload.key;
                        current = current.concat([action]);
                        return false;
                    });
                }
                return current;
            case 'child_added':
                if (currentKeyPosition > -1) {
                    var previous = current[currentKeyPosition - 1];
                    if ((previous && previous.key || null) != prevKey) {
                        current = current.filter(function (x) { return x.payload.key !== payload.key; });
                        current.splice(afterPreviousKeyPosition, 0, action);
                    }
                }
                else if (prevKey == null) {
                    return [action].concat(current);
                }
                else {
                    current = current.slice();
                    current.splice(afterPreviousKeyPosition, 0, action);
                }
                return current;
            case 'child_removed':
                return current.filter(function (x) { return x.payload.key !== payload.key; });
            case 'child_changed':
                return current.map(function (x) { return x.payload.key === key ? action : x; });
            case 'child_moved':
                if (currentKeyPosition > -1) {
                    var data = current.splice(currentKeyPosition, 1)[0];
                    current = current.slice();
                    current.splice(afterPreviousKeyPosition, 0, data);
                    return current;
                }
                return current;
            default:
                return current;
        }
    }

    function validateEventsArray(events) {
        if (isNil(events) || events.length === 0) {
            events = ['child_added', 'child_removed', 'child_changed', 'child_moved'];
        }
        return events;
    }

    function snapshotChanges(query, events, scheduler) {
        events = validateEventsArray(events);
        return listChanges(query, events, scheduler);
    }

    function stateChanges(query, events, scheduler) {
        events = validateEventsArray(events);
        var childEvent$ = events.map(function (event) { return fromRef(query, event, 'on', scheduler); });
        return rxjs.merge.apply(void 0, childEvent$);
    }

    function auditTrail(query, events, scheduler) {
        var auditTrail$ = stateChanges(query, events)
            .pipe(operators.scan(function (current, action) { return current.concat([action]); }, []));
        return waitForLoaded(query, auditTrail$, scheduler);
    }
    function loadedData(query, scheduler) {
        return fromRef(query, 'value', 'on', scheduler)
            .pipe(operators.map(function (data) {
            var lastKeyToLoad;
            data.payload.forEach(function (child) {
                lastKeyToLoad = child.key;
                return false;
            });
            return { data: data, lastKeyToLoad: lastKeyToLoad };
        }));
    }
    function waitForLoaded(query, action$, scheduler) {
        var loaded$ = loadedData(query, scheduler);
        return loaded$
            .pipe(operators.withLatestFrom(action$), operators.map(function (_a) {
            var loaded = _a[0], actions = _a[1];
            var lastKeyToLoad = loaded.lastKeyToLoad;
            var loadedKeys = actions.map(function (snap) { return snap.key; });
            return { actions: actions, lastKeyToLoad: lastKeyToLoad, loadedKeys: loadedKeys };
        }), operators.skipWhile(function (meta) { return meta.loadedKeys.indexOf(meta.lastKeyToLoad) === -1; }), operators.map(function (meta) { return meta.actions; }));
    }

    function createDataOperationMethod(ref, operation) {
        return function dataOperation(item, value) {
            return checkOperationCases(item, {
                stringCase: function () { return ref.child(item)[operation](value); },
                firebaseCase: function () { return item[operation](value); },
                snapshotCase: function () { return item.ref[operation](value); }
            });
        };
    }

    function createRemoveMethod(ref) {
        return function remove(item) {
            if (!item) {
                return ref.remove();
            }
            return checkOperationCases(item, {
                stringCase: function () { return ref.child(item).remove(); },
                firebaseCase: function () { return item.remove(); },
                snapshotCase: function () { return item.ref.remove(); }
            });
        };
    }

    function createListReference(query, afDatabase) {
        var outsideAngularScheduler = afDatabase.schedulers.outsideAngular;
        return {
            query: query,
            update: createDataOperationMethod(query.ref, 'update'),
            set: createDataOperationMethod(query.ref, 'set'),
            push: function (data) { return query.ref.push(data); },
            remove: createRemoveMethod(query.ref),
            snapshotChanges: function (events) {
                return snapshotChanges(query, events, outsideAngularScheduler).pipe(afDatabase.keepUnstableUntilFirst);
            },
            stateChanges: function (events) {
                return stateChanges(query, events, outsideAngularScheduler).pipe(afDatabase.keepUnstableUntilFirst);
            },
            auditTrail: function (events) {
                return auditTrail(query, events, outsideAngularScheduler).pipe(afDatabase.keepUnstableUntilFirst);
            },
            valueChanges: function (events) {
                var snapshotChanges$ = snapshotChanges(query, events, outsideAngularScheduler);
                return snapshotChanges$.pipe(afDatabase.keepUnstableUntilFirst, operators.map(function (actions) { return actions.map(function (a) { return a.payload.val(); }); }));
            }
        };
    }

    function createObjectSnapshotChanges(query, scheduler) {
        return function snapshotChanges() {
            return fromRef(query, 'value', 'on', scheduler);
        };
    }

    function createObjectReference(query, afDatabase) {
        return {
            query: query,
            snapshotChanges: function () {
                return createObjectSnapshotChanges(query, afDatabase.schedulers.outsideAngular)().pipe(afDatabase.keepUnstableUntilFirst);
            },
            update: function (data) { return query.ref.update(data); },
            set: function (data) { return query.ref.set(data); },
            remove: function () { return query.ref.remove(); },
            valueChanges: function () {
                var snapshotChanges$ = createObjectSnapshotChanges(query, afDatabase.schedulers.outsideAngular)();
                return snapshotChanges$.pipe(afDatabase.keepUnstableUntilFirst, operators.map(function (action) { return action.payload.exists() ? action.payload.val() : null; }));
            },
        };
    }

    var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata = (undefined && undefined.__metadata) || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
        return function (target, key) { decorator(target, key, paramIndex); }
    };
    var AngularFireDatabase = (function () {
        function AngularFireDatabase(options, nameOrConfig, databaseURL, platformId, zone) {
            this.schedulers = new fire.ɵAngularFireSchedulers(zone);
            this.keepUnstableUntilFirst = fire.ɵkeepUnstableUntilFirstFactory(this.schedulers, platformId);
            this.database = zone.runOutsideAngular(function () {
                var app = fire._firebaseAppFactory(options, zone, nameOrConfig);
                return app.database(databaseURL || undefined);
            });
        }
        AngularFireDatabase.prototype.list = function (pathOrRef, queryFn) {
            var ref = getRef(this.database, pathOrRef);
            var query = ref;
            if (queryFn) {
                query = queryFn(ref);
            }
            return createListReference(query, this);
        };
        AngularFireDatabase.prototype.object = function (pathOrRef) {
            var ref = getRef(this.database, pathOrRef);
            return createObjectReference(ref, this);
        };
        AngularFireDatabase.prototype.createPushId = function () {
            return this.database.ref().push().key;
        };
        AngularFireDatabase = __decorate([ __param(0, core.Inject(fire.FIREBASE_OPTIONS)),
            __param(1, core.Optional()), __param(1, core.Inject(fire.FIREBASE_APP_NAME)),
            __param(2, core.Optional()), __param(2, core.Inject(fire.DATABASE_URL)),
            __param(3, core.Inject(core.PLATFORM_ID)),
            __metadata("design:paramtypes", [Object, Object, Object, Object,
                core.NgZone])
        ], AngularFireDatabase);
AngularFireDatabase.ɵfac = function AngularFireDatabase_Factory(t) { return new (t || AngularFireDatabase)(ɵngcc0.ɵɵinject(fire.FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(fire.FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(fire.DATABASE_URL, 8), ɵngcc0.ɵɵinject(core.PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
AngularFireDatabase.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: AngularFireDatabase, factory: function (t) { return AngularFireDatabase.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireDatabase, [{
        type: core.Injectable
    }], function () { return [{ type: Object, decorators: [{
                type: core.Inject,
                args: [fire.FIREBASE_OPTIONS]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [fire.FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [fire.DATABASE_URL]
            }] }, { type: Object, decorators: [{
                type: core.Inject,
                args: [core.PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }]; }, null); })();
        return AngularFireDatabase;
    }());

    var __decorate$1 = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var AngularFireDatabaseModule = (function () {
        function AngularFireDatabaseModule() {
        }
AngularFireDatabaseModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: AngularFireDatabaseModule });
AngularFireDatabaseModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function AngularFireDatabaseModule_Factory(t) { return new (t || AngularFireDatabaseModule)(); }, providers: [AngularFireDatabase] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireDatabaseModule, [{
        type: core.NgModule,
        args: [{
                providers: [AngularFireDatabase]
            }]
    }], function () { return []; }, null); })();
        return AngularFireDatabaseModule;
    }());

    exports.RealtimeDatabaseURL = fire.RealtimeDatabaseURL;
    exports.DATABASE_URL = fire.DATABASE_URL;
    exports.URL = fire.DATABASE_URL;
    exports.AngularFireDatabase = AngularFireDatabase;
    exports.listChanges = listChanges;
    exports.createListReference = createListReference;
    exports.snapshotChanges = snapshotChanges;
    exports.stateChanges = stateChanges;
    exports.auditTrail = auditTrail;
    exports.fromRef = fromRef;
    exports.AngularFireDatabaseModule = AngularFireDatabaseModule;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UudW1kLmpzIiwic291cmNlcyI6WyJkYXRhYmFzZS51bWQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxvR0FBMkU7QUFDM0UseUVBQXlEO0FBQ3pELDRCQUFhO0FBQ2IsMEJBQW1CO0FBQ25CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwwQ0FFVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzJEQUFnQztBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7O2dEQUtzQztBQUN0QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkge1xuICAgIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyA/IGZhY3RvcnkoZXhwb3J0cywgcmVxdWlyZSgncnhqcycpLCByZXF1aXJlKCdyeGpzL29wZXJhdG9ycycpLCByZXF1aXJlKCdAYW5ndWxhci9jb3JlJyksIHJlcXVpcmUoJ0Bhbmd1bGFyL2ZpcmUnKSwgcmVxdWlyZSgnZmlyZWJhc2UvZGF0YWJhc2UnKSkgOlxuICAgIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShbJ2V4cG9ydHMnLCAncnhqcycsICdyeGpzL29wZXJhdG9ycycsICdAYW5ndWxhci9jb3JlJywgJ0Bhbmd1bGFyL2ZpcmUnLCAnZmlyZWJhc2UvZGF0YWJhc2UnXSwgZmFjdG9yeSkgOlxuICAgIChmYWN0b3J5KChnbG9iYWwuYW5ndWxhcmZpcmUyID0gZ2xvYmFsLmFuZ3VsYXJmaXJlMiB8fCB7fSwgZ2xvYmFsLmFuZ3VsYXJmaXJlMi5kYXRhYmFzZSA9IHt9KSxnbG9iYWwucnhqcyxnbG9iYWwucnhqcy5vcGVyYXRvcnMsZ2xvYmFsLm5nLmNvcmUsZ2xvYmFsLmFuZ3VsYXJmaXJlMikpO1xufSh0aGlzLCAoZnVuY3Rpb24gKGV4cG9ydHMscnhqcyxvcGVyYXRvcnMsY29yZSxmaXJlKSB7ICd1c2Ugc3RyaWN0JztcblxuICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7XG4gICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnO1xuICAgIH1cbiAgICBmdW5jdGlvbiBpc0ZpcmViYXNlRGF0YVNuYXBzaG90KHZhbHVlKSB7XG4gICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUuZXhwb3J0VmFsID09PSAnZnVuY3Rpb24nO1xuICAgIH1cbiAgICBmdW5jdGlvbiBpc05pbChvYmopIHtcbiAgICAgICAgcmV0dXJuIG9iaiA9PT0gdW5kZWZpbmVkIHx8IG9iaiA9PT0gbnVsbDtcbiAgICB9XG4gICAgZnVuY3Rpb24gaXNGaXJlYmFzZVJlZih2YWx1ZSkge1xuICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlLnNldCA9PT0gJ2Z1bmN0aW9uJztcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0UmVmKGRhdGFiYXNlJCQxLCBwYXRoUmVmKSB7XG4gICAgICAgIHJldHVybiBpc0ZpcmViYXNlUmVmKHBhdGhSZWYpID8gcGF0aFJlZlxuICAgICAgICAgICAgOiBkYXRhYmFzZSQkMS5yZWYocGF0aFJlZik7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNoZWNrT3BlcmF0aW9uQ2FzZXMoaXRlbSwgY2FzZXMpIHtcbiAgICAgICAgaWYgKGlzU3RyaW5nKGl0ZW0pKSB7XG4gICAgICAgICAgICByZXR1cm4gY2FzZXMuc3RyaW5nQ2FzZSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGlzRmlyZWJhc2VSZWYoaXRlbSkpIHtcbiAgICAgICAgICAgIHJldHVybiBjYXNlcy5maXJlYmFzZUNhc2UoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChpc0ZpcmViYXNlRGF0YVNuYXBzaG90KGl0ZW0pKSB7XG4gICAgICAgICAgICByZXR1cm4gY2FzZXMuc25hcHNob3RDYXNlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXhwZWN0cyBhIHN0cmluZywgc25hcHNob3QsIG9yIHJlZmVyZW5jZS4gR290OiBcIiArIHR5cGVvZiBpdGVtKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBmcm9tUmVmKHJlZiwgZXZlbnQsIGxpc3RlblR5cGUsIHNjaGVkdWxlcikge1xuICAgICAgICBpZiAobGlzdGVuVHlwZSA9PT0gdm9pZCAwKSB7IGxpc3RlblR5cGUgPSAnb24nOyB9XG4gICAgICAgIGlmIChzY2hlZHVsZXIgPT09IHZvaWQgMCkgeyBzY2hlZHVsZXIgPSByeGpzLmFzeW5jU2NoZWR1bGVyOyB9XG4gICAgICAgIHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICB2YXIgZm4gPSBudWxsO1xuICAgICAgICAgICAgZm4gPSByZWZbbGlzdGVuVHlwZV0oZXZlbnQsIGZ1bmN0aW9uIChzbmFwc2hvdCwgcHJldktleSkge1xuICAgICAgICAgICAgICAgIHNjaGVkdWxlci5zY2hlZHVsZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZXIubmV4dCh7IHNuYXBzaG90OiBzbmFwc2hvdCwgcHJldktleTogcHJldktleSB9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAobGlzdGVuVHlwZSA9PSAnb25jZScpIHtcbiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyLnNjaGVkdWxlKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHN1YnNjcmliZXIuY29tcGxldGUoKTsgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIHNjaGVkdWxlci5zY2hlZHVsZShmdW5jdGlvbiAoKSB7IHJldHVybiBzdWJzY3JpYmVyLmVycm9yKGVycik7IH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAobGlzdGVuVHlwZSA9PSAnb24nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgdW5zdWJzY3JpYmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbiAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmLm9mZihldmVudCwgZm4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHVuc3Vic2NyaWJlOiBmdW5jdGlvbiAoKSB7IH0gfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkucGlwZShvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChwYXlsb2FkKSB7XG4gICAgICAgICAgICB2YXIgc25hcHNob3QgPSBwYXlsb2FkLnNuYXBzaG90LCBwcmV2S2V5ID0gcGF5bG9hZC5wcmV2S2V5O1xuICAgICAgICAgICAgdmFyIGtleSA9IG51bGw7XG4gICAgICAgICAgICBpZiAoc25hcHNob3QuZXhpc3RzKCkpIHtcbiAgICAgICAgICAgICAgICBrZXkgPSBzbmFwc2hvdC5rZXk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4geyB0eXBlOiBldmVudCwgcGF5bG9hZDogc25hcHNob3QsIHByZXZLZXk6IHByZXZLZXksIGtleToga2V5IH07XG4gICAgICAgIH0pLCBvcGVyYXRvcnMuc2hhcmUoKSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gbGlzdENoYW5nZXMocmVmLCBldmVudHMsIHNjaGVkdWxlcikge1xuICAgICAgICByZXR1cm4gZnJvbVJlZihyZWYsICd2YWx1ZScsICdvbmNlJywgc2NoZWR1bGVyKS5waXBlKG9wZXJhdG9ycy5zd2l0Y2hNYXAoZnVuY3Rpb24gKHNuYXBzaG90QWN0aW9uKSB7XG4gICAgICAgICAgICB2YXIgY2hpbGRFdmVudCQgPSBbcnhqcy5vZihzbmFwc2hvdEFjdGlvbildO1xuICAgICAgICAgICAgZXZlbnRzLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7IHJldHVybiBjaGlsZEV2ZW50JC5wdXNoKGZyb21SZWYocmVmLCBldmVudCwgJ29uJywgc2NoZWR1bGVyKSk7IH0pO1xuICAgICAgICAgICAgcmV0dXJuIHJ4anMubWVyZ2UuYXBwbHkodm9pZCAwLCBjaGlsZEV2ZW50JCkucGlwZShvcGVyYXRvcnMuc2NhbihidWlsZFZpZXcsIFtdKSk7XG4gICAgICAgIH0pLCBvcGVyYXRvcnMuZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHBvc2l0aW9uRm9yKGNoYW5nZXMsIGtleSkge1xuICAgICAgICB2YXIgbGVuID0gY2hhbmdlcy5sZW5ndGg7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgIGlmIChjaGFuZ2VzW2ldLnBheWxvYWQua2V5ID09PSBrZXkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHBvc2l0aW9uQWZ0ZXIoY2hhbmdlcywgcHJldktleSkge1xuICAgICAgICBpZiAoaXNOaWwocHJldktleSkpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIGkgPSBwb3NpdGlvbkZvcihjaGFuZ2VzLCBwcmV2S2V5KTtcbiAgICAgICAgICAgIGlmIChpID09PSAtMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjaGFuZ2VzLmxlbmd0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBpICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBidWlsZFZpZXcoY3VycmVudCwgYWN0aW9uKSB7XG4gICAgICAgIHZhciBwYXlsb2FkID0gYWN0aW9uLnBheWxvYWQsIHR5cGUgPSBhY3Rpb24udHlwZSwgcHJldktleSA9IGFjdGlvbi5wcmV2S2V5LCBrZXkgPSBhY3Rpb24ua2V5O1xuICAgICAgICB2YXIgY3VycmVudEtleVBvc2l0aW9uID0gcG9zaXRpb25Gb3IoY3VycmVudCwga2V5KTtcbiAgICAgICAgdmFyIGFmdGVyUHJldmlvdXNLZXlQb3NpdGlvbiA9IHBvc2l0aW9uQWZ0ZXIoY3VycmVudCwgcHJldktleSk7XG4gICAgICAgIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3ZhbHVlJzpcbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLnBheWxvYWQgJiYgYWN0aW9uLnBheWxvYWQuZXhpc3RzKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZLZXlfMSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLmZvckVhY2goZnVuY3Rpb24gKHBheWxvYWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB7IHBheWxvYWQ6IHBheWxvYWQsIHR5cGU6ICd2YWx1ZScsIHByZXZLZXk6IHByZXZLZXlfMSwga2V5OiBwYXlsb2FkLmtleSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldktleV8xID0gcGF5bG9hZC5rZXk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5jb25jYXQoW2FjdGlvbl0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICAgICAgICBjYXNlICdjaGlsZF9hZGRlZCc6XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRLZXlQb3NpdGlvbiA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91cyA9IGN1cnJlbnRbY3VycmVudEtleVBvc2l0aW9uIC0gMV07XG4gICAgICAgICAgICAgICAgICAgIGlmICgocHJldmlvdXMgJiYgcHJldmlvdXMua2V5IHx8IG51bGwpICE9IHByZXZLZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5wYXlsb2FkLmtleSAhPT0gcGF5bG9hZC5rZXk7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudC5zcGxpY2UoYWZ0ZXJQcmV2aW91c0tleVBvc2l0aW9uLCAwLCBhY3Rpb24pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZXZLZXkgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2FjdGlvbl0uY29uY2F0KGN1cnJlbnQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudC5zcGxpY2UoYWZ0ZXJQcmV2aW91c0tleVBvc2l0aW9uLCAwLCBhY3Rpb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICAgICAgICAgIGNhc2UgJ2NoaWxkX3JlbW92ZWQnOlxuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50LmZpbHRlcihmdW5jdGlvbiAoeCkgeyByZXR1cm4geC5wYXlsb2FkLmtleSAhPT0gcGF5bG9hZC5rZXk7IH0pO1xuICAgICAgICAgICAgY2FzZSAnY2hpbGRfY2hhbmdlZCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQubWFwKGZ1bmN0aW9uICh4KSB7IHJldHVybiB4LnBheWxvYWQua2V5ID09PSBrZXkgPyBhY3Rpb24gOiB4OyB9KTtcbiAgICAgICAgICAgIGNhc2UgJ2NoaWxkX21vdmVkJzpcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEtleVBvc2l0aW9uID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBjdXJyZW50LnNwbGljZShjdXJyZW50S2V5UG9zaXRpb24sIDEpWzBdO1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50LnNwbGljZShhZnRlclByZXZpb3VzS2V5UG9zaXRpb24sIDAsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdmFsaWRhdGVFdmVudHNBcnJheShldmVudHMpIHtcbiAgICAgICAgaWYgKGlzTmlsKGV2ZW50cykgfHwgZXZlbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgZXZlbnRzID0gWydjaGlsZF9hZGRlZCcsICdjaGlsZF9yZW1vdmVkJywgJ2NoaWxkX2NoYW5nZWQnLCAnY2hpbGRfbW92ZWQnXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXZlbnRzO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNuYXBzaG90Q2hhbmdlcyhxdWVyeSwgZXZlbnRzLCBzY2hlZHVsZXIpIHtcbiAgICAgICAgZXZlbnRzID0gdmFsaWRhdGVFdmVudHNBcnJheShldmVudHMpO1xuICAgICAgICByZXR1cm4gbGlzdENoYW5nZXMocXVlcnksIGV2ZW50cywgc2NoZWR1bGVyKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzdGF0ZUNoYW5nZXMocXVlcnksIGV2ZW50cywgc2NoZWR1bGVyKSB7XG4gICAgICAgIGV2ZW50cyA9IHZhbGlkYXRlRXZlbnRzQXJyYXkoZXZlbnRzKTtcbiAgICAgICAgdmFyIGNoaWxkRXZlbnQkID0gZXZlbnRzLm1hcChmdW5jdGlvbiAoZXZlbnQpIHsgcmV0dXJuIGZyb21SZWYocXVlcnksIGV2ZW50LCAnb24nLCBzY2hlZHVsZXIpOyB9KTtcbiAgICAgICAgcmV0dXJuIHJ4anMubWVyZ2UuYXBwbHkodm9pZCAwLCBjaGlsZEV2ZW50JCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gYXVkaXRUcmFpbChxdWVyeSwgZXZlbnRzLCBzY2hlZHVsZXIpIHtcbiAgICAgICAgdmFyIGF1ZGl0VHJhaWwkID0gc3RhdGVDaGFuZ2VzKHF1ZXJ5LCBldmVudHMpXG4gICAgICAgICAgICAucGlwZShvcGVyYXRvcnMuc2NhbihmdW5jdGlvbiAoY3VycmVudCwgYWN0aW9uKSB7IHJldHVybiBjdXJyZW50LmNvbmNhdChbYWN0aW9uXSk7IH0sIFtdKSk7XG4gICAgICAgIHJldHVybiB3YWl0Rm9yTG9hZGVkKHF1ZXJ5LCBhdWRpdFRyYWlsJCwgc2NoZWR1bGVyKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gbG9hZGVkRGF0YShxdWVyeSwgc2NoZWR1bGVyKSB7XG4gICAgICAgIHJldHVybiBmcm9tUmVmKHF1ZXJ5LCAndmFsdWUnLCAnb24nLCBzY2hlZHVsZXIpXG4gICAgICAgICAgICAucGlwZShvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICB2YXIgbGFzdEtleVRvTG9hZDtcbiAgICAgICAgICAgIGRhdGEucGF5bG9hZC5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkge1xuICAgICAgICAgICAgICAgIGxhc3RLZXlUb0xvYWQgPSBjaGlsZC5rZXk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4geyBkYXRhOiBkYXRhLCBsYXN0S2V5VG9Mb2FkOiBsYXN0S2V5VG9Mb2FkIH07XG4gICAgICAgIH0pKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gd2FpdEZvckxvYWRlZChxdWVyeSwgYWN0aW9uJCwgc2NoZWR1bGVyKSB7XG4gICAgICAgIHZhciBsb2FkZWQkID0gbG9hZGVkRGF0YShxdWVyeSwgc2NoZWR1bGVyKTtcbiAgICAgICAgcmV0dXJuIGxvYWRlZCRcbiAgICAgICAgICAgIC5waXBlKG9wZXJhdG9ycy53aXRoTGF0ZXN0RnJvbShhY3Rpb24kKSwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoX2EpIHtcbiAgICAgICAgICAgIHZhciBsb2FkZWQgPSBfYVswXSwgYWN0aW9ucyA9IF9hWzFdO1xuICAgICAgICAgICAgdmFyIGxhc3RLZXlUb0xvYWQgPSBsb2FkZWQubGFzdEtleVRvTG9hZDtcbiAgICAgICAgICAgIHZhciBsb2FkZWRLZXlzID0gYWN0aW9ucy5tYXAoZnVuY3Rpb24gKHNuYXApIHsgcmV0dXJuIHNuYXAua2V5OyB9KTtcbiAgICAgICAgICAgIHJldHVybiB7IGFjdGlvbnM6IGFjdGlvbnMsIGxhc3RLZXlUb0xvYWQ6IGxhc3RLZXlUb0xvYWQsIGxvYWRlZEtleXM6IGxvYWRlZEtleXMgfTtcbiAgICAgICAgfSksIG9wZXJhdG9ycy5za2lwV2hpbGUoZnVuY3Rpb24gKG1ldGEpIHsgcmV0dXJuIG1ldGEubG9hZGVkS2V5cy5pbmRleE9mKG1ldGEubGFzdEtleVRvTG9hZCkgPT09IC0xOyB9KSwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAobWV0YSkgeyByZXR1cm4gbWV0YS5hY3Rpb25zOyB9KSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY3JlYXRlRGF0YU9wZXJhdGlvbk1ldGhvZChyZWYsIG9wZXJhdGlvbikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGF0YU9wZXJhdGlvbihpdGVtLCB2YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGNoZWNrT3BlcmF0aW9uQ2FzZXMoaXRlbSwge1xuICAgICAgICAgICAgICAgIHN0cmluZ0Nhc2U6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHJlZi5jaGlsZChpdGVtKVtvcGVyYXRpb25dKHZhbHVlKTsgfSxcbiAgICAgICAgICAgICAgICBmaXJlYmFzZUNhc2U6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGl0ZW1bb3BlcmF0aW9uXSh2YWx1ZSk7IH0sXG4gICAgICAgICAgICAgICAgc25hcHNob3RDYXNlOiBmdW5jdGlvbiAoKSB7IHJldHVybiBpdGVtLnJlZltvcGVyYXRpb25dKHZhbHVlKTsgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY3JlYXRlUmVtb3ZlTWV0aG9kKHJlZikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gcmVtb3ZlKGl0ZW0pIHtcbiAgICAgICAgICAgIGlmICghaXRlbSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZWYucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gY2hlY2tPcGVyYXRpb25DYXNlcyhpdGVtLCB7XG4gICAgICAgICAgICAgICAgc3RyaW5nQ2FzZTogZnVuY3Rpb24gKCkgeyByZXR1cm4gcmVmLmNoaWxkKGl0ZW0pLnJlbW92ZSgpOyB9LFxuICAgICAgICAgICAgICAgIGZpcmViYXNlQ2FzZTogZnVuY3Rpb24gKCkgeyByZXR1cm4gaXRlbS5yZW1vdmUoKTsgfSxcbiAgICAgICAgICAgICAgICBzbmFwc2hvdENhc2U6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGl0ZW0ucmVmLnJlbW92ZSgpOyB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjcmVhdGVMaXN0UmVmZXJlbmNlKHF1ZXJ5LCBhZkRhdGFiYXNlKSB7XG4gICAgICAgIHZhciBvdXRzaWRlQW5ndWxhclNjaGVkdWxlciA9IGFmRGF0YWJhc2Uuc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhcjtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgICAgIHVwZGF0ZTogY3JlYXRlRGF0YU9wZXJhdGlvbk1ldGhvZChxdWVyeS5yZWYsICd1cGRhdGUnKSxcbiAgICAgICAgICAgIHNldDogY3JlYXRlRGF0YU9wZXJhdGlvbk1ldGhvZChxdWVyeS5yZWYsICdzZXQnKSxcbiAgICAgICAgICAgIHB1c2g6IGZ1bmN0aW9uIChkYXRhKSB7IHJldHVybiBxdWVyeS5yZWYucHVzaChkYXRhKTsgfSxcbiAgICAgICAgICAgIHJlbW92ZTogY3JlYXRlUmVtb3ZlTWV0aG9kKHF1ZXJ5LnJlZiksXG4gICAgICAgICAgICBzbmFwc2hvdENoYW5nZXM6IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc25hcHNob3RDaGFuZ2VzKHF1ZXJ5LCBldmVudHMsIG91dHNpZGVBbmd1bGFyU2NoZWR1bGVyKS5waXBlKGFmRGF0YWJhc2Uua2VlcFVuc3RhYmxlVW50aWxGaXJzdCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc3RhdGVDaGFuZ2VzOiBmdW5jdGlvbiAoZXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlQ2hhbmdlcyhxdWVyeSwgZXZlbnRzLCBvdXRzaWRlQW5ndWxhclNjaGVkdWxlcikucGlwZShhZkRhdGFiYXNlLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGF1ZGl0VHJhaWw6IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXVkaXRUcmFpbChxdWVyeSwgZXZlbnRzLCBvdXRzaWRlQW5ndWxhclNjaGVkdWxlcikucGlwZShhZkRhdGFiYXNlLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHZhbHVlQ2hhbmdlczogZnVuY3Rpb24gKGV2ZW50cykge1xuICAgICAgICAgICAgICAgIHZhciBzbmFwc2hvdENoYW5nZXMkID0gc25hcHNob3RDaGFuZ2VzKHF1ZXJ5LCBldmVudHMsIG91dHNpZGVBbmd1bGFyU2NoZWR1bGVyKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gc25hcHNob3RDaGFuZ2VzJC5waXBlKGFmRGF0YWJhc2Uua2VlcFVuc3RhYmxlVW50aWxGaXJzdCwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWN0aW9ucykgeyByZXR1cm4gYWN0aW9ucy5tYXAoZnVuY3Rpb24gKGEpIHsgcmV0dXJuIGEucGF5bG9hZC52YWwoKTsgfSk7IH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBjcmVhdGVPYmplY3RTbmFwc2hvdENoYW5nZXMocXVlcnksIHNjaGVkdWxlcikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gc25hcHNob3RDaGFuZ2VzKCkge1xuICAgICAgICAgICAgcmV0dXJuIGZyb21SZWYocXVlcnksICd2YWx1ZScsICdvbicsIHNjaGVkdWxlcik7XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY3JlYXRlT2JqZWN0UmVmZXJlbmNlKHF1ZXJ5LCBhZkRhdGFiYXNlKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBxdWVyeTogcXVlcnksXG4gICAgICAgICAgICBzbmFwc2hvdENoYW5nZXM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlT2JqZWN0U25hcHNob3RDaGFuZ2VzKHF1ZXJ5LCBhZkRhdGFiYXNlLnNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpKCkucGlwZShhZkRhdGFiYXNlLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHVwZGF0ZTogZnVuY3Rpb24gKGRhdGEpIHsgcmV0dXJuIHF1ZXJ5LnJlZi51cGRhdGUoZGF0YSk7IH0sXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIChkYXRhKSB7IHJldHVybiBxdWVyeS5yZWYuc2V0KGRhdGEpOyB9LFxuICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7IHJldHVybiBxdWVyeS5yZWYucmVtb3ZlKCk7IH0sXG4gICAgICAgICAgICB2YWx1ZUNoYW5nZXM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc25hcHNob3RDaGFuZ2VzJCA9IGNyZWF0ZU9iamVjdFNuYXBzaG90Q2hhbmdlcyhxdWVyeSwgYWZEYXRhYmFzZS5zY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzbmFwc2hvdENoYW5nZXMkLnBpcGUoYWZEYXRhYmFzZS5rZWVwVW5zdGFibGVVbnRpbEZpcnN0LCBvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChhY3Rpb24pIHsgcmV0dXJuIGFjdGlvbi5wYXlsb2FkLmV4aXN0cygpID8gYWN0aW9uLnBheWxvYWQudmFsKCkgOiBudWxsOyB9KSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHZhciBfX2RlY29yYXRlID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG4gICAgfTtcbiAgICB2YXIgX19tZXRhZGF0YSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fbWV0YWRhdGEpIHx8IGZ1bmN0aW9uIChrLCB2KSB7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5tZXRhZGF0YSA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gUmVmbGVjdC5tZXRhZGF0YShrLCB2KTtcbiAgICB9O1xuICAgIHZhciBfX3BhcmFtID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbiAgICB9O1xuICAgIHZhciBBbmd1bGFyRmlyZURhdGFiYXNlID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZnVuY3Rpb24gQW5ndWxhckZpcmVEYXRhYmFzZShvcHRpb25zLCBuYW1lT3JDb25maWcsIGRhdGFiYXNlVVJMLCBwbGF0Zm9ybUlkLCB6b25lKSB7XG4gICAgICAgICAgICB0aGlzLnNjaGVkdWxlcnMgPSBuZXcgZmlyZS7JtUFuZ3VsYXJGaXJlU2NoZWR1bGVycyh6b25lKTtcbiAgICAgICAgICAgIHRoaXMua2VlcFVuc3RhYmxlVW50aWxGaXJzdCA9IGZpcmUuybVrZWVwVW5zdGFibGVVbnRpbEZpcnN0RmFjdG9yeSh0aGlzLnNjaGVkdWxlcnMsIHBsYXRmb3JtSWQpO1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZSA9IHpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBhcHAgPSBmaXJlLl9maXJlYmFzZUFwcEZhY3Rvcnkob3B0aW9ucywgem9uZSwgbmFtZU9yQ29uZmlnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXBwLmRhdGFiYXNlKGRhdGFiYXNlVVJMIHx8IHVuZGVmaW5lZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZURhdGFiYXNlLnByb3RvdHlwZS5saXN0ID0gZnVuY3Rpb24gKHBhdGhPclJlZiwgcXVlcnlGbikge1xuICAgICAgICAgICAgdmFyIHJlZiA9IGdldFJlZih0aGlzLmRhdGFiYXNlLCBwYXRoT3JSZWYpO1xuICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gcmVmO1xuICAgICAgICAgICAgaWYgKHF1ZXJ5Rm4pIHtcbiAgICAgICAgICAgICAgICBxdWVyeSA9IHF1ZXJ5Rm4ocmVmKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjcmVhdGVMaXN0UmVmZXJlbmNlKHF1ZXJ5LCB0aGlzKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVEYXRhYmFzZS5wcm90b3R5cGUub2JqZWN0ID0gZnVuY3Rpb24gKHBhdGhPclJlZikge1xuICAgICAgICAgICAgdmFyIHJlZiA9IGdldFJlZih0aGlzLmRhdGFiYXNlLCBwYXRoT3JSZWYpO1xuICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZU9iamVjdFJlZmVyZW5jZShyZWYsIHRoaXMpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZURhdGFiYXNlLnByb3RvdHlwZS5jcmVhdGVQdXNoSWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhYmFzZS5yZWYoKS5wdXNoKCkua2V5O1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZURhdGFiYXNlID0gX19kZWNvcmF0ZShbXG4gICAgICAgICAgICBjb3JlLkluamVjdGFibGUoKSxcbiAgICAgICAgICAgIF9fcGFyYW0oMCwgY29yZS5JbmplY3QoZmlyZS5GSVJFQkFTRV9PUFRJT05TKSksXG4gICAgICAgICAgICBfX3BhcmFtKDEsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMSwgY29yZS5JbmplY3QoZmlyZS5GSVJFQkFTRV9BUFBfTkFNRSkpLFxuICAgICAgICAgICAgX19wYXJhbSgyLCBjb3JlLk9wdGlvbmFsKCkpLCBfX3BhcmFtKDIsIGNvcmUuSW5qZWN0KGZpcmUuREFUQUJBU0VfVVJMKSksXG4gICAgICAgICAgICBfX3BhcmFtKDMsIGNvcmUuSW5qZWN0KGNvcmUuUExBVEZPUk1fSUQpKSxcbiAgICAgICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246cGFyYW10eXBlc1wiLCBbT2JqZWN0LCBPYmplY3QsIE9iamVjdCwgT2JqZWN0LFxuICAgICAgICAgICAgICAgIGNvcmUuTmdab25lXSlcbiAgICAgICAgXSwgQW5ndWxhckZpcmVEYXRhYmFzZSk7XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZURhdGFiYXNlO1xuICAgIH0oKSk7XG5cbiAgICB2YXIgX19kZWNvcmF0ZSQxID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG4gICAgfTtcbiAgICB2YXIgQW5ndWxhckZpcmVEYXRhYmFzZU1vZHVsZSA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGZ1bmN0aW9uIEFuZ3VsYXJGaXJlRGF0YWJhc2VNb2R1bGUoKSB7XG4gICAgICAgIH1cbiAgICAgICAgQW5ndWxhckZpcmVEYXRhYmFzZU1vZHVsZSA9IF9fZGVjb3JhdGUkMShbXG4gICAgICAgICAgICBjb3JlLk5nTW9kdWxlKHtcbiAgICAgICAgICAgICAgICBwcm92aWRlcnM6IFtBbmd1bGFyRmlyZURhdGFiYXNlXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgXSwgQW5ndWxhckZpcmVEYXRhYmFzZU1vZHVsZSk7XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZURhdGFiYXNlTW9kdWxlO1xuICAgIH0oKSk7XG5cbiAgICBleHBvcnRzLlJlYWx0aW1lRGF0YWJhc2VVUkwgPSBmaXJlLlJlYWx0aW1lRGF0YWJhc2VVUkw7XG4gICAgZXhwb3J0cy5EQVRBQkFTRV9VUkwgPSBmaXJlLkRBVEFCQVNFX1VSTDtcbiAgICBleHBvcnRzLlVSTCA9IGZpcmUuREFUQUJBU0VfVVJMO1xuICAgIGV4cG9ydHMuQW5ndWxhckZpcmVEYXRhYmFzZSA9IEFuZ3VsYXJGaXJlRGF0YWJhc2U7XG4gICAgZXhwb3J0cy5saXN0Q2hhbmdlcyA9IGxpc3RDaGFuZ2VzO1xuICAgIGV4cG9ydHMuY3JlYXRlTGlzdFJlZmVyZW5jZSA9IGNyZWF0ZUxpc3RSZWZlcmVuY2U7XG4gICAgZXhwb3J0cy5zbmFwc2hvdENoYW5nZXMgPSBzbmFwc2hvdENoYW5nZXM7XG4gICAgZXhwb3J0cy5zdGF0ZUNoYW5nZXMgPSBzdGF0ZUNoYW5nZXM7XG4gICAgZXhwb3J0cy5hdWRpdFRyYWlsID0gYXVkaXRUcmFpbDtcbiAgICBleHBvcnRzLmZyb21SZWYgPSBmcm9tUmVmO1xuICAgIGV4cG9ydHMuQW5ndWxhckZpcmVEYXRhYmFzZU1vZHVsZSA9IEFuZ3VsYXJGaXJlRGF0YWJhc2VNb2R1bGU7XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pO1xuXG59KSkpO1xuIl19