(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),exports, require('rxjs'), require('rxjs/operators'), require('@angular/core'), require('@angular/fire'), require('@angular/common'), require('firebase/app'), require('firebase/firestore')) :
    typeof define === 'function' && define.amd ? define(['@angular/core','exports', 'rxjs', 'rxjs/operators', '@angular/core', '@angular/fire', '@angular/common', 'firebase/app', 'firebase/firestore'], factory) :
    (factory(global.ng.core,(global.angularfire2 = global.angularfire2 || {}, global.angularfire2.firestore = {}),global.rxjs,global.rxjs.operators,global.ng.core,global.angularfire2,global.ng.common,global.firebase));
}(this, (function (ɵngcc0,exports,rxjs,operators,core,fire,common,firebase) { 'use strict';

    firebase = firebase && firebase.hasOwnProperty('default') ? firebase['default'] : firebase;

    function _fromRef(ref, scheduler) {
        if (scheduler === void 0) { scheduler = rxjs.asyncScheduler; }
        return new rxjs.Observable(function (subscriber) {
            var unsubscribe;
            if (scheduler != null) {
                scheduler.schedule(function () {
                    unsubscribe = ref.onSnapshot(subscriber);
                });
            }
            else {
                unsubscribe = ref.onSnapshot(subscriber);
            }
            return function () {
                if (unsubscribe != null) {
                    unsubscribe();
                }
            };
        });
    }
    function fromRef(ref, scheduler) {
        return _fromRef(ref, scheduler);
    }
    function fromDocRef(ref, scheduler) {
        return fromRef(ref, scheduler)
            .pipe(operators.map(function (payload) { return ({ payload: payload, type: 'value' }); }));
    }
    function fromCollectionRef(ref, scheduler) {
        return fromRef(ref, scheduler).pipe(operators.map(function (payload) { return ({ payload: payload, type: 'query' }); }));
    }

    function docChanges(query, scheduler) {
        return fromCollectionRef(query, scheduler)
            .pipe(operators.map(function (action) {
            return action.payload.docChanges()
                .map(function (change) { return ({ type: change.type, payload: change }); });
        }));
    }
    function sortedChanges(query, events, scheduler) {
        return fromCollectionRef(query, scheduler)
            .pipe(operators.map(function (changes) { return changes.payload.docChanges(); }), operators.scan(function (current, changes) { return combineChanges(current, changes, events); }, []), operators.map(function (changes) { return changes.map(function (c) { return ({ type: c.type, payload: c }); }); }));
    }
    function combineChanges(current, changes, events) {
        changes.forEach(function (change) {
            if (events.indexOf(change.type) > -1) {
                current = combineChange(current, change);
            }
        });
        return current;
    }
    function combineChange(combined, change) {
        switch (change.type) {
            case 'added':
                if (combined[change.newIndex] && combined[change.newIndex].doc.ref.isEqual(change.doc.ref)) ;
                else {
                    combined.splice(change.newIndex, 0, change);
                }
                break;
            case 'modified':
                if (combined[change.oldIndex] == null || combined[change.oldIndex].doc.ref.isEqual(change.doc.ref)) {
                    if (change.oldIndex !== change.newIndex) {
                        combined.splice(change.oldIndex, 1);
                        combined.splice(change.newIndex, 0, change);
                    }
                    else {
                        combined.splice(change.newIndex, 1, change);
                    }
                }
                break;
            case 'removed':
                if (combined[change.oldIndex] && combined[change.oldIndex].doc.ref.isEqual(change.doc.ref)) {
                    combined.splice(change.oldIndex, 1);
                }
                break;
        }
        return combined;
    }

    var __assign = (undefined && undefined.__assign) || function () {
        __assign = Object.assign || function(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                    t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };
    function validateEventsArray(events) {
        if (!events || events.length === 0) {
            events = ['added', 'removed', 'modified'];
        }
        return events;
    }
    var AngularFirestoreCollection = (function () {
        function AngularFirestoreCollection(ref, query, afs) {
            this.ref = ref;
            this.query = query;
            this.afs = afs;
        }
        AngularFirestoreCollection.prototype.stateChanges = function (events) {
            if (!events || events.length === 0) {
                return docChanges(this.query, this.afs.schedulers.outsideAngular).pipe(this.afs.keepUnstableUntilFirst);
            }
            return docChanges(this.query, this.afs.schedulers.outsideAngular).pipe(this.afs.keepUnstableUntilFirst, operators.map(function (actions) { return actions.filter(function (change) { return events.indexOf(change.type) > -1; }); }), operators.filter(function (changes) { return changes.length > 0; }));
        };
        AngularFirestoreCollection.prototype.auditTrail = function (events) {
            return this.stateChanges(events).pipe(operators.scan(function (current, action) { return current.concat(action); }, []));
        };
        AngularFirestoreCollection.prototype.snapshotChanges = function (events) {
            var validatedEvents = validateEventsArray(events);
            var scheduledSortedChanges$ = sortedChanges(this.query, validatedEvents, this.afs.schedulers.outsideAngular);
            return scheduledSortedChanges$.pipe(this.afs.keepUnstableUntilFirst);
        };
        AngularFirestoreCollection.prototype.valueChanges = function (options) {
            if (options === void 0) { options = {}; }
            return fromCollectionRef(this.query, this.afs.schedulers.outsideAngular)
                .pipe(this.afs.keepUnstableUntilFirst, operators.map(function (actions) { return actions.payload.docs.map(function (a) {
                var _a;
                if (options.idField) {
                    return __assign({}, a.data(), (_a = {}, _a[options.idField] = a.id, _a));
                }
                else {
                    return a.data();
                }
            }); }));
        };
        AngularFirestoreCollection.prototype.get = function (options) {
            return rxjs.from(this.query.get(options)).pipe(operators.observeOn(this.afs.schedulers.insideAngular));
        };
        AngularFirestoreCollection.prototype.add = function (data) {
            return this.ref.add(data);
        };
        AngularFirestoreCollection.prototype.doc = function (path) {
            return new AngularFirestoreDocument(this.ref.doc(path), this.afs);
        };
        return AngularFirestoreCollection;
    }());

    var AngularFirestoreDocument = (function () {
        function AngularFirestoreDocument(ref, afs) {
            this.ref = ref;
            this.afs = afs;
        }
        AngularFirestoreDocument.prototype.set = function (data, options) {
            return this.ref.set(data, options);
        };
        AngularFirestoreDocument.prototype.update = function (data) {
            return this.ref.update(data);
        };
        AngularFirestoreDocument.prototype.delete = function () {
            return this.ref.delete();
        };
        AngularFirestoreDocument.prototype.collection = function (path, queryFn) {
            var collectionRef = this.ref.collection(path);
            var _a = associateQuery(collectionRef, queryFn), ref = _a.ref, query = _a.query;
            return new AngularFirestoreCollection(ref, query, this.afs);
        };
        AngularFirestoreDocument.prototype.snapshotChanges = function () {
            var scheduledFromDocRef$ = fromDocRef(this.ref, this.afs.schedulers.outsideAngular);
            return scheduledFromDocRef$.pipe(this.afs.keepUnstableUntilFirst);
        };
        AngularFirestoreDocument.prototype.valueChanges = function () {
            return this.snapshotChanges().pipe(operators.map(function (action) {
                return action.payload.data();
            }));
        };
        AngularFirestoreDocument.prototype.get = function (options) {
            return rxjs.from(this.ref.get(options)).pipe(operators.observeOn(this.afs.schedulers.insideAngular));
        };
        return AngularFirestoreDocument;
    }());

    var AngularFirestoreCollectionGroup = (function () {
        function AngularFirestoreCollectionGroup(query, afs) {
            this.query = query;
            this.afs = afs;
        }
        AngularFirestoreCollectionGroup.prototype.stateChanges = function (events) {
            if (!events || events.length === 0) {
                return docChanges(this.query, this.afs.schedulers.outsideAngular).pipe(this.afs.keepUnstableUntilFirst);
            }
            return docChanges(this.query, this.afs.schedulers.outsideAngular)
                .pipe(this.afs.keepUnstableUntilFirst, operators.map(function (actions) { return actions.filter(function (change) { return events.indexOf(change.type) > -1; }); }), operators.filter(function (changes) { return changes.length > 0; }));
        };
        AngularFirestoreCollectionGroup.prototype.auditTrail = function (events) {
            return this.stateChanges(events).pipe(operators.scan(function (current, action) { return current.concat(action); }, []));
        };
        AngularFirestoreCollectionGroup.prototype.snapshotChanges = function (events) {
            var validatedEvents = validateEventsArray(events);
            var scheduledSortedChanges$ = sortedChanges(this.query, validatedEvents, this.afs.schedulers.outsideAngular);
            return scheduledSortedChanges$.pipe(this.afs.keepUnstableUntilFirst);
        };
        AngularFirestoreCollectionGroup.prototype.valueChanges = function () {
            var fromCollectionRefScheduled$ = fromCollectionRef(this.query, this.afs.schedulers.outsideAngular);
            return fromCollectionRefScheduled$
                .pipe(this.afs.keepUnstableUntilFirst, operators.map(function (actions) { return actions.payload.docs.map(function (a) { return a.data(); }); }));
        };
        AngularFirestoreCollectionGroup.prototype.get = function (options) {
            return rxjs.from(this.query.get(options)).pipe(operators.observeOn(this.afs.schedulers.insideAngular));
        };
        return AngularFirestoreCollectionGroup;
    }());

    var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata = (undefined && undefined.__metadata) || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
        return function (target, key) { decorator(target, key, paramIndex); }
    };
    var EnablePersistenceToken = new core.InjectionToken('angularfire2.enableFirestorePersistence');
    var PersistenceSettingsToken = new core.InjectionToken('angularfire2.firestore.persistenceSettings');
    var FirestoreSettingsToken = new core.InjectionToken('angularfire2.firestore.settings');
    var ENABLE_PERSISTENCE = EnablePersistenceToken;
    var PERSISTENCE_SETTINGS = PersistenceSettingsToken;
    var SETTINGS = FirestoreSettingsToken;
    var major = parseInt(firebase.SDK_VERSION.split('.')[0]);
    var minor = parseInt(firebase.SDK_VERSION.split('.')[1]);
    var DefaultFirestoreSettings = ((major < 5 || (major == 5 && minor < 8)) ? { timestampsInSnapshots: true } : {});
    function associateQuery(collectionRef, queryFn) {
        if (queryFn === void 0) { queryFn = function (ref) { return ref; }; }
        var query = queryFn(collectionRef);
        var ref = collectionRef;
        return { query: query, ref: ref };
    }
    var AngularFirestore = (function () {
        function AngularFirestore(options, nameOrConfig, shouldEnablePersistence, settings, platformId, zone, persistenceSettings) {
            var _this = this;
            this.schedulers = new fire.ɵAngularFireSchedulers(zone);
            this.keepUnstableUntilFirst = fire.ɵkeepUnstableUntilFirstFactory(this.schedulers, platformId);
            this.firestore = zone.runOutsideAngular(function () {
                var app = fire._firebaseAppFactory(options, zone, nameOrConfig);
                var firestore$$1 = app.firestore();
                firestore$$1.settings(settings || DefaultFirestoreSettings);
                return firestore$$1;
            });
            if (shouldEnablePersistence && !common.isPlatformServer(platformId)) {
                var enablePersistence = function () {
                    try {
                        return rxjs.from(_this.firestore.enablePersistence(persistenceSettings || undefined).then(function () { return true; }, function () { return false; }));
                    }
                    catch (e) {
                        return rxjs.of(false);
                    }
                };
                this.persistenceEnabled$ = zone.runOutsideAngular(enablePersistence);
            }
            else {
                this.persistenceEnabled$ = rxjs.of(false);
            }
        }
        AngularFirestore.prototype.collection = function (pathOrRef, queryFn) {
            var collectionRef;
            if (typeof pathOrRef === 'string') {
                collectionRef = this.firestore.collection(pathOrRef);
            }
            else {
                collectionRef = pathOrRef;
            }
            var _a = associateQuery(collectionRef, queryFn), ref = _a.ref, query = _a.query;
            return new AngularFirestoreCollection(ref, query, this);
        };
        AngularFirestore.prototype.collectionGroup = function (collectionId, queryGroupFn) {
            if (major < 6) {
                throw "collection group queries require Firebase JS SDK >= 6.0";
            }
            var queryFn = queryGroupFn || (function (ref) { return ref; });
            var firestore$$1 = this.firestore;
            var collectionGroup = firestore$$1.collectionGroup(collectionId);
            return new AngularFirestoreCollectionGroup(queryFn(collectionGroup), this);
        };
        AngularFirestore.prototype.doc = function (pathOrRef) {
            var ref;
            if (typeof pathOrRef === 'string') {
                ref = this.firestore.doc(pathOrRef);
            }
            else {
                ref = pathOrRef;
            }
            return new AngularFirestoreDocument(ref, this);
        };
        AngularFirestore.prototype.createId = function () {
            return this.firestore.collection('_').doc().id;
        };
        AngularFirestore = __decorate([ __param(0, core.Inject(fire.FIREBASE_OPTIONS)),
            __param(1, core.Optional()), __param(1, core.Inject(fire.FIREBASE_APP_NAME)),
            __param(2, core.Optional()), __param(2, core.Inject(ENABLE_PERSISTENCE)),
            __param(3, core.Optional()), __param(3, core.Inject(SETTINGS)),
            __param(4, core.Inject(core.PLATFORM_ID)),
            __param(6, core.Optional()), __param(6, core.Inject(PERSISTENCE_SETTINGS)),
            __metadata("design:paramtypes", [Object, Object, Object, Object, Object,
                core.NgZone, Object])
        ], AngularFirestore);
AngularFirestore.ɵfac = function AngularFirestore_Factory(t) { return new (t || AngularFirestore)(ɵngcc0.ɵɵinject(fire.FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(fire.FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(ENABLE_PERSISTENCE, 8), ɵngcc0.ɵɵinject(SETTINGS, 8), ɵngcc0.ɵɵinject(core.PLATFORM_ID), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(PERSISTENCE_SETTINGS, 8)); };
AngularFirestore.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: AngularFirestore, factory: function (t) { return AngularFirestore.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFirestore, [{
        type: core.Injectable
    }], function () { return [{ type: Object, decorators: [{
                type: core.Inject,
                args: [fire.FIREBASE_OPTIONS]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [fire.FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [ENABLE_PERSISTENCE]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [SETTINGS]
            }] }, { type: Object, decorators: [{
                type: core.Inject,
                args: [core.PLATFORM_ID]
            }] }, { type: ɵngcc0.NgZone }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [PERSISTENCE_SETTINGS]
            }] }]; }, null); })();
        return AngularFirestore;
    }());

    var __decorate$1 = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var AngularFirestoreModule = (function () {
        function AngularFirestoreModule() {
        }
        AngularFirestoreModule_1 = AngularFirestoreModule;
        AngularFirestoreModule.enablePersistence = function (persistenceSettings) {
            return {
                ngModule: AngularFirestoreModule_1,
                providers: [
                    { provide: EnablePersistenceToken, useValue: true },
                    { provide: PersistenceSettingsToken, useValue: persistenceSettings },
                ]
            };
        };
        var AngularFirestoreModule_1;
AngularFirestoreModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: AngularFirestoreModule });
AngularFirestoreModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function AngularFirestoreModule_Factory(t) { return new (t || AngularFirestoreModule)(); }, providers: [AngularFirestore] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFirestoreModule, [{
        type: core.NgModule,
        args: [{
                providers: [AngularFirestore]
            }]
    }], function () { return []; }, null); })();
        return AngularFirestoreModule;
    }());

    exports.EnablePersistenceToken = EnablePersistenceToken;
    exports.PersistenceSettingsToken = PersistenceSettingsToken;
    exports.FirestoreSettingsToken = FirestoreSettingsToken;
    exports.ENABLE_PERSISTENCE = ENABLE_PERSISTENCE;
    exports.PERSISTENCE_SETTINGS = PERSISTENCE_SETTINGS;
    exports.SETTINGS = SETTINGS;
    exports.DefaultFirestoreSettings = DefaultFirestoreSettings;
    exports.associateQuery = associateQuery;
    exports.AngularFirestore = AngularFirestore;
    exports.AngularFirestoreModule = AngularFirestoreModule;
    exports.validateEventsArray = validateEventsArray;
    exports.AngularFirestoreCollection = AngularFirestoreCollection;
    exports.AngularFirestoreCollectionGroup = AngularFirestoreCollectionGroup;
    exports.AngularFirestoreDocument = AngularFirestoreDocument;
    exports.docChanges = docChanges;
    exports.sortedChanges = sortedChanges;
    exports.combineChanges = combineChanges;
    exports.combineChange = combineChange;
    exports.fromRef = fromRef;
    exports.fromDocRef = fromDocRef;
    exports.fromCollectionRef = fromCollectionRef;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlyZXN0b3JlLnVtZC5qcyIsInNvdXJjZXMiOlsiZmlyZXN0b3JlLnVtZC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBLG9HQUEyRTtBQUMzRSx5RUFBeUQ7QUFDekQsNEJBQWE7QUFDYiwwQkFBbUI7QUFDbkI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUVXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztrQ0FBNkI7QUFDN0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Z0RBS21DO0FBQ25DO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHtcbiAgICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBmYWN0b3J5KGV4cG9ydHMsIHJlcXVpcmUoJ3J4anMnKSwgcmVxdWlyZSgncnhqcy9vcGVyYXRvcnMnKSwgcmVxdWlyZSgnQGFuZ3VsYXIvY29yZScpLCByZXF1aXJlKCdAYW5ndWxhci9maXJlJyksIHJlcXVpcmUoJ0Bhbmd1bGFyL2NvbW1vbicpLCByZXF1aXJlKCdmaXJlYmFzZS9hcHAnKSwgcmVxdWlyZSgnZmlyZWJhc2UvZmlyZXN0b3JlJykpIDpcbiAgICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoWydleHBvcnRzJywgJ3J4anMnLCAncnhqcy9vcGVyYXRvcnMnLCAnQGFuZ3VsYXIvY29yZScsICdAYW5ndWxhci9maXJlJywgJ0Bhbmd1bGFyL2NvbW1vbicsICdmaXJlYmFzZS9hcHAnLCAnZmlyZWJhc2UvZmlyZXN0b3JlJ10sIGZhY3RvcnkpIDpcbiAgICAoZmFjdG9yeSgoZ2xvYmFsLmFuZ3VsYXJmaXJlMiA9IGdsb2JhbC5hbmd1bGFyZmlyZTIgfHwge30sIGdsb2JhbC5hbmd1bGFyZmlyZTIuZmlyZXN0b3JlID0ge30pLGdsb2JhbC5yeGpzLGdsb2JhbC5yeGpzLm9wZXJhdG9ycyxnbG9iYWwubmcuY29yZSxnbG9iYWwuYW5ndWxhcmZpcmUyLGdsb2JhbC5uZy5jb21tb24sZ2xvYmFsLmZpcmViYXNlKSk7XG59KHRoaXMsIChmdW5jdGlvbiAoZXhwb3J0cyxyeGpzLG9wZXJhdG9ycyxjb3JlLGZpcmUsY29tbW9uLGZpcmViYXNlKSB7ICd1c2Ugc3RyaWN0JztcblxuICAgIGZpcmViYXNlID0gZmlyZWJhc2UgJiYgZmlyZWJhc2UuaGFzT3duUHJvcGVydHkoJ2RlZmF1bHQnKSA/IGZpcmViYXNlWydkZWZhdWx0J10gOiBmaXJlYmFzZTtcblxuICAgIGZ1bmN0aW9uIF9mcm9tUmVmKHJlZiwgc2NoZWR1bGVyKSB7XG4gICAgICAgIGlmIChzY2hlZHVsZXIgPT09IHZvaWQgMCkgeyBzY2hlZHVsZXIgPSByeGpzLmFzeW5jU2NoZWR1bGVyOyB9XG4gICAgICAgIHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICB2YXIgdW5zdWJzY3JpYmU7XG4gICAgICAgICAgICBpZiAoc2NoZWR1bGVyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBzY2hlZHVsZXIuc2NoZWR1bGUoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB1bnN1YnNjcmliZSA9IHJlZi5vblNuYXBzaG90KHN1YnNjcmliZXIpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdW5zdWJzY3JpYmUgPSByZWYub25TbmFwc2hvdChzdWJzY3JpYmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHVuc3Vic2NyaWJlICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZnJvbVJlZihyZWYsIHNjaGVkdWxlcikge1xuICAgICAgICByZXR1cm4gX2Zyb21SZWYocmVmLCBzY2hlZHVsZXIpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmcm9tRG9jUmVmKHJlZiwgc2NoZWR1bGVyKSB7XG4gICAgICAgIHJldHVybiBmcm9tUmVmKHJlZiwgc2NoZWR1bGVyKVxuICAgICAgICAgICAgLnBpcGUob3BlcmF0b3JzLm1hcChmdW5jdGlvbiAocGF5bG9hZCkgeyByZXR1cm4gKHsgcGF5bG9hZDogcGF5bG9hZCwgdHlwZTogJ3ZhbHVlJyB9KTsgfSkpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBmcm9tQ29sbGVjdGlvblJlZihyZWYsIHNjaGVkdWxlcikge1xuICAgICAgICByZXR1cm4gZnJvbVJlZihyZWYsIHNjaGVkdWxlcikucGlwZShvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChwYXlsb2FkKSB7IHJldHVybiAoeyBwYXlsb2FkOiBwYXlsb2FkLCB0eXBlOiAncXVlcnknIH0pOyB9KSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZG9jQ2hhbmdlcyhxdWVyeSwgc2NoZWR1bGVyKSB7XG4gICAgICAgIHJldHVybiBmcm9tQ29sbGVjdGlvblJlZihxdWVyeSwgc2NoZWR1bGVyKVxuICAgICAgICAgICAgLnBpcGUob3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7XG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uLnBheWxvYWQuZG9jQ2hhbmdlcygpXG4gICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbiAoY2hhbmdlKSB7IHJldHVybiAoeyB0eXBlOiBjaGFuZ2UudHlwZSwgcGF5bG9hZDogY2hhbmdlIH0pOyB9KTtcbiAgICAgICAgfSkpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBzb3J0ZWRDaGFuZ2VzKHF1ZXJ5LCBldmVudHMsIHNjaGVkdWxlcikge1xuICAgICAgICByZXR1cm4gZnJvbUNvbGxlY3Rpb25SZWYocXVlcnksIHNjaGVkdWxlcilcbiAgICAgICAgICAgIC5waXBlKG9wZXJhdG9ycy5tYXAoZnVuY3Rpb24gKGNoYW5nZXMpIHsgcmV0dXJuIGNoYW5nZXMucGF5bG9hZC5kb2NDaGFuZ2VzKCk7IH0pLCBvcGVyYXRvcnMuc2NhbihmdW5jdGlvbiAoY3VycmVudCwgY2hhbmdlcykgeyByZXR1cm4gY29tYmluZUNoYW5nZXMoY3VycmVudCwgY2hhbmdlcywgZXZlbnRzKTsgfSwgW10pLCBvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChjaGFuZ2VzKSB7IHJldHVybiBjaGFuZ2VzLm1hcChmdW5jdGlvbiAoYykgeyByZXR1cm4gKHsgdHlwZTogYy50eXBlLCBwYXlsb2FkOiBjIH0pOyB9KTsgfSkpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBjb21iaW5lQ2hhbmdlcyhjdXJyZW50LCBjaGFuZ2VzLCBldmVudHMpIHtcbiAgICAgICAgY2hhbmdlcy5mb3JFYWNoKGZ1bmN0aW9uIChjaGFuZ2UpIHtcbiAgICAgICAgICAgIGlmIChldmVudHMuaW5kZXhPZihjaGFuZ2UudHlwZSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjb21iaW5lQ2hhbmdlKGN1cnJlbnQsIGNoYW5nZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICB9XG4gICAgZnVuY3Rpb24gY29tYmluZUNoYW5nZShjb21iaW5lZCwgY2hhbmdlKSB7XG4gICAgICAgIHN3aXRjaCAoY2hhbmdlLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ2FkZGVkJzpcbiAgICAgICAgICAgICAgICBpZiAoY29tYmluZWRbY2hhbmdlLm5ld0luZGV4XSAmJiBjb21iaW5lZFtjaGFuZ2UubmV3SW5kZXhdLmRvYy5yZWYuaXNFcXVhbChjaGFuZ2UuZG9jLnJlZikpIDtcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29tYmluZWQuc3BsaWNlKGNoYW5nZS5uZXdJbmRleCwgMCwgY2hhbmdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdtb2RpZmllZCc6XG4gICAgICAgICAgICAgICAgaWYgKGNvbWJpbmVkW2NoYW5nZS5vbGRJbmRleF0gPT0gbnVsbCB8fCBjb21iaW5lZFtjaGFuZ2Uub2xkSW5kZXhdLmRvYy5yZWYuaXNFcXVhbChjaGFuZ2UuZG9jLnJlZikpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5nZS5vbGRJbmRleCAhPT0gY2hhbmdlLm5ld0luZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21iaW5lZC5zcGxpY2UoY2hhbmdlLm9sZEluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkLnNwbGljZShjaGFuZ2UubmV3SW5kZXgsIDAsIGNoYW5nZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21iaW5lZC5zcGxpY2UoY2hhbmdlLm5ld0luZGV4LCAxLCBjaGFuZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncmVtb3ZlZCc6XG4gICAgICAgICAgICAgICAgaWYgKGNvbWJpbmVkW2NoYW5nZS5vbGRJbmRleF0gJiYgY29tYmluZWRbY2hhbmdlLm9sZEluZGV4XS5kb2MucmVmLmlzRXF1YWwoY2hhbmdlLmRvYy5yZWYpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbWJpbmVkLnNwbGljZShjaGFuZ2Uub2xkSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tYmluZWQ7XG4gICAgfVxuXG4gICAgdmFyIF9fYXNzaWduID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19hc3NpZ24pIHx8IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX19hc3NpZ24gPSBPYmplY3QuYXNzaWduIHx8IGZ1bmN0aW9uKHQpIHtcbiAgICAgICAgICAgIGZvciAodmFyIHMsIGkgPSAxLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG47IGkrKykge1xuICAgICAgICAgICAgICAgIHMgPSBhcmd1bWVudHNbaV07XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgcCBpbiBzKSBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHMsIHApKVxuICAgICAgICAgICAgICAgICAgICB0W3BdID0gc1twXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0O1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gX19hc3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXZlbnRzQXJyYXkoZXZlbnRzKSB7XG4gICAgICAgIGlmICghZXZlbnRzIHx8IGV2ZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGV2ZW50cyA9IFsnYWRkZWQnLCAncmVtb3ZlZCcsICdtb2RpZmllZCddO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBldmVudHM7XG4gICAgfVxuICAgIHZhciBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbiA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGZ1bmN0aW9uIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uKHJlZiwgcXVlcnksIGFmcykge1xuICAgICAgICAgICAgdGhpcy5yZWYgPSByZWY7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5ID0gcXVlcnk7XG4gICAgICAgICAgICB0aGlzLmFmcyA9IGFmcztcbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbi5wcm90b3R5cGUuc3RhdGVDaGFuZ2VzID0gZnVuY3Rpb24gKGV2ZW50cykge1xuICAgICAgICAgICAgaWYgKCFldmVudHMgfHwgZXZlbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkb2NDaGFuZ2VzKHRoaXMucXVlcnksIHRoaXMuYWZzLnNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpLnBpcGUodGhpcy5hZnMua2VlcFVuc3RhYmxlVW50aWxGaXJzdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9jQ2hhbmdlcyh0aGlzLnF1ZXJ5LCB0aGlzLmFmcy5zY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKS5waXBlKHRoaXMuYWZzLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QsIG9wZXJhdG9ycy5tYXAoZnVuY3Rpb24gKGFjdGlvbnMpIHsgcmV0dXJuIGFjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjaGFuZ2UpIHsgcmV0dXJuIGV2ZW50cy5pbmRleE9mKGNoYW5nZS50eXBlKSA+IC0xOyB9KTsgfSksIG9wZXJhdG9ycy5maWx0ZXIoZnVuY3Rpb24gKGNoYW5nZXMpIHsgcmV0dXJuIGNoYW5nZXMubGVuZ3RoID4gMDsgfSkpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbi5wcm90b3R5cGUuYXVkaXRUcmFpbCA9IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXRlQ2hhbmdlcyhldmVudHMpLnBpcGUob3BlcmF0b3JzLnNjYW4oZnVuY3Rpb24gKGN1cnJlbnQsIGFjdGlvbikgeyByZXR1cm4gY3VycmVudC5jb25jYXQoYWN0aW9uKTsgfSwgW10pKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb24ucHJvdG90eXBlLnNuYXBzaG90Q2hhbmdlcyA9IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRFdmVudHMgPSB2YWxpZGF0ZUV2ZW50c0FycmF5KGV2ZW50cyk7XG4gICAgICAgICAgICB2YXIgc2NoZWR1bGVkU29ydGVkQ2hhbmdlcyQgPSBzb3J0ZWRDaGFuZ2VzKHRoaXMucXVlcnksIHZhbGlkYXRlZEV2ZW50cywgdGhpcy5hZnMuc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhcik7XG4gICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVkU29ydGVkQ2hhbmdlcyQucGlwZSh0aGlzLmFmcy5rZWVwVW5zdGFibGVVbnRpbEZpcnN0KTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb24ucHJvdG90eXBlLnZhbHVlQ2hhbmdlcyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7IG9wdGlvbnMgPSB7fTsgfVxuICAgICAgICAgICAgcmV0dXJuIGZyb21Db2xsZWN0aW9uUmVmKHRoaXMucXVlcnksIHRoaXMuYWZzLnNjaGVkdWxlcnMub3V0c2lkZUFuZ3VsYXIpXG4gICAgICAgICAgICAgICAgLnBpcGUodGhpcy5hZnMua2VlcFVuc3RhYmxlVW50aWxGaXJzdCwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWN0aW9ucykgeyByZXR1cm4gYWN0aW9ucy5wYXlsb2FkLmRvY3MubWFwKGZ1bmN0aW9uIChhKSB7XG4gICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlkRmllbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9fYXNzaWduKHt9LCBhLmRhdGEoKSwgKF9hID0ge30sIF9hW29wdGlvbnMuaWRGaWVsZF0gPSBhLmlkLCBfYSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuZGF0YSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pOyB9KSk7XG4gICAgICAgIH07XG4gICAgICAgIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIHJ4anMuZnJvbSh0aGlzLnF1ZXJ5LmdldChvcHRpb25zKSkucGlwZShvcGVyYXRvcnMub2JzZXJ2ZU9uKHRoaXMuYWZzLnNjaGVkdWxlcnMuaW5zaWRlQW5ndWxhcikpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbi5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlZi5hZGQoZGF0YSk7XG4gICAgICAgIH07XG4gICAgICAgIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uLnByb3RvdHlwZS5kb2MgPSBmdW5jdGlvbiAocGF0aCkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBBbmd1bGFyRmlyZXN0b3JlRG9jdW1lbnQodGhpcy5yZWYuZG9jKHBhdGgpLCB0aGlzLmFmcyk7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbjtcbiAgICB9KCkpO1xuXG4gICAgdmFyIEFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudCA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGZ1bmN0aW9uIEFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudChyZWYsIGFmcykge1xuICAgICAgICAgICAgdGhpcy5yZWYgPSByZWY7XG4gICAgICAgICAgICB0aGlzLmFmcyA9IGFmcztcbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlRG9jdW1lbnQucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIChkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWYuc2V0KGRhdGEsIG9wdGlvbnMpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlRG9jdW1lbnQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWYudXBkYXRlKGRhdGEpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlRG9jdW1lbnQucHJvdG90eXBlLmRlbGV0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlZi5kZWxldGUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZURvY3VtZW50LnByb3RvdHlwZS5jb2xsZWN0aW9uID0gZnVuY3Rpb24gKHBhdGgsIHF1ZXJ5Rm4pIHtcbiAgICAgICAgICAgIHZhciBjb2xsZWN0aW9uUmVmID0gdGhpcy5yZWYuY29sbGVjdGlvbihwYXRoKTtcbiAgICAgICAgICAgIHZhciBfYSA9IGFzc29jaWF0ZVF1ZXJ5KGNvbGxlY3Rpb25SZWYsIHF1ZXJ5Rm4pLCByZWYgPSBfYS5yZWYsIHF1ZXJ5ID0gX2EucXVlcnk7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uKHJlZiwgcXVlcnksIHRoaXMuYWZzKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZURvY3VtZW50LnByb3RvdHlwZS5zbmFwc2hvdENoYW5nZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgc2NoZWR1bGVkRnJvbURvY1JlZiQgPSBmcm9tRG9jUmVmKHRoaXMucmVmLCB0aGlzLmFmcy5zY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKTtcbiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZWRGcm9tRG9jUmVmJC5waXBlKHRoaXMuYWZzLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlRG9jdW1lbnQucHJvdG90eXBlLnZhbHVlQ2hhbmdlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNuYXBzaG90Q2hhbmdlcygpLnBpcGUob3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkLmRhdGEoKTtcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZURvY3VtZW50LnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgcmV0dXJuIHJ4anMuZnJvbSh0aGlzLnJlZi5nZXQob3B0aW9ucykpLnBpcGUob3BlcmF0b3JzLm9ic2VydmVPbih0aGlzLmFmcy5zY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIEFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudDtcbiAgICB9KCkpO1xuXG4gICAgdmFyIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uR3JvdXAgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbkdyb3VwKHF1ZXJ5LCBhZnMpIHtcbiAgICAgICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeTtcbiAgICAgICAgICAgIHRoaXMuYWZzID0gYWZzO1xuICAgICAgICB9XG4gICAgICAgIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uR3JvdXAucHJvdG90eXBlLnN0YXRlQ2hhbmdlcyA9IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgIGlmICghZXZlbnRzIHx8IGV2ZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZG9jQ2hhbmdlcyh0aGlzLnF1ZXJ5LCB0aGlzLmFmcy5zY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKS5waXBlKHRoaXMuYWZzLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRvY0NoYW5nZXModGhpcy5xdWVyeSwgdGhpcy5hZnMuc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhcilcbiAgICAgICAgICAgICAgICAucGlwZSh0aGlzLmFmcy5rZWVwVW5zdGFibGVVbnRpbEZpcnN0LCBvcGVyYXRvcnMubWFwKGZ1bmN0aW9uIChhY3Rpb25zKSB7IHJldHVybiBhY3Rpb25zLmZpbHRlcihmdW5jdGlvbiAoY2hhbmdlKSB7IHJldHVybiBldmVudHMuaW5kZXhPZihjaGFuZ2UudHlwZSkgPiAtMTsgfSk7IH0pLCBvcGVyYXRvcnMuZmlsdGVyKGZ1bmN0aW9uIChjaGFuZ2VzKSB7IHJldHVybiBjaGFuZ2VzLmxlbmd0aCA+IDA7IH0pKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb25Hcm91cC5wcm90b3R5cGUuYXVkaXRUcmFpbCA9IGZ1bmN0aW9uIChldmVudHMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnN0YXRlQ2hhbmdlcyhldmVudHMpLnBpcGUob3BlcmF0b3JzLnNjYW4oZnVuY3Rpb24gKGN1cnJlbnQsIGFjdGlvbikgeyByZXR1cm4gY3VycmVudC5jb25jYXQoYWN0aW9uKTsgfSwgW10pKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb25Hcm91cC5wcm90b3R5cGUuc25hcHNob3RDaGFuZ2VzID0gZnVuY3Rpb24gKGV2ZW50cykge1xuICAgICAgICAgICAgdmFyIHZhbGlkYXRlZEV2ZW50cyA9IHZhbGlkYXRlRXZlbnRzQXJyYXkoZXZlbnRzKTtcbiAgICAgICAgICAgIHZhciBzY2hlZHVsZWRTb3J0ZWRDaGFuZ2VzJCA9IHNvcnRlZENoYW5nZXModGhpcy5xdWVyeSwgdmFsaWRhdGVkRXZlbnRzLCB0aGlzLmFmcy5zY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKTtcbiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZWRTb3J0ZWRDaGFuZ2VzJC5waXBlKHRoaXMuYWZzLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbkdyb3VwLnByb3RvdHlwZS52YWx1ZUNoYW5nZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgZnJvbUNvbGxlY3Rpb25SZWZTY2hlZHVsZWQkID0gZnJvbUNvbGxlY3Rpb25SZWYodGhpcy5xdWVyeSwgdGhpcy5hZnMuc2NoZWR1bGVycy5vdXRzaWRlQW5ndWxhcik7XG4gICAgICAgICAgICByZXR1cm4gZnJvbUNvbGxlY3Rpb25SZWZTY2hlZHVsZWQkXG4gICAgICAgICAgICAgICAgLnBpcGUodGhpcy5hZnMua2VlcFVuc3RhYmxlVW50aWxGaXJzdCwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWN0aW9ucykgeyByZXR1cm4gYWN0aW9ucy5wYXlsb2FkLmRvY3MubWFwKGZ1bmN0aW9uIChhKSB7IHJldHVybiBhLmRhdGEoKTsgfSk7IH0pKTtcbiAgICAgICAgfTtcbiAgICAgICAgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb25Hcm91cC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgICAgIHJldHVybiByeGpzLmZyb20odGhpcy5xdWVyeS5nZXQob3B0aW9ucykpLnBpcGUob3BlcmF0b3JzLm9ic2VydmVPbih0aGlzLmFmcy5zY2hlZHVsZXJzLmluc2lkZUFuZ3VsYXIpKTtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uR3JvdXA7XG4gICAgfSgpKTtcblxuICAgIHZhciBfX2RlY29yYXRlID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG4gICAgfTtcbiAgICB2YXIgX19tZXRhZGF0YSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fbWV0YWRhdGEpIHx8IGZ1bmN0aW9uIChrLCB2KSB7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5tZXRhZGF0YSA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gUmVmbGVjdC5tZXRhZGF0YShrLCB2KTtcbiAgICB9O1xuICAgIHZhciBfX3BhcmFtID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cbiAgICB9O1xuICAgIHZhciBFbmFibGVQZXJzaXN0ZW5jZVRva2VuID0gbmV3IGNvcmUuSW5qZWN0aW9uVG9rZW4oJ2FuZ3VsYXJmaXJlMi5lbmFibGVGaXJlc3RvcmVQZXJzaXN0ZW5jZScpO1xuICAgIHZhciBQZXJzaXN0ZW5jZVNldHRpbmdzVG9rZW4gPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLmZpcmVzdG9yZS5wZXJzaXN0ZW5jZVNldHRpbmdzJyk7XG4gICAgdmFyIEZpcmVzdG9yZVNldHRpbmdzVG9rZW4gPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLmZpcmVzdG9yZS5zZXR0aW5ncycpO1xuICAgIHZhciBFTkFCTEVfUEVSU0lTVEVOQ0UgPSBFbmFibGVQZXJzaXN0ZW5jZVRva2VuO1xuICAgIHZhciBQRVJTSVNURU5DRV9TRVRUSU5HUyA9IFBlcnNpc3RlbmNlU2V0dGluZ3NUb2tlbjtcbiAgICB2YXIgU0VUVElOR1MgPSBGaXJlc3RvcmVTZXR0aW5nc1Rva2VuO1xuICAgIHZhciBtYWpvciA9IHBhcnNlSW50KGZpcmViYXNlLlNES19WRVJTSU9OLnNwbGl0KCcuJylbMF0pO1xuICAgIHZhciBtaW5vciA9IHBhcnNlSW50KGZpcmViYXNlLlNES19WRVJTSU9OLnNwbGl0KCcuJylbMV0pO1xuICAgIHZhciBEZWZhdWx0RmlyZXN0b3JlU2V0dGluZ3MgPSAoKG1ham9yIDwgNSB8fCAobWFqb3IgPT0gNSAmJiBtaW5vciA8IDgpKSA/IHsgdGltZXN0YW1wc0luU25hcHNob3RzOiB0cnVlIH0gOiB7fSk7XG4gICAgZnVuY3Rpb24gYXNzb2NpYXRlUXVlcnkoY29sbGVjdGlvblJlZiwgcXVlcnlGbikge1xuICAgICAgICBpZiAocXVlcnlGbiA9PT0gdm9pZCAwKSB7IHF1ZXJ5Rm4gPSBmdW5jdGlvbiAocmVmKSB7IHJldHVybiByZWY7IH07IH1cbiAgICAgICAgdmFyIHF1ZXJ5ID0gcXVlcnlGbihjb2xsZWN0aW9uUmVmKTtcbiAgICAgICAgdmFyIHJlZiA9IGNvbGxlY3Rpb25SZWY7XG4gICAgICAgIHJldHVybiB7IHF1ZXJ5OiBxdWVyeSwgcmVmOiByZWYgfTtcbiAgICB9XG4gICAgdmFyIEFuZ3VsYXJGaXJlc3RvcmUgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBBbmd1bGFyRmlyZXN0b3JlKG9wdGlvbnMsIG5hbWVPckNvbmZpZywgc2hvdWxkRW5hYmxlUGVyc2lzdGVuY2UsIHNldHRpbmdzLCBwbGF0Zm9ybUlkLCB6b25lLCBwZXJzaXN0ZW5jZVNldHRpbmdzKSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy5zY2hlZHVsZXJzID0gbmV3IGZpcmUuybVBbmd1bGFyRmlyZVNjaGVkdWxlcnMoem9uZSk7XG4gICAgICAgICAgICB0aGlzLmtlZXBVbnN0YWJsZVVudGlsRmlyc3QgPSBmaXJlLsm1a2VlcFVuc3RhYmxlVW50aWxGaXJzdEZhY3RvcnkodGhpcy5zY2hlZHVsZXJzLCBwbGF0Zm9ybUlkKTtcbiAgICAgICAgICAgIHRoaXMuZmlyZXN0b3JlID0gem9uZS5ydW5PdXRzaWRlQW5ndWxhcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFwcCA9IGZpcmUuX2ZpcmViYXNlQXBwRmFjdG9yeShvcHRpb25zLCB6b25lLCBuYW1lT3JDb25maWcpO1xuICAgICAgICAgICAgICAgIHZhciBmaXJlc3RvcmUkJDEgPSBhcHAuZmlyZXN0b3JlKCk7XG4gICAgICAgICAgICAgICAgZmlyZXN0b3JlJCQxLnNldHRpbmdzKHNldHRpbmdzIHx8IERlZmF1bHRGaXJlc3RvcmVTZXR0aW5ncyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpcmVzdG9yZSQkMTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHNob3VsZEVuYWJsZVBlcnNpc3RlbmNlICYmICFjb21tb24uaXNQbGF0Zm9ybVNlcnZlcihwbGF0Zm9ybUlkKSkge1xuICAgICAgICAgICAgICAgIHZhciBlbmFibGVQZXJzaXN0ZW5jZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByeGpzLmZyb20oX3RoaXMuZmlyZXN0b3JlLmVuYWJsZVBlcnNpc3RlbmNlKHBlcnNpc3RlbmNlU2V0dGluZ3MgfHwgdW5kZWZpbmVkKS50aGVuKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRydWU7IH0sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZhbHNlOyB9KSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByeGpzLm9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGhpcy5wZXJzaXN0ZW5jZUVuYWJsZWQkID0gem9uZS5ydW5PdXRzaWRlQW5ndWxhcihlbmFibGVQZXJzaXN0ZW5jZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNpc3RlbmNlRW5hYmxlZCQgPSByeGpzLm9mKGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlLnByb3RvdHlwZS5jb2xsZWN0aW9uID0gZnVuY3Rpb24gKHBhdGhPclJlZiwgcXVlcnlGbikge1xuICAgICAgICAgICAgdmFyIGNvbGxlY3Rpb25SZWY7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhdGhPclJlZiA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uUmVmID0gdGhpcy5maXJlc3RvcmUuY29sbGVjdGlvbihwYXRoT3JSZWYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29sbGVjdGlvblJlZiA9IHBhdGhPclJlZjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBfYSA9IGFzc29jaWF0ZVF1ZXJ5KGNvbGxlY3Rpb25SZWYsIHF1ZXJ5Rm4pLCByZWYgPSBfYS5yZWYsIHF1ZXJ5ID0gX2EucXVlcnk7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uKHJlZiwgcXVlcnksIHRoaXMpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlLnByb3RvdHlwZS5jb2xsZWN0aW9uR3JvdXAgPSBmdW5jdGlvbiAoY29sbGVjdGlvbklkLCBxdWVyeUdyb3VwRm4pIHtcbiAgICAgICAgICAgIGlmIChtYWpvciA8IDYpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBcImNvbGxlY3Rpb24gZ3JvdXAgcXVlcmllcyByZXF1aXJlIEZpcmViYXNlIEpTIFNESyA+PSA2LjBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBxdWVyeUZuID0gcXVlcnlHcm91cEZuIHx8IChmdW5jdGlvbiAocmVmKSB7IHJldHVybiByZWY7IH0pO1xuICAgICAgICAgICAgdmFyIGZpcmVzdG9yZSQkMSA9IHRoaXMuZmlyZXN0b3JlO1xuICAgICAgICAgICAgdmFyIGNvbGxlY3Rpb25Hcm91cCA9IGZpcmVzdG9yZSQkMS5jb2xsZWN0aW9uR3JvdXAoY29sbGVjdGlvbklkKTtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb25Hcm91cChxdWVyeUZuKGNvbGxlY3Rpb25Hcm91cCksIHRoaXMpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlLnByb3RvdHlwZS5kb2MgPSBmdW5jdGlvbiAocGF0aE9yUmVmKSB7XG4gICAgICAgICAgICB2YXIgcmVmO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXRoT3JSZWYgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgcmVmID0gdGhpcy5maXJlc3RvcmUuZG9jKHBhdGhPclJlZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWYgPSBwYXRoT3JSZWY7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV3IEFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudChyZWYsIHRoaXMpO1xuICAgICAgICB9O1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlLnByb3RvdHlwZS5jcmVhdGVJZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpcmVzdG9yZS5jb2xsZWN0aW9uKCdfJykuZG9jKCkuaWQ7XG4gICAgICAgIH07XG4gICAgICAgIEFuZ3VsYXJGaXJlc3RvcmUgPSBfX2RlY29yYXRlKFtcbiAgICAgICAgICAgIGNvcmUuSW5qZWN0YWJsZSgpLFxuICAgICAgICAgICAgX19wYXJhbSgwLCBjb3JlLkluamVjdChmaXJlLkZJUkVCQVNFX09QVElPTlMpKSxcbiAgICAgICAgICAgIF9fcGFyYW0oMSwgY29yZS5PcHRpb25hbCgpKSwgX19wYXJhbSgxLCBjb3JlLkluamVjdChmaXJlLkZJUkVCQVNFX0FQUF9OQU1FKSksXG4gICAgICAgICAgICBfX3BhcmFtKDIsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMiwgY29yZS5JbmplY3QoRU5BQkxFX1BFUlNJU1RFTkNFKSksXG4gICAgICAgICAgICBfX3BhcmFtKDMsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMywgY29yZS5JbmplY3QoU0VUVElOR1MpKSxcbiAgICAgICAgICAgIF9fcGFyYW0oNCwgY29yZS5JbmplY3QoY29yZS5QTEFURk9STV9JRCkpLFxuICAgICAgICAgICAgX19wYXJhbSg2LCBjb3JlLk9wdGlvbmFsKCkpLCBfX3BhcmFtKDYsIGNvcmUuSW5qZWN0KFBFUlNJU1RFTkNFX1NFVFRJTkdTKSksXG4gICAgICAgICAgICBfX21ldGFkYXRhKFwiZGVzaWduOnBhcmFtdHlwZXNcIiwgW09iamVjdCwgT2JqZWN0LCBPYmplY3QsIE9iamVjdCwgT2JqZWN0LFxuICAgICAgICAgICAgICAgIGNvcmUuTmdab25lLCBPYmplY3RdKVxuICAgICAgICBdLCBBbmd1bGFyRmlyZXN0b3JlKTtcbiAgICAgICAgcmV0dXJuIEFuZ3VsYXJGaXJlc3RvcmU7XG4gICAgfSgpKTtcblxuICAgIHZhciBfX2RlY29yYXRlJDEgPSAodW5kZWZpbmVkICYmIHVuZGVmaW5lZC5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcbiAgICAgICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcbiAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcbiAgICAgICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgICAgICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbiAgICB9O1xuICAgIHZhciBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZnVuY3Rpb24gQW5ndWxhckZpcmVzdG9yZU1vZHVsZSgpIHtcbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlXzEgPSBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlO1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlLmVuYWJsZVBlcnNpc3RlbmNlID0gZnVuY3Rpb24gKHBlcnNpc3RlbmNlU2V0dGluZ3MpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmdNb2R1bGU6IEFuZ3VsYXJGaXJlc3RvcmVNb2R1bGVfMSxcbiAgICAgICAgICAgICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgICAgICAgICAgICAgeyBwcm92aWRlOiBFbmFibGVQZXJzaXN0ZW5jZVRva2VuLCB1c2VWYWx1ZTogdHJ1ZSB9LFxuICAgICAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IFBlcnNpc3RlbmNlU2V0dGluZ3NUb2tlbiwgdXNlVmFsdWU6IHBlcnNpc3RlbmNlU2V0dGluZ3MgfSxcbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9O1xuICAgICAgICB9O1xuICAgICAgICB2YXIgQW5ndWxhckZpcmVzdG9yZU1vZHVsZV8xO1xuICAgICAgICBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlID0gQW5ndWxhckZpcmVzdG9yZU1vZHVsZV8xID0gX19kZWNvcmF0ZSQxKFtcbiAgICAgICAgICAgIGNvcmUuTmdNb2R1bGUoe1xuICAgICAgICAgICAgICAgIHByb3ZpZGVyczogW0FuZ3VsYXJGaXJlc3RvcmVdXG4gICAgICAgICAgICB9KVxuICAgICAgICBdLCBBbmd1bGFyRmlyZXN0b3JlTW9kdWxlKTtcbiAgICAgICAgcmV0dXJuIEFuZ3VsYXJGaXJlc3RvcmVNb2R1bGU7XG4gICAgfSgpKTtcblxuICAgIGV4cG9ydHMuRW5hYmxlUGVyc2lzdGVuY2VUb2tlbiA9IEVuYWJsZVBlcnNpc3RlbmNlVG9rZW47XG4gICAgZXhwb3J0cy5QZXJzaXN0ZW5jZVNldHRpbmdzVG9rZW4gPSBQZXJzaXN0ZW5jZVNldHRpbmdzVG9rZW47XG4gICAgZXhwb3J0cy5GaXJlc3RvcmVTZXR0aW5nc1Rva2VuID0gRmlyZXN0b3JlU2V0dGluZ3NUb2tlbjtcbiAgICBleHBvcnRzLkVOQUJMRV9QRVJTSVNURU5DRSA9IEVOQUJMRV9QRVJTSVNURU5DRTtcbiAgICBleHBvcnRzLlBFUlNJU1RFTkNFX1NFVFRJTkdTID0gUEVSU0lTVEVOQ0VfU0VUVElOR1M7XG4gICAgZXhwb3J0cy5TRVRUSU5HUyA9IFNFVFRJTkdTO1xuICAgIGV4cG9ydHMuRGVmYXVsdEZpcmVzdG9yZVNldHRpbmdzID0gRGVmYXVsdEZpcmVzdG9yZVNldHRpbmdzO1xuICAgIGV4cG9ydHMuYXNzb2NpYXRlUXVlcnkgPSBhc3NvY2lhdGVRdWVyeTtcbiAgICBleHBvcnRzLkFuZ3VsYXJGaXJlc3RvcmUgPSBBbmd1bGFyRmlyZXN0b3JlO1xuICAgIGV4cG9ydHMuQW5ndWxhckZpcmVzdG9yZU1vZHVsZSA9IEFuZ3VsYXJGaXJlc3RvcmVNb2R1bGU7XG4gICAgZXhwb3J0cy52YWxpZGF0ZUV2ZW50c0FycmF5ID0gdmFsaWRhdGVFdmVudHNBcnJheTtcbiAgICBleHBvcnRzLkFuZ3VsYXJGaXJlc3RvcmVDb2xsZWN0aW9uID0gQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb247XG4gICAgZXhwb3J0cy5Bbmd1bGFyRmlyZXN0b3JlQ29sbGVjdGlvbkdyb3VwID0gQW5ndWxhckZpcmVzdG9yZUNvbGxlY3Rpb25Hcm91cDtcbiAgICBleHBvcnRzLkFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudCA9IEFuZ3VsYXJGaXJlc3RvcmVEb2N1bWVudDtcbiAgICBleHBvcnRzLmRvY0NoYW5nZXMgPSBkb2NDaGFuZ2VzO1xuICAgIGV4cG9ydHMuc29ydGVkQ2hhbmdlcyA9IHNvcnRlZENoYW5nZXM7XG4gICAgZXhwb3J0cy5jb21iaW5lQ2hhbmdlcyA9IGNvbWJpbmVDaGFuZ2VzO1xuICAgIGV4cG9ydHMuY29tYmluZUNoYW5nZSA9IGNvbWJpbmVDaGFuZ2U7XG4gICAgZXhwb3J0cy5mcm9tUmVmID0gZnJvbVJlZjtcbiAgICBleHBvcnRzLmZyb21Eb2NSZWYgPSBmcm9tRG9jUmVmO1xuICAgIGV4cG9ydHMuZnJvbUNvbGxlY3Rpb25SZWYgPSBmcm9tQ29sbGVjdGlvblJlZjtcblxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7XG5cbn0pKSk7XG4iXX0=