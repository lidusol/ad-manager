(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),require('@angular/fire'),exports, require('@angular/core'), require('rxjs'), require('rxjs/operators'), require('@angular/fire')) :
    typeof define === 'function' && define.amd ? define(['@angular/core','@angular/fire','exports', '@angular/core', 'rxjs', 'rxjs/operators', '@angular/fire'], factory) :
    (factory(global.ng.core,global.ng.fire,(global.angularfire2 = global.angularfire2 || {}, global.angularfire2.performance = {}),global.ng.core,global.rxjs,global.rxjs.operators,global.angularfire2));
}(this, (function (ɵngcc0,ɵngcc1,exports,core,rxjs,operators,fire) { 'use strict';

    var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata = (undefined && undefined.__metadata) || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
        return function (target, key) { decorator(target, key, paramIndex); }
    };
    var AUTOMATICALLY_TRACE_CORE_NG_METRICS = new core.InjectionToken('angularfire2.performance.auto_trace');
    var INSTRUMENTATION_ENABLED = new core.InjectionToken('angularfire2.performance.instrumentationEnabled');
    var DATA_COLLECTION_ENABLED = new core.InjectionToken('angularfire2.performance.dataCollectionEnabled');
    var AngularFirePerformance = (function () {
        function AngularFirePerformance(app, automaticallyTraceCoreNgMetrics, instrumentationEnabled, dataCollectionEnabled, appRef, zone) {
            var _this = this;
            this.zone = zone;
            this.trace$ = function (name, options) {
                return _this.performance.pipe(operators.switchMap(function (performance) {
                    return new rxjs.Observable(function (emitter) {
                        return _this.zone.runOutsideAngular(function () {
                            var trace = performance.trace(name);
                            options && options.metrics && Object.keys(options.metrics).forEach(function (metric) {
                                trace.putMetric(metric, options.metrics[metric]);
                            });
                            options && options.attributes && Object.keys(options.attributes).forEach(function (attribute) {
                                trace.putAttribute(attribute, options.attributes[attribute]);
                            });
                            var attributeSubscriptions = options && options.attribute$ ? Object.keys(options.attribute$).map(function (attribute) {
                                return options.attribute$[attribute].subscribe(function (next) { return trace.putAttribute(attribute, next); });
                            }) : [];
                            var metricSubscriptions = options && options.metric$ ? Object.keys(options.metric$).map(function (metric) {
                                return options.metric$[metric].subscribe(function (next) { return trace.putMetric(metric, next); });
                            }) : [];
                            var incrementOnSubscriptions = options && options.incrementMetric$ ? Object.keys(options.incrementMetric$).map(function (metric) {
                                return options.incrementMetric$[metric].subscribe(function (next) { return trace.incrementMetric(metric, next || undefined); });
                            }) : [];
                            emitter.next(trace.start());
                            return { unsubscribe: function () {
                                    trace.stop();
                                    metricSubscriptions.forEach(function (m) { return m.unsubscribe(); });
                                    incrementOnSubscriptions.forEach(function (m) { return m.unsubscribe(); });
                                    attributeSubscriptions.forEach(function (m) { return m.unsubscribe(); });
                                } };
                        });
                    });
                }));
            };
            this.traceUntil = function (name, test, options) { return function (source$) { return new rxjs.Observable(function (subscriber) {
                var traceSubscription = _this.trace$(name, options).subscribe();
                return source$.pipe(operators.tap(function (a) { return test(a) && traceSubscription.unsubscribe(); }, function () { }, function () { return options && options.orComplete && traceSubscription.unsubscribe(); })).subscribe(subscriber);
            }); }; };
            this.traceWhile = function (name, test, options) { return function (source$) { return new rxjs.Observable(function (subscriber) {
                var traceSubscription;
                return source$.pipe(operators.tap(function (a) {
                    if (test(a)) {
                        traceSubscription = traceSubscription || _this.trace$(name, options).subscribe();
                    }
                    else {
                        traceSubscription && traceSubscription.unsubscribe();
                        traceSubscription = undefined;
                    }
                }, function () { }, function () { return options && options.orComplete && traceSubscription && traceSubscription.unsubscribe(); })).subscribe(subscriber);
            }); }; };
            this.traceUntilComplete = function (name, options) { return function (source$) { return new rxjs.Observable(function (subscriber) {
                var traceSubscription = _this.trace$(name, options).subscribe();
                return source$.pipe(operators.tap(function () { }, function () { }, function () { return traceSubscription.unsubscribe(); })).subscribe(subscriber);
            }); }; };
            this.traceUntilFirst = function (name, options) { return function (source$) { return new rxjs.Observable(function (subscriber) {
                var traceSubscription = _this.trace$(name, options).subscribe();
                return source$.pipe(operators.tap(function () { return traceSubscription.unsubscribe(); }, function () { }, function () { })).subscribe(subscriber);
            }); }; };
            this.trace = function (name, options) { return function (source$) { return new rxjs.Observable(function (subscriber) {
                var traceSubscription = _this.trace$(name, options).subscribe();
                return source$.pipe(operators.tap(function () { return traceSubscription.unsubscribe(); }, function () { }, function () { return traceSubscription.unsubscribe(); })).subscribe(subscriber);
            }); }; };
            var requirePerformance = rxjs.from(zone.runOutsideAngular(function () { return rxjs.empty(); }));
            this.performance = requirePerformance.pipe(operators.map(function () { return zone.runOutsideAngular(function () { return app.performance(); }); }), operators.tap(function (performance) {
                if (instrumentationEnabled == false) {
                    performance.instrumentationEnabled = false;
                }
                if (dataCollectionEnabled == false) {
                    performance.dataCollectionEnabled = false;
                }
            }), operators.shareReplay(1));
            if (automaticallyTraceCoreNgMetrics != false) {
                appRef.isStable.pipe(operators.first(function (it) { return it; }), this.traceUntilComplete('isStable')).subscribe();
            }
        }
        AngularFirePerformance = __decorate([ __param(1, core.Optional()), __param(1, core.Inject(AUTOMATICALLY_TRACE_CORE_NG_METRICS)),
            __param(2, core.Optional()), __param(2, core.Inject(INSTRUMENTATION_ENABLED)),
            __param(3, core.Optional()), __param(3, core.Inject(DATA_COLLECTION_ENABLED)),
            __metadata("design:paramtypes", [fire.FirebaseApp, Object, Object, Object, core.ApplicationRef,
                core.NgZone])
        ], AngularFirePerformance);
AngularFirePerformance.ɵfac = function AngularFirePerformance_Factory(t) { return new (t || AngularFirePerformance)(ɵngcc0.ɵɵinject(ɵngcc1.FirebaseApp), ɵngcc0.ɵɵinject(AUTOMATICALLY_TRACE_CORE_NG_METRICS, 8), ɵngcc0.ɵɵinject(INSTRUMENTATION_ENABLED, 8), ɵngcc0.ɵɵinject(DATA_COLLECTION_ENABLED, 8), ɵngcc0.ɵɵinject(ɵngcc0.ApplicationRef), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
AngularFirePerformance.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: AngularFirePerformance, factory: function (t) { return AngularFirePerformance.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFirePerformance, [{
        type: core.Injectable
    }], function () { return [{ type: ɵngcc1.FirebaseApp }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [AUTOMATICALLY_TRACE_CORE_NG_METRICS]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [INSTRUMENTATION_ENABLED]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [DATA_COLLECTION_ENABLED]
            }] }, { type: ɵngcc0.ApplicationRef }, { type: ɵngcc0.NgZone }]; }, null); })();
        return AngularFirePerformance;
    }());

    var __decorate$1 = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata$1 = (undefined && undefined.__metadata) || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var AngularFirePerformanceModule = (function () {
        function AngularFirePerformanceModule(_) {
        }
        AngularFirePerformanceModule = __decorate$1([ __metadata$1("design:paramtypes", [AngularFirePerformance])
        ], AngularFirePerformanceModule);
AngularFirePerformanceModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: AngularFirePerformanceModule });
AngularFirePerformanceModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function AngularFirePerformanceModule_Factory(t) { return new (t || AngularFirePerformanceModule)(ɵngcc0.ɵɵinject(AngularFirePerformance)); }, providers: [AngularFirePerformance] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFirePerformanceModule, [{
        type: core.NgModule,
        args: [{
                providers: [AngularFirePerformance]
            }]
    }], function () { return [{ type: AngularFirePerformance }]; }, null); })();
        return AngularFirePerformanceModule;
    }());

    exports.AUTOMATICALLY_TRACE_CORE_NG_METRICS = AUTOMATICALLY_TRACE_CORE_NG_METRICS;
    exports.INSTRUMENTATION_ENABLED = INSTRUMENTATION_ENABLED;
    exports.DATA_COLLECTION_ENABLED = DATA_COLLECTION_ENABLED;
    exports.AngularFirePerformance = AngularFirePerformance;
    exports.AngularFirePerformanceModule = AngularFirePerformanceModule;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyZm9ybWFuY2UudW1kLmpzIiwic291cmNlcyI6WyJwZXJmb3JtYW5jZS51bWQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSw2SEFBMkU7QUFDM0UseUZBQXlEO0FBQ3pELDJDQUFhO0FBQ2IsaUNBQW1CO0FBQ25CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FFVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzRGQUFtQztBQUNuQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxREFJVztBQUNYOzs7Ozs7OztnRkFBeUM7QUFDekM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHtcbiAgICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBmYWN0b3J5KGV4cG9ydHMsIHJlcXVpcmUoJ0Bhbmd1bGFyL2NvcmUnKSwgcmVxdWlyZSgncnhqcycpLCByZXF1aXJlKCdyeGpzL29wZXJhdG9ycycpLCByZXF1aXJlKCdAYW5ndWxhci9maXJlJykpIDpcbiAgICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoWydleHBvcnRzJywgJ0Bhbmd1bGFyL2NvcmUnLCAncnhqcycsICdyeGpzL29wZXJhdG9ycycsICdAYW5ndWxhci9maXJlJ10sIGZhY3RvcnkpIDpcbiAgICAoZmFjdG9yeSgoZ2xvYmFsLmFuZ3VsYXJmaXJlMiA9IGdsb2JhbC5hbmd1bGFyZmlyZTIgfHwge30sIGdsb2JhbC5hbmd1bGFyZmlyZTIucGVyZm9ybWFuY2UgPSB7fSksZ2xvYmFsLm5nLmNvcmUsZ2xvYmFsLnJ4anMsZ2xvYmFsLnJ4anMub3BlcmF0b3JzLGdsb2JhbC5hbmd1bGFyZmlyZTIpKTtcbn0odGhpcywgKGZ1bmN0aW9uIChleHBvcnRzLGNvcmUscnhqcyxvcGVyYXRvcnMsZmlyZSkgeyAndXNlIHN0cmljdCc7XG5cbiAgICB2YXIgX19kZWNvcmF0ZSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgICAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgICAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgICAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xuICAgIH07XG4gICAgdmFyIF9fbWV0YWRhdGEgPSAodW5kZWZpbmVkICYmIHVuZGVmaW5lZC5fX21ldGFkYXRhKSB8fCBmdW5jdGlvbiAoaywgdikge1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QubWV0YWRhdGEgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIFJlZmxlY3QubWV0YWRhdGEoaywgdik7XG4gICAgfTtcbiAgICB2YXIgX19wYXJhbSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG4gICAgfTtcbiAgICB2YXIgQVVUT01BVElDQUxMWV9UUkFDRV9DT1JFX05HX01FVFJJQ1MgPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLnBlcmZvcm1hbmNlLmF1dG9fdHJhY2UnKTtcbiAgICB2YXIgSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQgPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLnBlcmZvcm1hbmNlLmluc3RydW1lbnRhdGlvbkVuYWJsZWQnKTtcbiAgICB2YXIgREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQgPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLnBlcmZvcm1hbmNlLmRhdGFDb2xsZWN0aW9uRW5hYmxlZCcpO1xuICAgIHZhciBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZnVuY3Rpb24gQW5ndWxhckZpcmVQZXJmb3JtYW5jZShhcHAsIGF1dG9tYXRpY2FsbHlUcmFjZUNvcmVOZ01ldHJpY3MsIGluc3RydW1lbnRhdGlvbkVuYWJsZWQsIGRhdGFDb2xsZWN0aW9uRW5hYmxlZCwgYXBwUmVmLCB6b25lKSB7XG4gICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICAgICAgdGhpcy56b25lID0gem9uZTtcbiAgICAgICAgICAgIHRoaXMudHJhY2UkID0gZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucGVyZm9ybWFuY2UucGlwZShvcGVyYXRvcnMuc3dpdGNoTWFwKGZ1bmN0aW9uIChwZXJmb3JtYW5jZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHJ4anMuT2JzZXJ2YWJsZShmdW5jdGlvbiAoZW1pdHRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFjZSA9IHBlcmZvcm1hbmNlLnRyYWNlKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5tZXRyaWNzICYmIE9iamVjdC5rZXlzKG9wdGlvbnMubWV0cmljcykuZm9yRWFjaChmdW5jdGlvbiAobWV0cmljKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWNlLnB1dE1ldHJpYyhtZXRyaWMsIG9wdGlvbnMubWV0cmljc1ttZXRyaWNdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zICYmIG9wdGlvbnMuYXR0cmlidXRlcyAmJiBPYmplY3Qua2V5cyhvcHRpb25zLmF0dHJpYnV0ZXMpLmZvckVhY2goZnVuY3Rpb24gKGF0dHJpYnV0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFjZS5wdXRBdHRyaWJ1dGUoYXR0cmlidXRlLCBvcHRpb25zLmF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVN1YnNjcmlwdGlvbnMgPSBvcHRpb25zICYmIG9wdGlvbnMuYXR0cmlidXRlJCA/IE9iamVjdC5rZXlzKG9wdGlvbnMuYXR0cmlidXRlJCkubWFwKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYXR0cmlidXRlJFthdHRyaWJ1dGVdLnN1YnNjcmliZShmdW5jdGlvbiAobmV4dCkgeyByZXR1cm4gdHJhY2UucHV0QXR0cmlidXRlKGF0dHJpYnV0ZSwgbmV4dCk7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1ldHJpY1N1YnNjcmlwdGlvbnMgPSBvcHRpb25zICYmIG9wdGlvbnMubWV0cmljJCA/IE9iamVjdC5rZXlzKG9wdGlvbnMubWV0cmljJCkubWFwKGZ1bmN0aW9uIChtZXRyaWMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMubWV0cmljJFttZXRyaWNdLnN1YnNjcmliZShmdW5jdGlvbiAobmV4dCkgeyByZXR1cm4gdHJhY2UucHV0TWV0cmljKG1ldHJpYywgbmV4dCk7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluY3JlbWVudE9uU3Vic2NyaXB0aW9ucyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5pbmNyZW1lbnRNZXRyaWMkID8gT2JqZWN0LmtleXMob3B0aW9ucy5pbmNyZW1lbnRNZXRyaWMkKS5tYXAoZnVuY3Rpb24gKG1ldHJpYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5pbmNyZW1lbnRNZXRyaWMkW21ldHJpY10uc3Vic2NyaWJlKGZ1bmN0aW9uIChuZXh0KSB7IHJldHVybiB0cmFjZS5pbmNyZW1lbnRNZXRyaWMobWV0cmljLCBuZXh0IHx8IHVuZGVmaW5lZCk7IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1pdHRlci5uZXh0KHRyYWNlLnN0YXJ0KCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHVuc3Vic2NyaWJlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFjZS5zdG9wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNTdWJzY3JpcHRpb25zLmZvckVhY2goZnVuY3Rpb24gKG0pIHsgcmV0dXJuIG0udW5zdWJzY3JpYmUoKTsgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmNyZW1lbnRPblN1YnNjcmlwdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobSkgeyByZXR1cm4gbS51bnN1YnNjcmliZSgpOyB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVN1YnNjcmlwdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobSkgeyByZXR1cm4gbS51bnN1YnNjcmliZSgpOyB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLnRyYWNlVW50aWwgPSBmdW5jdGlvbiAobmFtZSwgdGVzdCwgb3B0aW9ucykgeyByZXR1cm4gZnVuY3Rpb24gKHNvdXJjZSQpIHsgcmV0dXJuIG5ldyByeGpzLk9ic2VydmFibGUoZnVuY3Rpb24gKHN1YnNjcmliZXIpIHtcbiAgICAgICAgICAgICAgICB2YXIgdHJhY2VTdWJzY3JpcHRpb24gPSBfdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZSQucGlwZShvcGVyYXRvcnMudGFwKGZ1bmN0aW9uIChhKSB7IHJldHVybiB0ZXN0KGEpICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7IH0sIGZ1bmN0aW9uICgpIHsgfSwgZnVuY3Rpb24gKCkgeyByZXR1cm4gb3B0aW9ucyAmJiBvcHRpb25zLm9yQ29tcGxldGUgJiYgdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTsgfSkpLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgICAgICAgICAgIH0pOyB9OyB9O1xuICAgICAgICAgICAgdGhpcy50cmFjZVdoaWxlID0gZnVuY3Rpb24gKG5hbWUsIHRlc3QsIG9wdGlvbnMpIHsgcmV0dXJuIGZ1bmN0aW9uIChzb3VyY2UkKSB7IHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRyYWNlU3Vic2NyaXB0aW9uO1xuICAgICAgICAgICAgICAgIHJldHVybiBzb3VyY2UkLnBpcGUob3BlcmF0b3JzLnRhcChmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGVzdChhKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2VTdWJzY3JpcHRpb24gPSB0cmFjZVN1YnNjcmlwdGlvbiB8fCBfdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFjZVN1YnNjcmlwdGlvbiAmJiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2VTdWJzY3JpcHRpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7IH0sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG9wdGlvbnMgJiYgb3B0aW9ucy5vckNvbXBsZXRlICYmIHRyYWNlU3Vic2NyaXB0aW9uICYmIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7IH0pKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgICAgICB9KTsgfTsgfTtcbiAgICAgICAgICAgIHRoaXMudHJhY2VVbnRpbENvbXBsZXRlID0gZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsgcmV0dXJuIGZ1bmN0aW9uIChzb3VyY2UkKSB7IHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRyYWNlU3Vic2NyaXB0aW9uID0gX3RoaXMudHJhY2UkKG5hbWUsIG9wdGlvbnMpLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzb3VyY2UkLnBpcGUob3BlcmF0b3JzLnRhcChmdW5jdGlvbiAoKSB7IH0sIGZ1bmN0aW9uICgpIHsgfSwgZnVuY3Rpb24gKCkgeyByZXR1cm4gdHJhY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTsgfSkpLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgICAgICAgICAgIH0pOyB9OyB9O1xuICAgICAgICAgICAgdGhpcy50cmFjZVVudGlsRmlyc3QgPSBmdW5jdGlvbiAobmFtZSwgb3B0aW9ucykgeyByZXR1cm4gZnVuY3Rpb24gKHNvdXJjZSQpIHsgcmV0dXJuIG5ldyByeGpzLk9ic2VydmFibGUoZnVuY3Rpb24gKHN1YnNjcmliZXIpIHtcbiAgICAgICAgICAgICAgICB2YXIgdHJhY2VTdWJzY3JpcHRpb24gPSBfdGhpcy50cmFjZSQobmFtZSwgb3B0aW9ucykuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNvdXJjZSQucGlwZShvcGVyYXRvcnMudGFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7IH0sIGZ1bmN0aW9uICgpIHsgfSwgZnVuY3Rpb24gKCkgeyB9KSkuc3Vic2NyaWJlKHN1YnNjcmliZXIpO1xuICAgICAgICAgICAgfSk7IH07IH07XG4gICAgICAgICAgICB0aGlzLnRyYWNlID0gZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsgcmV0dXJuIGZ1bmN0aW9uIChzb3VyY2UkKSB7IHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRyYWNlU3Vic2NyaXB0aW9uID0gX3RoaXMudHJhY2UkKG5hbWUsIG9wdGlvbnMpLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBzb3VyY2UkLnBpcGUob3BlcmF0b3JzLnRhcChmdW5jdGlvbiAoKSB7IHJldHVybiB0cmFjZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpOyB9LCBmdW5jdGlvbiAoKSB7IH0sIGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRyYWNlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7IH0pKS5zdWJzY3JpYmUoc3Vic2NyaWJlcik7XG4gICAgICAgICAgICB9KTsgfTsgfTtcbiAgICAgICAgICAgIHZhciByZXF1aXJlUGVyZm9ybWFuY2UgPSByeGpzLmZyb20oem9uZS5ydW5PdXRzaWRlQW5ndWxhcihmdW5jdGlvbiAoKSB7IHJldHVybiByeGpzLmVtcHR5KCk7IH0pKTtcbiAgICAgICAgICAgIHRoaXMucGVyZm9ybWFuY2UgPSByZXF1aXJlUGVyZm9ybWFuY2UucGlwZShvcGVyYXRvcnMubWFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoZnVuY3Rpb24gKCkgeyByZXR1cm4gYXBwLnBlcmZvcm1hbmNlKCk7IH0pOyB9KSwgb3BlcmF0b3JzLnRhcChmdW5jdGlvbiAocGVyZm9ybWFuY2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudGF0aW9uRW5hYmxlZCA9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICBwZXJmb3JtYW5jZS5pbnN0cnVtZW50YXRpb25FbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkYXRhQ29sbGVjdGlvbkVuYWJsZWQgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgcGVyZm9ybWFuY2UuZGF0YUNvbGxlY3Rpb25FbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksIG9wZXJhdG9ycy5zaGFyZVJlcGxheSgxKSk7XG4gICAgICAgICAgICBpZiAoYXV0b21hdGljYWxseVRyYWNlQ29yZU5nTWV0cmljcyAhPSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIGFwcFJlZi5pc1N0YWJsZS5waXBlKG9wZXJhdG9ycy5maXJzdChmdW5jdGlvbiAoaXQpIHsgcmV0dXJuIGl0OyB9KSwgdGhpcy50cmFjZVVudGlsQ29tcGxldGUoJ2lzU3RhYmxlJykpLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIEFuZ3VsYXJGaXJlUGVyZm9ybWFuY2UgPSBfX2RlY29yYXRlKFtcbiAgICAgICAgICAgIGNvcmUuSW5qZWN0YWJsZSgpLFxuICAgICAgICAgICAgX19wYXJhbSgxLCBjb3JlLk9wdGlvbmFsKCkpLCBfX3BhcmFtKDEsIGNvcmUuSW5qZWN0KEFVVE9NQVRJQ0FMTFlfVFJBQ0VfQ09SRV9OR19NRVRSSUNTKSksXG4gICAgICAgICAgICBfX3BhcmFtKDIsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMiwgY29yZS5JbmplY3QoSU5TVFJVTUVOVEFUSU9OX0VOQUJMRUQpKSxcbiAgICAgICAgICAgIF9fcGFyYW0oMywgY29yZS5PcHRpb25hbCgpKSwgX19wYXJhbSgzLCBjb3JlLkluamVjdChEQVRBX0NPTExFQ1RJT05fRU5BQkxFRCkpLFxuICAgICAgICAgICAgX19tZXRhZGF0YShcImRlc2lnbjpwYXJhbXR5cGVzXCIsIFtmaXJlLkZpcmViYXNlQXBwLCBPYmplY3QsIE9iamVjdCwgT2JqZWN0LCBjb3JlLkFwcGxpY2F0aW9uUmVmLFxuICAgICAgICAgICAgICAgIGNvcmUuTmdab25lXSlcbiAgICAgICAgXSwgQW5ndWxhckZpcmVQZXJmb3JtYW5jZSk7XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlO1xuICAgIH0oKSk7XG5cbiAgICB2YXIgX19kZWNvcmF0ZSQxID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XG4gICAgICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XG4gICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XG4gICAgICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XG4gICAgICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XG4gICAgfTtcbiAgICB2YXIgX19tZXRhZGF0YSQxID0gKHVuZGVmaW5lZCAmJiB1bmRlZmluZWQuX19tZXRhZGF0YSkgfHwgZnVuY3Rpb24gKGssIHYpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0Lm1ldGFkYXRhID09PSBcImZ1bmN0aW9uXCIpIHJldHVybiBSZWZsZWN0Lm1ldGFkYXRhKGssIHYpO1xuICAgIH07XG4gICAgdmFyIEFuZ3VsYXJGaXJlUGVyZm9ybWFuY2VNb2R1bGUgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlTW9kdWxlKF8pIHtcbiAgICAgICAgfVxuICAgICAgICBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlTW9kdWxlID0gX19kZWNvcmF0ZSQxKFtcbiAgICAgICAgICAgIGNvcmUuTmdNb2R1bGUoe1xuICAgICAgICAgICAgICAgIHByb3ZpZGVyczogW0FuZ3VsYXJGaXJlUGVyZm9ybWFuY2VdXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF9fbWV0YWRhdGEkMShcImRlc2lnbjpwYXJhbXR5cGVzXCIsIFtBbmd1bGFyRmlyZVBlcmZvcm1hbmNlXSlcbiAgICAgICAgXSwgQW5ndWxhckZpcmVQZXJmb3JtYW5jZU1vZHVsZSk7XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlTW9kdWxlO1xuICAgIH0oKSk7XG5cbiAgICBleHBvcnRzLkFVVE9NQVRJQ0FMTFlfVFJBQ0VfQ09SRV9OR19NRVRSSUNTID0gQVVUT01BVElDQUxMWV9UUkFDRV9DT1JFX05HX01FVFJJQ1M7XG4gICAgZXhwb3J0cy5JTlNUUlVNRU5UQVRJT05fRU5BQkxFRCA9IElOU1RSVU1FTlRBVElPTl9FTkFCTEVEO1xuICAgIGV4cG9ydHMuREFUQV9DT0xMRUNUSU9OX0VOQUJMRUQgPSBEQVRBX0NPTExFQ1RJT05fRU5BQkxFRDtcbiAgICBleHBvcnRzLkFuZ3VsYXJGaXJlUGVyZm9ybWFuY2UgPSBBbmd1bGFyRmlyZVBlcmZvcm1hbmNlO1xuICAgIGV4cG9ydHMuQW5ndWxhckZpcmVQZXJmb3JtYW5jZU1vZHVsZSA9IEFuZ3VsYXJGaXJlUGVyZm9ybWFuY2VNb2R1bGU7XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pO1xuXG59KSkpO1xuIl19