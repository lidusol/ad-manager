(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),exports, require('@angular/core'), require('rxjs'), require('rxjs/operators'), require('@angular/fire')) :
    typeof define === 'function' && define.amd ? define(['@angular/core','exports', '@angular/core', 'rxjs', 'rxjs/operators', '@angular/fire'], factory) :
    (factory(global.ng.core,(global.angularfire2 = global.angularfire2 || {}, global.angularfire2.remote_config = {}),global.ng.core,global.rxjs,global.rxjs.operators,global.angularfire2));
}(this, (function (ɵngcc0,exports,core,rxjs,operators,fire) { 'use strict';

    var __extends = (undefined && undefined.__extends) || (function () {
        var extendStatics = function (d, b) {
            extendStatics = Object.setPrototypeOf ||
                ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
            return extendStatics(d, b);
        };
        return function (d, b) {
            extendStatics(d, b);
            function __() { this.constructor = d; }
            d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
        };
    })();
    var __assign = (undefined && undefined.__assign) || function () {
        __assign = Object.assign || function(t) {
            for (var s, i = 1, n = arguments.length; i < n; i++) {
                s = arguments[i];
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                    t[p] = s[p];
            }
            return t;
        };
        return __assign.apply(this, arguments);
    };
    var __decorate = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var __metadata = (undefined && undefined.__metadata) || function (k, v) {
        if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
    };
    var __param = (undefined && undefined.__param) || function (paramIndex, decorator) {
        return function (target, key) { decorator(target, key, paramIndex); }
    };
    var SETTINGS = new core.InjectionToken('angularfire2.remoteConfig.settings');
    var DEFAULTS = new core.InjectionToken('angularfire2.remoteConfig.defaultConfig');
    var Value = (function () {
        function Value(_source, _value) {
            this._source = _source;
            this._value = _value;
        }
        Value.prototype.asBoolean = function () { return ['1', 'true', 't', 'y', 'yes', 'on'].indexOf(this._value.toLowerCase()) > -1; };
        Value.prototype.asString = function () { return this._value; };
        Value.prototype.asNumber = function () { return Number(this._value) || 0; };
        Value.prototype.getSource = function () { return this._source; };
        return Value;
    }());
    var Parameter = (function (_super) {
        __extends(Parameter, _super);
        function Parameter(key, fetchTimeMillis, source, value) {
            var _this = _super.call(this, source, value) || this;
            _this.key = key;
            _this.fetchTimeMillis = fetchTimeMillis;
            return _this;
        }
        return Parameter;
    }(Value));
    var filterTest = function (fn) { return operators.filter(function (it) { return Array.isArray(it) ? it.some(fn) : fn(it); }); };
    var ɵ0 = filterTest;
    var filterRemote = function () { return filterTest(function (p) { return p.getSource() === 'remote'; }); };
    var filterFresh = function (howRecentInMillis) { return filterTest(function (p) { return p.fetchTimeMillis + howRecentInMillis >= new Date().getTime(); }); };
    var AngularFireRemoteConfig = (function () {
        function AngularFireRemoteConfig(options, nameOrConfig, settings, defaultConfig, zone) {
            this.zone = zone;
            var schedulers = new fire.ɵAngularFireSchedulers(zone);
            var remoteConfig$ = rxjs.of(undefined).pipe(operators.observeOn(schedulers.outsideAngular), operators.switchMap(function () { return zone.runOutsideAngular(function () { return rxjs.empty(); }); }), operators.map(function () { return fire._firebaseAppFactory(options, zone, nameOrConfig); }), operators.map(function (app) { return app.remoteConfig(); }), operators.tap(function (rc) {
                if (settings) {
                    rc.settings = settings;
                }
                if (defaultConfig) {
                    rc.defaultConfig = defaultConfig;
                }
            }), operators.startWith(undefined), operators.shareReplay({ bufferSize: 1, refCount: false }));
            var loadedRemoteConfig$ = remoteConfig$.pipe(operators.filter(function (rc) { return !!rc; }));
            var default$ = rxjs.of(Object.keys(defaultConfig || {}).reduce(function (c, k) {
                var _a;
                return (__assign({}, c, (_a = {}, _a[k] = new Value("default", defaultConfig[k].toString()), _a)));
            }, {}));
            var filterOutDefaults = operators.map(function (all) {
                return Object.keys(all)
                    .filter(function (key) { return all[key].getSource() != 'default'; })
                    .reduce(function (acc, key) {
                    var _a;
                    return (__assign({}, acc, (_a = {}, _a[key] = all[key], _a)));
                }, {});
            });
            var existing$ = loadedRemoteConfig$.pipe(operators.switchMap(function (rc) {
                return rc.activate()
                    .then(function () { return rc.ensureInitialized(); })
                    .then(function () { return rc.getAll(); });
            }), filterOutDefaults);
            var fresh$ = loadedRemoteConfig$.pipe(operators.switchMap(function (rc) { return zone.runOutsideAngular(function () {
                return rc.fetchAndActivate()
                    .then(function () { return rc.ensureInitialized(); })
                    .then(function () { return rc.getAll(); });
            }); }), filterOutDefaults);
            this.parameters = rxjs.concat(default$, existing$, fresh$).pipe(scanToParametersArray(remoteConfig$), operators.shareReplay({ bufferSize: 1, refCount: true }));
            this.changes = this.parameters.pipe(operators.switchMap(function (params) { return rxjs.of.apply(void 0, params); }), operators.groupBy(function (param) { return param.key; }), operators.mergeMap(function (group) { return group.pipe(operators.distinctUntilChanged()); }));
            this.strings = proxyAll(this.parameters, 'strings');
            this.booleans = proxyAll(this.parameters, 'booleans');
            this.numbers = proxyAll(this.parameters, 'numbers');
            return fire.ɵlazySDKProxy(this, loadedRemoteConfig$, zone);
        }
        AngularFireRemoteConfig = __decorate([ __param(0, core.Inject(fire.FIREBASE_OPTIONS)),
            __param(1, core.Optional()), __param(1, core.Inject(fire.FIREBASE_APP_NAME)),
            __param(2, core.Optional()), __param(2, core.Inject(SETTINGS)),
            __param(3, core.Optional()), __param(3, core.Inject(DEFAULTS)),
            __metadata("design:paramtypes", [Object, Object, Object, Object, core.NgZone])
        ], AngularFireRemoteConfig);
AngularFireRemoteConfig.ɵfac = function AngularFireRemoteConfig_Factory(t) { return new (t || AngularFireRemoteConfig)(ɵngcc0.ɵɵinject(fire.FIREBASE_OPTIONS), ɵngcc0.ɵɵinject(fire.FIREBASE_APP_NAME, 8), ɵngcc0.ɵɵinject(SETTINGS, 8), ɵngcc0.ɵɵinject(DEFAULTS, 8), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
AngularFireRemoteConfig.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: AngularFireRemoteConfig, factory: function (t) { return AngularFireRemoteConfig.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireRemoteConfig, [{
        type: core.Injectable
    }], function () { return [{ type: Object, decorators: [{
                type: core.Inject,
                args: [fire.FIREBASE_OPTIONS]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [fire.FIREBASE_APP_NAME]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [SETTINGS]
            }] }, { type: Object, decorators: [{
                type: core.Optional
            }, {
                type: core.Inject,
                args: [DEFAULTS]
            }] }, { type: ɵngcc0.NgZone }]; }, null); })();
        return AngularFireRemoteConfig;
    }());
    var scanToParametersArray = function (remoteConfig) { return rxjs.pipe(operators.withLatestFrom(remoteConfig), operators.scan(function (existing, _a) {
        var all = _a[0], rc = _a[1];
        var allKeys = existing.map(function (p) { return p.key; }).concat(Object.keys(all)).filter(function (v, i, a) { return a.indexOf(v) === i; });
        return allKeys.map(function (key) {
            var updatedValue = all[key];
            return updatedValue ? new Parameter(key, rc ? rc.fetchTimeMillis : -1, updatedValue.getSource(), updatedValue.asString())
                : existing.find(function (p) { return p.key === key; });
        });
    }, [])); };
    var ɵ1 = scanToParametersArray;
    var AS_TO_FN = { 'strings': 'asString', 'numbers': 'asNumber', 'booleans': 'asBoolean' };
    var STATIC_VALUES = { 'numbers': 0, 'booleans': false, 'strings': undefined };
    var budget = function (interval) { return function (source) { return new rxjs.Observable(function (observer) {
        var timedOut = false;
        var timeout = setTimeout(function () {
            observer.complete();
            timedOut = true;
        }, interval);
        return source.subscribe({
            next: function (val) { if (!timedOut) {
                observer.next(val);
            } },
            error: function (err) { if (!timedOut) {
                clearTimeout(timeout);
                observer.error(err);
            } },
            complete: function () { if (!timedOut) {
                clearTimeout(timeout);
                observer.complete();
            } }
        });
    }); }; };
    var typedMethod = function (it) {
        switch (typeof it) {
            case 'string': return 'asString';
            case 'boolean': return 'asBoolean';
            case 'number': return 'asNumber';
            default: return 'asString';
        }
    };
    var ɵ2 = typedMethod;
    function scanToObject(to) {
        if (to === void 0) { to = 'strings'; }
        return rxjs.pipe(operators.scan(function (c, p) {
            var _a;
            return (__assign({}, c, (_a = {}, _a[p.key] = typeof to === 'object' ?
                p[typedMethod(to[p.key])]() :
                p[AS_TO_FN[to]](), _a)));
        }, typeof to === 'object' ?
            to :
            {}), operators.debounceTime(1), budget(10), operators.distinctUntilChanged(function (a, b) { return JSON.stringify(a) === JSON.stringify(b); }));
    }
    function mapToObject(to) {
        if (to === void 0) { to = 'strings'; }
        return rxjs.pipe(operators.map(function (params) { return params.reduce(function (c, p) {
            var _a;
            return (__assign({}, c, (_a = {}, _a[p.key] = typeof to === 'object' ?
                p[typedMethod(to[p.key])]() :
                p[AS_TO_FN[to]](), _a)));
        }, typeof to === 'object' ?
            to :
            {}); }), operators.distinctUntilChanged(function (a, b) { return JSON.stringify(a) === JSON.stringify(b); }));
    }
    var proxyAll = function (observable, as) { return new Proxy(observable.pipe(mapToObject(as)), {
        get: function (self, name) { return self[name] || observable.pipe(operators.map(function (all) { return all.find(function (p) { return p.key === name; }); }), operators.map(function (param) { return param ? param[AS_TO_FN[as]]() : STATIC_VALUES[as]; }), operators.distinctUntilChanged()); }
    }); };
    var ɵ3 = proxyAll;

    var __decorate$1 = (undefined && undefined.__decorate) || function (decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    };
    var AngularFireRemoteConfigModule = (function () {
        function AngularFireRemoteConfigModule() {
        }
AngularFireRemoteConfigModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: AngularFireRemoteConfigModule });
AngularFireRemoteConfigModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function AngularFireRemoteConfigModule_Factory(t) { return new (t || AngularFireRemoteConfigModule)(); }, providers: [AngularFireRemoteConfig] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(AngularFireRemoteConfigModule, [{
        type: core.NgModule,
        args: [{
                providers: [AngularFireRemoteConfig]
            }]
    }], function () { return []; }, null); })();
        return AngularFireRemoteConfigModule;
    }());

    exports.SETTINGS = SETTINGS;
    exports.DEFAULTS = DEFAULTS;
    exports.Value = Value;
    exports.Parameter = Parameter;
    exports.filterRemote = filterRemote;
    exports.filterFresh = filterFresh;
    exports.AngularFireRemoteConfig = AngularFireRemoteConfig;
    exports.budget = budget;
    exports.scanToObject = scanToObject;
    exports.mapToObject = mapToObject;
    exports.ɵ0 = ɵ0;
    exports.ɵ1 = ɵ1;
    exports.ɵ2 = ɵ2;
    exports.ɵ3 = ɵ3;
    exports.AngularFireRemoteConfigModule = AngularFireRemoteConfigModule;

    Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlLWNvbmZpZy51bWQuanMiLCJzb3VyY2VzIjpbInJlbW90ZS1jb25maWcudW1kLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0Esb0dBQTJFO0FBQzNFLHlFQUF5RDtBQUN6RCw0QkFBYTtBQUNiLDBCQUFtQjtBQUNuQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDhDQUVXO0FBQ1g7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7MkRBQW9DO0FBQ3BDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7OztnREFLMEM7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gKGdsb2JhbCwgZmFjdG9yeSkge1xuICAgIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyA/IGZhY3RvcnkoZXhwb3J0cywgcmVxdWlyZSgnQGFuZ3VsYXIvY29yZScpLCByZXF1aXJlKCdyeGpzJyksIHJlcXVpcmUoJ3J4anMvb3BlcmF0b3JzJyksIHJlcXVpcmUoJ0Bhbmd1bGFyL2ZpcmUnKSkgOlxuICAgIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShbJ2V4cG9ydHMnLCAnQGFuZ3VsYXIvY29yZScsICdyeGpzJywgJ3J4anMvb3BlcmF0b3JzJywgJ0Bhbmd1bGFyL2ZpcmUnXSwgZmFjdG9yeSkgOlxuICAgIChmYWN0b3J5KChnbG9iYWwuYW5ndWxhcmZpcmUyID0gZ2xvYmFsLmFuZ3VsYXJmaXJlMiB8fCB7fSwgZ2xvYmFsLmFuZ3VsYXJmaXJlMi5yZW1vdGVfY29uZmlnID0ge30pLGdsb2JhbC5uZy5jb3JlLGdsb2JhbC5yeGpzLGdsb2JhbC5yeGpzLm9wZXJhdG9ycyxnbG9iYWwuYW5ndWxhcmZpcmUyKSk7XG59KHRoaXMsIChmdW5jdGlvbiAoZXhwb3J0cyxjb3JlLHJ4anMsb3BlcmF0b3JzLGZpcmUpIHsgJ3VzZSBzdHJpY3QnO1xuXG4gICAgdmFyIF9fZXh0ZW5kcyA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fZXh0ZW5kcykgfHwgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGV4dGVuZFN0YXRpY3MgPSBmdW5jdGlvbiAoZCwgYikge1xuICAgICAgICAgICAgZXh0ZW5kU3RhdGljcyA9IE9iamVjdC5zZXRQcm90b3R5cGVPZiB8fFxuICAgICAgICAgICAgICAgICh7IF9fcHJvdG9fXzogW10gfSBpbnN0YW5jZW9mIEFycmF5ICYmIGZ1bmN0aW9uIChkLCBiKSB7IGQuX19wcm90b19fID0gYjsgfSkgfHxcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZCwgYikgeyBmb3IgKHZhciBwIGluIGIpIGlmIChiLmhhc093blByb3BlcnR5KHApKSBkW3BdID0gYltwXTsgfTtcbiAgICAgICAgICAgIHJldHVybiBleHRlbmRTdGF0aWNzKGQsIGIpO1xuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGQsIGIpIHtcbiAgICAgICAgICAgIGV4dGVuZFN0YXRpY3MoZCwgYik7XG4gICAgICAgICAgICBmdW5jdGlvbiBfXygpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGQ7IH1cbiAgICAgICAgICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcbiAgICAgICAgfTtcbiAgICB9KSgpO1xuICAgIHZhciBfX2Fzc2lnbiA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fYXNzaWduKSB8fCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIF9fYXNzaWduID0gT2JqZWN0LmFzc2lnbiB8fCBmdW5jdGlvbih0KSB7XG4gICAgICAgICAgICBmb3IgKHZhciBzLCBpID0gMSwgbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBuOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzID0gYXJndW1lbnRzW2ldO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSlcbiAgICAgICAgICAgICAgICAgICAgdFtwXSA9IHNbcF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdDtcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIF9fYXNzaWduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgfTtcbiAgICB2YXIgX19kZWNvcmF0ZSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgICAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgICAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgICAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xuICAgIH07XG4gICAgdmFyIF9fbWV0YWRhdGEgPSAodW5kZWZpbmVkICYmIHVuZGVmaW5lZC5fX21ldGFkYXRhKSB8fCBmdW5jdGlvbiAoaywgdikge1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QubWV0YWRhdGEgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIFJlZmxlY3QubWV0YWRhdGEoaywgdik7XG4gICAgfTtcbiAgICB2YXIgX19wYXJhbSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XG4gICAgfTtcbiAgICB2YXIgU0VUVElOR1MgPSBuZXcgY29yZS5JbmplY3Rpb25Ub2tlbignYW5ndWxhcmZpcmUyLnJlbW90ZUNvbmZpZy5zZXR0aW5ncycpO1xuICAgIHZhciBERUZBVUxUUyA9IG5ldyBjb3JlLkluamVjdGlvblRva2VuKCdhbmd1bGFyZmlyZTIucmVtb3RlQ29uZmlnLmRlZmF1bHRDb25maWcnKTtcbiAgICB2YXIgVmFsdWUgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBWYWx1ZShfc291cmNlLCBfdmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMuX3NvdXJjZSA9IF9zb3VyY2U7XG4gICAgICAgICAgICB0aGlzLl92YWx1ZSA9IF92YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICBWYWx1ZS5wcm90b3R5cGUuYXNCb29sZWFuID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gWycxJywgJ3RydWUnLCAndCcsICd5JywgJ3llcycsICdvbiddLmluZGV4T2YodGhpcy5fdmFsdWUudG9Mb3dlckNhc2UoKSkgPiAtMTsgfTtcbiAgICAgICAgVmFsdWUucHJvdG90eXBlLmFzU3RyaW5nID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy5fdmFsdWU7IH07XG4gICAgICAgIFZhbHVlLnByb3RvdHlwZS5hc051bWJlciA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIE51bWJlcih0aGlzLl92YWx1ZSkgfHwgMDsgfTtcbiAgICAgICAgVmFsdWUucHJvdG90eXBlLmdldFNvdXJjZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuX3NvdXJjZTsgfTtcbiAgICAgICAgcmV0dXJuIFZhbHVlO1xuICAgIH0oKSk7XG4gICAgdmFyIFBhcmFtZXRlciA9IChmdW5jdGlvbiAoX3N1cGVyKSB7XG4gICAgICAgIF9fZXh0ZW5kcyhQYXJhbWV0ZXIsIF9zdXBlcik7XG4gICAgICAgIGZ1bmN0aW9uIFBhcmFtZXRlcihrZXksIGZldGNoVGltZU1pbGxpcywgc291cmNlLCB2YWx1ZSkge1xuICAgICAgICAgICAgdmFyIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgc291cmNlLCB2YWx1ZSkgfHwgdGhpcztcbiAgICAgICAgICAgIF90aGlzLmtleSA9IGtleTtcbiAgICAgICAgICAgIF90aGlzLmZldGNoVGltZU1pbGxpcyA9IGZldGNoVGltZU1pbGxpcztcbiAgICAgICAgICAgIHJldHVybiBfdGhpcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUGFyYW1ldGVyO1xuICAgIH0oVmFsdWUpKTtcbiAgICB2YXIgZmlsdGVyVGVzdCA9IGZ1bmN0aW9uIChmbikgeyByZXR1cm4gb3BlcmF0b3JzLmZpbHRlcihmdW5jdGlvbiAoaXQpIHsgcmV0dXJuIEFycmF5LmlzQXJyYXkoaXQpID8gaXQuc29tZShmbikgOiBmbihpdCk7IH0pOyB9O1xuICAgIHZhciDJtTAgPSBmaWx0ZXJUZXN0O1xuICAgIHZhciBmaWx0ZXJSZW1vdGUgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBmaWx0ZXJUZXN0KGZ1bmN0aW9uIChwKSB7IHJldHVybiBwLmdldFNvdXJjZSgpID09PSAncmVtb3RlJzsgfSk7IH07XG4gICAgdmFyIGZpbHRlckZyZXNoID0gZnVuY3Rpb24gKGhvd1JlY2VudEluTWlsbGlzKSB7IHJldHVybiBmaWx0ZXJUZXN0KGZ1bmN0aW9uIChwKSB7IHJldHVybiBwLmZldGNoVGltZU1pbGxpcyArIGhvd1JlY2VudEluTWlsbGlzID49IG5ldyBEYXRlKCkuZ2V0VGltZSgpOyB9KTsgfTtcbiAgICB2YXIgQW5ndWxhckZpcmVSZW1vdGVDb25maWcgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBBbmd1bGFyRmlyZVJlbW90ZUNvbmZpZyhvcHRpb25zLCBuYW1lT3JDb25maWcsIHNldHRpbmdzLCBkZWZhdWx0Q29uZmlnLCB6b25lKSB7XG4gICAgICAgICAgICB0aGlzLnpvbmUgPSB6b25lO1xuICAgICAgICAgICAgdmFyIHNjaGVkdWxlcnMgPSBuZXcgZmlyZS7JtUFuZ3VsYXJGaXJlU2NoZWR1bGVycyh6b25lKTtcbiAgICAgICAgICAgIHZhciByZW1vdGVDb25maWckID0gcnhqcy5vZih1bmRlZmluZWQpLnBpcGUob3BlcmF0b3JzLm9ic2VydmVPbihzY2hlZHVsZXJzLm91dHNpZGVBbmd1bGFyKSwgb3BlcmF0b3JzLnN3aXRjaE1hcChmdW5jdGlvbiAoKSB7IHJldHVybiB6b25lLnJ1bk91dHNpZGVBbmd1bGFyKGZ1bmN0aW9uICgpIHsgcmV0dXJuIHJ4anMuZW1wdHkoKTsgfSk7IH0pLCBvcGVyYXRvcnMubWFwKGZ1bmN0aW9uICgpIHsgcmV0dXJuIGZpcmUuX2ZpcmViYXNlQXBwRmFjdG9yeShvcHRpb25zLCB6b25lLCBuYW1lT3JDb25maWcpOyB9KSwgb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYXBwKSB7IHJldHVybiBhcHAucmVtb3RlQ29uZmlnKCk7IH0pLCBvcGVyYXRvcnMudGFwKGZ1bmN0aW9uIChyYykge1xuICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncykge1xuICAgICAgICAgICAgICAgICAgICByYy5zZXR0aW5ncyA9IHNldHRpbmdzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdENvbmZpZykge1xuICAgICAgICAgICAgICAgICAgICByYy5kZWZhdWx0Q29uZmlnID0gZGVmYXVsdENvbmZpZztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSwgb3BlcmF0b3JzLnN0YXJ0V2l0aCh1bmRlZmluZWQpLCBvcGVyYXRvcnMuc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogZmFsc2UgfSkpO1xuICAgICAgICAgICAgdmFyIGxvYWRlZFJlbW90ZUNvbmZpZyQgPSByZW1vdGVDb25maWckLnBpcGUob3BlcmF0b3JzLmZpbHRlcihmdW5jdGlvbiAocmMpIHsgcmV0dXJuICEhcmM7IH0pKTtcbiAgICAgICAgICAgIHZhciBkZWZhdWx0JCA9IHJ4anMub2YoT2JqZWN0LmtleXMoZGVmYXVsdENvbmZpZyB8fCB7fSkucmVkdWNlKGZ1bmN0aW9uIChjLCBrKSB7XG4gICAgICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgICAgIHJldHVybiAoX19hc3NpZ24oe30sIGMsIChfYSA9IHt9LCBfYVtrXSA9IG5ldyBWYWx1ZShcImRlZmF1bHRcIiwgZGVmYXVsdENvbmZpZ1trXS50b1N0cmluZygpKSwgX2EpKSk7XG4gICAgICAgICAgICB9LCB7fSkpO1xuICAgICAgICAgICAgdmFyIGZpbHRlck91dERlZmF1bHRzID0gb3BlcmF0b3JzLm1hcChmdW5jdGlvbiAoYWxsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGFsbClcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoa2V5KSB7IHJldHVybiBhbGxba2V5XS5nZXRTb3VyY2UoKSAhPSAnZGVmYXVsdCc7IH0pXG4gICAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoZnVuY3Rpb24gKGFjYywga2V5KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBfYTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChfX2Fzc2lnbih7fSwgYWNjLCAoX2EgPSB7fSwgX2Fba2V5XSA9IGFsbFtrZXldLCBfYSkpKTtcbiAgICAgICAgICAgICAgICB9LCB7fSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHZhciBleGlzdGluZyQgPSBsb2FkZWRSZW1vdGVDb25maWckLnBpcGUob3BlcmF0b3JzLnN3aXRjaE1hcChmdW5jdGlvbiAocmMpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmMuYWN0aXZhdGUoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiByYy5lbnN1cmVJbml0aWFsaXplZCgpOyB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiByYy5nZXRBbGwoKTsgfSk7XG4gICAgICAgICAgICB9KSwgZmlsdGVyT3V0RGVmYXVsdHMpO1xuICAgICAgICAgICAgdmFyIGZyZXNoJCA9IGxvYWRlZFJlbW90ZUNvbmZpZyQucGlwZShvcGVyYXRvcnMuc3dpdGNoTWFwKGZ1bmN0aW9uIChyYykgeyByZXR1cm4gem9uZS5ydW5PdXRzaWRlQW5ndWxhcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJjLmZldGNoQW5kQWN0aXZhdGUoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiByYy5lbnN1cmVJbml0aWFsaXplZCgpOyB9KVxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiByYy5nZXRBbGwoKTsgfSk7XG4gICAgICAgICAgICB9KTsgfSksIGZpbHRlck91dERlZmF1bHRzKTtcbiAgICAgICAgICAgIHRoaXMucGFyYW1ldGVycyA9IHJ4anMuY29uY2F0KGRlZmF1bHQkLCBleGlzdGluZyQsIGZyZXNoJCkucGlwZShzY2FuVG9QYXJhbWV0ZXJzQXJyYXkocmVtb3RlQ29uZmlnJCksIG9wZXJhdG9ycy5zaGFyZVJlcGxheSh7IGJ1ZmZlclNpemU6IDEsIHJlZkNvdW50OiB0cnVlIH0pKTtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlcyA9IHRoaXMucGFyYW1ldGVycy5waXBlKG9wZXJhdG9ycy5zd2l0Y2hNYXAoZnVuY3Rpb24gKHBhcmFtcykgeyByZXR1cm4gcnhqcy5vZi5hcHBseSh2b2lkIDAsIHBhcmFtcyk7IH0pLCBvcGVyYXRvcnMuZ3JvdXBCeShmdW5jdGlvbiAocGFyYW0pIHsgcmV0dXJuIHBhcmFtLmtleTsgfSksIG9wZXJhdG9ycy5tZXJnZU1hcChmdW5jdGlvbiAoZ3JvdXApIHsgcmV0dXJuIGdyb3VwLnBpcGUob3BlcmF0b3JzLmRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpOyB9KSk7XG4gICAgICAgICAgICB0aGlzLnN0cmluZ3MgPSBwcm94eUFsbCh0aGlzLnBhcmFtZXRlcnMsICdzdHJpbmdzJyk7XG4gICAgICAgICAgICB0aGlzLmJvb2xlYW5zID0gcHJveHlBbGwodGhpcy5wYXJhbWV0ZXJzLCAnYm9vbGVhbnMnKTtcbiAgICAgICAgICAgIHRoaXMubnVtYmVycyA9IHByb3h5QWxsKHRoaXMucGFyYW1ldGVycywgJ251bWJlcnMnKTtcbiAgICAgICAgICAgIHJldHVybiBmaXJlLsm1bGF6eVNES1Byb3h5KHRoaXMsIGxvYWRlZFJlbW90ZUNvbmZpZyQsIHpvbmUpO1xuICAgICAgICB9XG4gICAgICAgIEFuZ3VsYXJGaXJlUmVtb3RlQ29uZmlnID0gX19kZWNvcmF0ZShbXG4gICAgICAgICAgICBjb3JlLkluamVjdGFibGUoKSxcbiAgICAgICAgICAgIF9fcGFyYW0oMCwgY29yZS5JbmplY3QoZmlyZS5GSVJFQkFTRV9PUFRJT05TKSksXG4gICAgICAgICAgICBfX3BhcmFtKDEsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMSwgY29yZS5JbmplY3QoZmlyZS5GSVJFQkFTRV9BUFBfTkFNRSkpLFxuICAgICAgICAgICAgX19wYXJhbSgyLCBjb3JlLk9wdGlvbmFsKCkpLCBfX3BhcmFtKDIsIGNvcmUuSW5qZWN0KFNFVFRJTkdTKSksXG4gICAgICAgICAgICBfX3BhcmFtKDMsIGNvcmUuT3B0aW9uYWwoKSksIF9fcGFyYW0oMywgY29yZS5JbmplY3QoREVGQVVMVFMpKSxcbiAgICAgICAgICAgIF9fbWV0YWRhdGEoXCJkZXNpZ246cGFyYW10eXBlc1wiLCBbT2JqZWN0LCBPYmplY3QsIE9iamVjdCwgT2JqZWN0LCBjb3JlLk5nWm9uZV0pXG4gICAgICAgIF0sIEFuZ3VsYXJGaXJlUmVtb3RlQ29uZmlnKTtcbiAgICAgICAgcmV0dXJuIEFuZ3VsYXJGaXJlUmVtb3RlQ29uZmlnO1xuICAgIH0oKSk7XG4gICAgdmFyIHNjYW5Ub1BhcmFtZXRlcnNBcnJheSA9IGZ1bmN0aW9uIChyZW1vdGVDb25maWcpIHsgcmV0dXJuIHJ4anMucGlwZShvcGVyYXRvcnMud2l0aExhdGVzdEZyb20ocmVtb3RlQ29uZmlnKSwgb3BlcmF0b3JzLnNjYW4oZnVuY3Rpb24gKGV4aXN0aW5nLCBfYSkge1xuICAgICAgICB2YXIgYWxsID0gX2FbMF0sIHJjID0gX2FbMV07XG4gICAgICAgIHZhciBhbGxLZXlzID0gZXhpc3RpbmcubWFwKGZ1bmN0aW9uIChwKSB7IHJldHVybiBwLmtleTsgfSkuY29uY2F0KE9iamVjdC5rZXlzKGFsbCkpLmZpbHRlcihmdW5jdGlvbiAodiwgaSwgYSkgeyByZXR1cm4gYS5pbmRleE9mKHYpID09PSBpOyB9KTtcbiAgICAgICAgcmV0dXJuIGFsbEtleXMubWFwKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICAgIHZhciB1cGRhdGVkVmFsdWUgPSBhbGxba2V5XTtcbiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkVmFsdWUgPyBuZXcgUGFyYW1ldGVyKGtleSwgcmMgPyByYy5mZXRjaFRpbWVNaWxsaXMgOiAtMSwgdXBkYXRlZFZhbHVlLmdldFNvdXJjZSgpLCB1cGRhdGVkVmFsdWUuYXNTdHJpbmcoKSlcbiAgICAgICAgICAgICAgICA6IGV4aXN0aW5nLmZpbmQoZnVuY3Rpb24gKHApIHsgcmV0dXJuIHAua2V5ID09PSBrZXk7IH0pO1xuICAgICAgICB9KTtcbiAgICB9LCBbXSkpOyB9O1xuICAgIHZhciDJtTEgPSBzY2FuVG9QYXJhbWV0ZXJzQXJyYXk7XG4gICAgdmFyIEFTX1RPX0ZOID0geyAnc3RyaW5ncyc6ICdhc1N0cmluZycsICdudW1iZXJzJzogJ2FzTnVtYmVyJywgJ2Jvb2xlYW5zJzogJ2FzQm9vbGVhbicgfTtcbiAgICB2YXIgU1RBVElDX1ZBTFVFUyA9IHsgJ251bWJlcnMnOiAwLCAnYm9vbGVhbnMnOiBmYWxzZSwgJ3N0cmluZ3MnOiB1bmRlZmluZWQgfTtcbiAgICB2YXIgYnVkZ2V0ID0gZnVuY3Rpb24gKGludGVydmFsKSB7IHJldHVybiBmdW5jdGlvbiAoc291cmNlKSB7IHJldHVybiBuZXcgcnhqcy5PYnNlcnZhYmxlKGZ1bmN0aW9uIChvYnNlcnZlcikge1xuICAgICAgICB2YXIgdGltZWRPdXQgPSBmYWxzZTtcbiAgICAgICAgdmFyIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB0aW1lZE91dCA9IHRydWU7XG4gICAgICAgIH0sIGludGVydmFsKTtcbiAgICAgICAgcmV0dXJuIHNvdXJjZS5zdWJzY3JpYmUoe1xuICAgICAgICAgICAgbmV4dDogZnVuY3Rpb24gKHZhbCkgeyBpZiAoIXRpbWVkT3V0KSB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh2YWwpO1xuICAgICAgICAgICAgfSB9LFxuICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uIChlcnIpIHsgaWYgKCF0aW1lZE91dCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfSB9LFxuICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uICgpIHsgaWYgKCF0aW1lZE91dCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSB9XG4gICAgICAgIH0pO1xuICAgIH0pOyB9OyB9O1xuICAgIHZhciB0eXBlZE1ldGhvZCA9IGZ1bmN0aW9uIChpdCkge1xuICAgICAgICBzd2l0Y2ggKHR5cGVvZiBpdCkge1xuICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzogcmV0dXJuICdhc1N0cmluZyc7XG4gICAgICAgICAgICBjYXNlICdib29sZWFuJzogcmV0dXJuICdhc0Jvb2xlYW4nO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzogcmV0dXJuICdhc051bWJlcic7XG4gICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gJ2FzU3RyaW5nJztcbiAgICAgICAgfVxuICAgIH07XG4gICAgdmFyIMm1MiA9IHR5cGVkTWV0aG9kO1xuICAgIGZ1bmN0aW9uIHNjYW5Ub09iamVjdCh0bykge1xuICAgICAgICBpZiAodG8gPT09IHZvaWQgMCkgeyB0byA9ICdzdHJpbmdzJzsgfVxuICAgICAgICByZXR1cm4gcnhqcy5waXBlKG9wZXJhdG9ycy5zY2FuKGZ1bmN0aW9uIChjLCBwKSB7XG4gICAgICAgICAgICB2YXIgX2E7XG4gICAgICAgICAgICByZXR1cm4gKF9fYXNzaWduKHt9LCBjLCAoX2EgPSB7fSwgX2FbcC5rZXldID0gdHlwZW9mIHRvID09PSAnb2JqZWN0JyA/XG4gICAgICAgICAgICAgICAgcFt0eXBlZE1ldGhvZCh0b1twLmtleV0pXSgpIDpcbiAgICAgICAgICAgICAgICBwW0FTX1RPX0ZOW3RvXV0oKSwgX2EpKSk7XG4gICAgICAgIH0sIHR5cGVvZiB0byA9PT0gJ29iamVjdCcgP1xuICAgICAgICAgICAgdG8gOlxuICAgICAgICAgICAge30pLCBvcGVyYXRvcnMuZGVib3VuY2VUaW1lKDEpLCBidWRnZXQoMTApLCBvcGVyYXRvcnMuZGlzdGluY3RVbnRpbENoYW5nZWQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpID09PSBKU09OLnN0cmluZ2lmeShiKTsgfSkpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBtYXBUb09iamVjdCh0bykge1xuICAgICAgICBpZiAodG8gPT09IHZvaWQgMCkgeyB0byA9ICdzdHJpbmdzJzsgfVxuICAgICAgICByZXR1cm4gcnhqcy5waXBlKG9wZXJhdG9ycy5tYXAoZnVuY3Rpb24gKHBhcmFtcykgeyByZXR1cm4gcGFyYW1zLnJlZHVjZShmdW5jdGlvbiAoYywgcCkge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgcmV0dXJuIChfX2Fzc2lnbih7fSwgYywgKF9hID0ge30sIF9hW3Aua2V5XSA9IHR5cGVvZiB0byA9PT0gJ29iamVjdCcgP1xuICAgICAgICAgICAgICAgIHBbdHlwZWRNZXRob2QodG9bcC5rZXldKV0oKSA6XG4gICAgICAgICAgICAgICAgcFtBU19UT19GTlt0b11dKCksIF9hKSkpO1xuICAgICAgICB9LCB0eXBlb2YgdG8gPT09ICdvYmplY3QnID9cbiAgICAgICAgICAgIHRvIDpcbiAgICAgICAgICAgIHt9KTsgfSksIG9wZXJhdG9ycy5kaXN0aW5jdFVudGlsQ2hhbmdlZChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSkgPT09IEpTT04uc3RyaW5naWZ5KGIpOyB9KSk7XG4gICAgfVxuICAgIHZhciBwcm94eUFsbCA9IGZ1bmN0aW9uIChvYnNlcnZhYmxlLCBhcykgeyByZXR1cm4gbmV3IFByb3h5KG9ic2VydmFibGUucGlwZShtYXBUb09iamVjdChhcykpLCB7XG4gICAgICAgIGdldDogZnVuY3Rpb24gKHNlbGYsIG5hbWUpIHsgcmV0dXJuIHNlbGZbbmFtZV0gfHwgb2JzZXJ2YWJsZS5waXBlKG9wZXJhdG9ycy5tYXAoZnVuY3Rpb24gKGFsbCkgeyByZXR1cm4gYWxsLmZpbmQoZnVuY3Rpb24gKHApIHsgcmV0dXJuIHAua2V5ID09PSBuYW1lOyB9KTsgfSksIG9wZXJhdG9ycy5tYXAoZnVuY3Rpb24gKHBhcmFtKSB7IHJldHVybiBwYXJhbSA/IHBhcmFtW0FTX1RPX0ZOW2FzXV0oKSA6IFNUQVRJQ19WQUxVRVNbYXNdOyB9KSwgb3BlcmF0b3JzLmRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpOyB9XG4gICAgfSk7IH07XG4gICAgdmFyIMm1MyA9IHByb3h5QWxsO1xuXG4gICAgdmFyIF9fZGVjb3JhdGUkMSA9ICh1bmRlZmluZWQgJiYgdW5kZWZpbmVkLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICAgICAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xuICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xuICAgICAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xuICAgICAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xuICAgIH07XG4gICAgdmFyIEFuZ3VsYXJGaXJlUmVtb3RlQ29uZmlnTW9kdWxlID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZnVuY3Rpb24gQW5ndWxhckZpcmVSZW1vdGVDb25maWdNb2R1bGUoKSB7XG4gICAgICAgIH1cbiAgICAgICAgQW5ndWxhckZpcmVSZW1vdGVDb25maWdNb2R1bGUgPSBfX2RlY29yYXRlJDEoW1xuICAgICAgICAgICAgY29yZS5OZ01vZHVsZSh7XG4gICAgICAgICAgICAgICAgcHJvdmlkZXJzOiBbQW5ndWxhckZpcmVSZW1vdGVDb25maWddXG4gICAgICAgICAgICB9KVxuICAgICAgICBdLCBBbmd1bGFyRmlyZVJlbW90ZUNvbmZpZ01vZHVsZSk7XG4gICAgICAgIHJldHVybiBBbmd1bGFyRmlyZVJlbW90ZUNvbmZpZ01vZHVsZTtcbiAgICB9KCkpO1xuXG4gICAgZXhwb3J0cy5TRVRUSU5HUyA9IFNFVFRJTkdTO1xuICAgIGV4cG9ydHMuREVGQVVMVFMgPSBERUZBVUxUUztcbiAgICBleHBvcnRzLlZhbHVlID0gVmFsdWU7XG4gICAgZXhwb3J0cy5QYXJhbWV0ZXIgPSBQYXJhbWV0ZXI7XG4gICAgZXhwb3J0cy5maWx0ZXJSZW1vdGUgPSBmaWx0ZXJSZW1vdGU7XG4gICAgZXhwb3J0cy5maWx0ZXJGcmVzaCA9IGZpbHRlckZyZXNoO1xuICAgIGV4cG9ydHMuQW5ndWxhckZpcmVSZW1vdGVDb25maWcgPSBBbmd1bGFyRmlyZVJlbW90ZUNvbmZpZztcbiAgICBleHBvcnRzLmJ1ZGdldCA9IGJ1ZGdldDtcbiAgICBleHBvcnRzLnNjYW5Ub09iamVjdCA9IHNjYW5Ub09iamVjdDtcbiAgICBleHBvcnRzLm1hcFRvT2JqZWN0ID0gbWFwVG9PYmplY3Q7XG4gICAgZXhwb3J0cy7JtTAgPSDJtTA7XG4gICAgZXhwb3J0cy7JtTEgPSDJtTE7XG4gICAgZXhwb3J0cy7JtTIgPSDJtTI7XG4gICAgZXhwb3J0cy7JtTMgPSDJtTM7XG4gICAgZXhwb3J0cy5Bbmd1bGFyRmlyZVJlbW90ZUNvbmZpZ01vZHVsZSA9IEFuZ3VsYXJGaXJlUmVtb3RlQ29uZmlnTW9kdWxlO1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTtcblxufSkpKTtcbiJdfQ==