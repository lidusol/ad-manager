import { Inject, Injectable, LOCALE_ID, NgZone, Optional } from '@angular/core';
import { Observable, of, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { GOOGLE_CHARTS_CONFIG } from '../models/injection-tokens.model';
import * as i0 from "@angular/core";
import * as i1 from "../models/injection-tokens.model";
import * as ɵngcc0 from '@angular/core';
const DEFAULT_CONFIG = {
    mapsApiKey: '',
    version: 'current',
    safeMode: false
};
export class ScriptLoaderService {
    constructor(zone, localeId, config) {
        this.zone = zone;
        this.localeId = localeId;
        this.config = config;
        this.scriptSource = 'https://www.gstatic.com/charts/loader.js';
        this.scriptLoadSubject = new Subject();
        this.config = Object.assign(Object.assign({}, DEFAULT_CONFIG), (config || {}));
    }
    /**
     * Checks whether `google.charts` is available.
     *
     * If not, it can be loaded by calling `loadChartPackages`.
     *
     * @returns `true` if `google.charts` is available, `false` otherwise.
     */
    isGoogleChartsAvailable() {
        if (typeof google === 'undefined' || typeof google.charts === 'undefined') {
            return false;
        }
        return true;
    }
    /**
     * Loads the Google Chart script and the provided chart packages.
     * Can be called multiple times to load more packages.
     *
     * When called without any arguments, this will just load the default package
     * containing the namespaces `google.charts` and `google.visualization` without any charts.
     *
     * @param packages The packages to load.
     * @returns A stream emitting as soon as the chart packages are loaded.
     */
    loadChartPackages(...packages) {
        return this.loadGoogleCharts().pipe(switchMap(() => {
            return new Observable(observer => {
                const config = {
                    packages,
                    language: this.localeId,
                    mapsApiKey: this.config.mapsApiKey,
                    safeMode: this.config.safeMode
                };
                google.charts.load(this.config.version, config);
                google.charts.setOnLoadCallback(() => {
                    this.zone.run(() => {
                        observer.next();
                        observer.complete();
                    });
                });
            });
        }));
    }
    /**
     * Loads the Google Charts script. After the script is loaded, `google.charts` is defined.
     *
     * @returns A stream emitting as soon as loading has completed.
     * If the google charts script is already loaded, the stream emits immediately.
     */
    loadGoogleCharts() {
        if (this.isGoogleChartsAvailable()) {
            return of(null);
        }
        else if (!this.isLoadingGoogleCharts()) {
            const script = this.createGoogleChartsScript();
            script.onload = () => {
                this.zone.run(() => {
                    this.scriptLoadSubject.next();
                    this.scriptLoadSubject.complete();
                });
            };
            script.onerror = () => {
                this.zone.run(() => {
                    console.error('Failed to load the google charts script!');
                    this.scriptLoadSubject.error(new Error('Failed to load the google charts script!'));
                });
            };
        }
        return this.scriptLoadSubject.asObservable();
    }
    isLoadingGoogleCharts() {
        return this.getGoogleChartsScript() != null;
    }
    getGoogleChartsScript() {
        const pageScripts = Array.from(document.getElementsByTagName('script'));
        return pageScripts.find(script => script.src === this.scriptSource);
    }
    createGoogleChartsScript() {
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = this.scriptSource;
        script.async = true;
        document.getElementsByTagName('head')[0].appendChild(script);
        return script;
    }
}
ScriptLoaderService.ɵfac = function ScriptLoaderService_Factory(t) { return new (t || ScriptLoaderService)(ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(LOCALE_ID), ɵngcc0.ɵɵinject(GOOGLE_CHARTS_CONFIG, 8)); };
ScriptLoaderService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ScriptLoaderService_Factory() { return new ScriptLoaderService(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i0.LOCALE_ID), i0.ɵɵinject(i1.GOOGLE_CHARTS_CONFIG, 8)); }, token: ScriptLoaderService, providedIn: "root" });
ScriptLoaderService.ctorParameters = () => [
    { type: NgZone },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [GOOGLE_CHARTS_CONFIG,] }, { type: Optional }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ScriptLoaderService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: String, decorators: [{
                type: Inject,
                args: [LOCALE_ID]
            }] }, { type: undefined, decorators: [{
                type: Inject,
                args: [GOOGLE_CHARTS_CONFIG]
            }, {
                type: Optional
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0LWxvYWRlci5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL2FuZ3VsYXItZ29vZ2xlLWNoYXJ0cy9zcmMvbGliL3NjcmlwdC1sb2FkZXIvc2NyaXB0LWxvYWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHM0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDeEU7QUFDb0M7O0FBQXBDLE1BQU0sY0FBYyxHQUF1QjtBQUMzQyxJQUFFLFVBQVUsRUFBRSxFQUFFO0FBQ2hCLElBQUUsT0FBTyxFQUFFLFNBQVM7QUFDcEIsSUFBRSxRQUFRLEVBQUUsS0FBSztBQUNqQixDQUFDLENBQUM7QUFHRixNQUFNLE9BQU8sbUJBQW1CO0FBQ2hDLElBR0UsWUFDVSxJQUFZLEVBQ08sUUFBZ0IsRUFDTyxNQUEyQjtBQUM5RSxRQUhTLFNBQUksR0FBSixJQUFJLENBQVE7QUFBQyxRQUNNLGFBQVEsR0FBUixRQUFRLENBQVE7QUFBQyxRQUNNLFdBQU0sR0FBTixNQUFNLENBQXFCO0FBQ2pGLFFBUG1CLGlCQUFZLEdBQUcsMENBQTBDLENBQUM7QUFDN0UsUUFBbUIsc0JBQWlCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztBQUMzRCxRQU1JLElBQUksQ0FBQyxNQUFNLG1DQUFRLGNBQWMsR0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBRSxDQUFDO0FBQzNELElBQUUsQ0FBQztBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFFSDtBQUFPO0FBRUos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Tmdab25lLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgR29vZ2xlQ2hhcnRzQ29uZmlnIH0gZnJvbSAnLi4vbW9kZWxzL2dvb2dsZS1jaGFydHMtY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IEdPT0dMRV9DSEFSVFNfQ09ORklHIH0gZnJvbSAnLi4vbW9kZWxzL2luamVjdGlvbi10b2tlbnMubW9kZWwnO1xuXG5jb25zdCBERUZBVUxUX0NPTkZJRzogR29vZ2xlQ2hhcnRzQ29uZmlnID0ge1xuICBtYXBzQXBpS2V5OiAnJyxcbiAgdmVyc2lvbjogJ2N1cnJlbnQnLFxuICBzYWZlTW9kZTogZmFsc2Vcbn07XG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgU2NyaXB0TG9hZGVyU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2NyaXB0U291cmNlID0gJ2h0dHBzOi8vd3d3LmdzdGF0aWMuY29tL2NoYXJ0cy9sb2FkZXIuanMnO1xuICBwcml2YXRlIHJlYWRvbmx5IHNjcmlwdExvYWRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSBsb2NhbGVJZDogc3RyaW5nLFxuICAgIEBJbmplY3QoR09PR0xFX0NIQVJUU19DT05GSUcpIEBPcHRpb25hbCgpIHByaXZhdGUgY29uZmlnPzogR29vZ2xlQ2hhcnRzQ29uZmlnXG4gICkge1xuICAgIHRoaXMuY29uZmlnID0geyAuLi5ERUZBVUxUX0NPTkZJRywgLi4uKGNvbmZpZyB8fCB7fSkgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3Mgd2hldGhlciBgZ29vZ2xlLmNoYXJ0c2AgaXMgYXZhaWxhYmxlLlxuICAgKlxuICAgKiBJZiBub3QsIGl0IGNhbiBiZSBsb2FkZWQgYnkgY2FsbGluZyBgbG9hZENoYXJ0UGFja2FnZXNgLlxuICAgKlxuICAgKiBAcmV0dXJucyBgdHJ1ZWAgaWYgYGdvb2dsZS5jaGFydHNgIGlzIGF2YWlsYWJsZSwgYGZhbHNlYCBvdGhlcndpc2UuXG4gICAqL1xuICBwdWJsaWMgaXNHb29nbGVDaGFydHNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgaWYgKHR5cGVvZiBnb29nbGUgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBnb29nbGUuY2hhcnRzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIHRoZSBHb29nbGUgQ2hhcnQgc2NyaXB0IGFuZCB0aGUgcHJvdmlkZWQgY2hhcnQgcGFja2FnZXMuXG4gICAqIENhbiBiZSBjYWxsZWQgbXVsdGlwbGUgdGltZXMgdG8gbG9hZCBtb3JlIHBhY2thZ2VzLlxuICAgKlxuICAgKiBXaGVuIGNhbGxlZCB3aXRob3V0IGFueSBhcmd1bWVudHMsIHRoaXMgd2lsbCBqdXN0IGxvYWQgdGhlIGRlZmF1bHQgcGFja2FnZVxuICAgKiBjb250YWluaW5nIHRoZSBuYW1lc3BhY2VzIGBnb29nbGUuY2hhcnRzYCBhbmQgYGdvb2dsZS52aXN1YWxpemF0aW9uYCB3aXRob3V0IGFueSBjaGFydHMuXG4gICAqXG4gICAqIEBwYXJhbSBwYWNrYWdlcyBUaGUgcGFja2FnZXMgdG8gbG9hZC5cbiAgICogQHJldHVybnMgQSBzdHJlYW0gZW1pdHRpbmcgYXMgc29vbiBhcyB0aGUgY2hhcnQgcGFja2FnZXMgYXJlIGxvYWRlZC5cbiAgICovXG4gIHB1YmxpYyBsb2FkQ2hhcnRQYWNrYWdlcyguLi5wYWNrYWdlczogc3RyaW5nW10pOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5sb2FkR29vZ2xlQ2hhcnRzKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTx2b2lkPihvYnNlcnZlciA9PiB7XG4gICAgICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICAgICAgcGFja2FnZXMsXG4gICAgICAgICAgICBsYW5ndWFnZTogdGhpcy5sb2NhbGVJZCxcbiAgICAgICAgICAgIG1hcHNBcGlLZXk6IHRoaXMuY29uZmlnLm1hcHNBcGlLZXksXG4gICAgICAgICAgICBzYWZlTW9kZTogdGhpcy5jb25maWcuc2FmZU1vZGVcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgZ29vZ2xlLmNoYXJ0cy5sb2FkKHRoaXMuY29uZmlnLnZlcnNpb24sIGNvbmZpZyk7XG4gICAgICAgICAgZ29vZ2xlLmNoYXJ0cy5zZXRPbkxvYWRDYWxsYmFjaygoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCgpO1xuICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIHRoZSBHb29nbGUgQ2hhcnRzIHNjcmlwdC4gQWZ0ZXIgdGhlIHNjcmlwdCBpcyBsb2FkZWQsIGBnb29nbGUuY2hhcnRzYCBpcyBkZWZpbmVkLlxuICAgKlxuICAgKiBAcmV0dXJucyBBIHN0cmVhbSBlbWl0dGluZyBhcyBzb29uIGFzIGxvYWRpbmcgaGFzIGNvbXBsZXRlZC5cbiAgICogSWYgdGhlIGdvb2dsZSBjaGFydHMgc2NyaXB0IGlzIGFscmVhZHkgbG9hZGVkLCB0aGUgc3RyZWFtIGVtaXRzIGltbWVkaWF0ZWx5LlxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkR29vZ2xlQ2hhcnRzKCkge1xuICAgIGlmICh0aGlzLmlzR29vZ2xlQ2hhcnRzQXZhaWxhYmxlKCkpIHtcbiAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICB9IGVsc2UgaWYgKCF0aGlzLmlzTG9hZGluZ0dvb2dsZUNoYXJ0cygpKSB7XG4gICAgICBjb25zdCBzY3JpcHQgPSB0aGlzLmNyZWF0ZUdvb2dsZUNoYXJ0c1NjcmlwdCgpO1xuICAgICAgc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zY3JpcHRMb2FkU3ViamVjdC5uZXh0KCk7XG4gICAgICAgICAgdGhpcy5zY3JpcHRMb2FkU3ViamVjdC5jb21wbGV0ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIHNjcmlwdC5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9hZCB0aGUgZ29vZ2xlIGNoYXJ0cyBzY3JpcHQhJyk7XG4gICAgICAgICAgdGhpcy5zY3JpcHRMb2FkU3ViamVjdC5lcnJvcihuZXcgRXJyb3IoJ0ZhaWxlZCB0byBsb2FkIHRoZSBnb29nbGUgY2hhcnRzIHNjcmlwdCEnKSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zY3JpcHRMb2FkU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNMb2FkaW5nR29vZ2xlQ2hhcnRzKCkge1xuICAgIHJldHVybiB0aGlzLmdldEdvb2dsZUNoYXJ0c1NjcmlwdCgpICE9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIGdldEdvb2dsZUNoYXJ0c1NjcmlwdCgpOiBIVE1MU2NyaXB0RWxlbWVudCB8IG51bGwge1xuICAgIGNvbnN0IHBhZ2VTY3JpcHRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JykpO1xuICAgIHJldHVybiBwYWdlU2NyaXB0cy5maW5kKHNjcmlwdCA9PiBzY3JpcHQuc3JjID09PSB0aGlzLnNjcmlwdFNvdXJjZSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUdvb2dsZUNoYXJ0c1NjcmlwdCgpOiBIVE1MU2NyaXB0RWxlbWVudCB7XG4gICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JztcbiAgICBzY3JpcHQuc3JjID0gdGhpcy5zY3JpcHRTb3VyY2U7XG4gICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgcmV0dXJuIHNjcmlwdDtcbiAgfVxufVxuIl19