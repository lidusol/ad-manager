import { __decorate, __metadata } from "tslib";
import { Component, EventEmitter, Output, ElementRef, Renderer2, } from "@angular/core";
import { DIRECTIONS } from "../misc/picker-directions";
import { Subject } from "rxjs";
import { takeUntil, debounceTime } from "rxjs/operators";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './emoji-content.component';
let EmojiPickerComponent = class EmojiPickerComponent {
    constructor(_renderer, _el) {
        this._renderer = _renderer;
        this._el = _el;
        this.selectionEmitter = new EventEmitter();
        this.pickerCloseEmitter = new EventEmitter();
        this._windowResize = new Subject();
        this._destroyed = new Subject();
        this._windowResize
            .pipe(takeUntil(this._destroyed), debounceTime(100))
            .subscribe((event) => {
            this.setPosition(this._currentTarget, this._currentDirection);
        });
    }
    hide() {
        this._renderer.setStyle(this._el.nativeElement, "display", "none");
    }
    show() {
        this._renderer.setStyle(this._el.nativeElement, "display", "block");
        this.setPosition(this._currentTarget, this._currentDirection);
    }
    setPosition(target, directionCode = DIRECTIONS.bottom) {
        if (!target) {
            return console.error("Emoji-Picker: positioning failed due to missing target element or direction code");
        }
        this._renderer.setStyle(this._el.nativeElement, "transform", "");
        /** Store anchor and direction */
        this._currentTarget = target;
        this._currentDirection = directionCode;
        const targetBorders = target.nativeElement.getBoundingClientRect(), thisBorders = this._el.nativeElement.getBoundingClientRect();
        let heightCorrection = 0, widthCorrection = 0;
        /** Setting up centering of picker for all cases */
        switch (this._currentDirection) {
            case DIRECTIONS.top:
            case DIRECTIONS.bottom:
                widthCorrection =
                    targetBorders.left -
                        thisBorders.left +
                        (targetBorders.width - thisBorders.width) / 2;
                break;
            case DIRECTIONS.left:
            case DIRECTIONS.right:
                heightCorrection =
                    targetBorders.top -
                        thisBorders.top +
                        (targetBorders.height - thisBorders.height) / 2;
                break;
        }
        /** Setting up relative positioning for all cases */
        switch (this._currentDirection) {
            case DIRECTIONS.top:
                heightCorrection = targetBorders.top - thisBorders.bottom;
                break;
            case DIRECTIONS.left:
                widthCorrection = targetBorders.left - thisBorders.right;
                break;
            case DIRECTIONS.right:
                widthCorrection = targetBorders.right - thisBorders.left;
                break;
            case DIRECTIONS.bottom:
                heightCorrection = targetBorders.bottom - thisBorders.top;
                break;
        }
        /** Correcting positioning due to overflow problems */
        if (thisBorders.bottom + heightCorrection > window.innerHeight) {
            heightCorrection +=
                window.innerHeight - (thisBorders.bottom + heightCorrection);
        }
        if (thisBorders.top + heightCorrection < 0) {
            heightCorrection -= thisBorders.top + heightCorrection;
        }
        if (thisBorders.right + widthCorrection > window.innerWidth) {
            widthCorrection +=
                window.innerWidth - (thisBorders.right + widthCorrection);
        }
        if (thisBorders.left + widthCorrection < 0) {
            widthCorrection -= thisBorders.left + widthCorrection;
        }
        /** set the position adjustments to the emoji picker element */
        this._renderer.setStyle(this._el.nativeElement, "transform", `translate(${widthCorrection}px,${heightCorrection}px)`);
    }
    onBackground(event) {
        /** internal mousedowns are ignored */
        if (event === this._lastHostMousedownEvent || event.emojiPickerExempt) {
            return;
        }
        this.pickerCloseEmitter.emit(event);
    }
    ngOnDestroy() {
        this._destroyed.next(true);
    }
};
EmojiPickerComponent.ɵfac = function EmojiPickerComponent_Factory(t) { return new (t || EmojiPickerComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
EmojiPickerComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: EmojiPickerComponent, selectors: [["emoji-picker"]], hostBindings: function EmojiPickerComponent_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function EmojiPickerComponent_click_HostBindingHandler($event) { return ctx.onBackground($event); }, false, ɵngcc0.ɵɵresolveDocument)("click", function EmojiPickerComponent_click_HostBindingHandler($event) { return ctx._lastHostMousedownEvent = $event; })("resize", function EmojiPickerComponent_resize_HostBindingHandler($event) { return ctx._windowResize.next($event); }, false, ɵngcc0.ɵɵresolveWindow);
    } }, outputs: { selectionEmitter: "emoji-select", pickerCloseEmitter: "picker-close" }, decls: 1, vars: 0, consts: [[3, "emoji-selection"]], template: function EmojiPickerComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "emoji-content", 0);
        ɵngcc0.ɵɵlistener("emoji-selection", function EmojiPickerComponent_Template_emoji_content_emoji_selection_0_listener($event) { return ctx.selectionEmitter.emit($event); });
        ɵngcc0.ɵɵelementEnd();
    } }, directives: [ɵngcc1.EmojiContentComponent], styles: ["[_nghost-%COMP%] { position: absolute; z-index: 9999; display: none; }"] });
EmojiPickerComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef }
];
__decorate([
    Output("emoji-select"),
    __metadata("design:type", Object)
], EmojiPickerComponent.prototype, "selectionEmitter", void 0);
__decorate([
    Output("picker-close"),
    __metadata("design:type", Object)
], EmojiPickerComponent.prototype, "pickerCloseEmitter", void 0);
EmojiPickerComponent = __decorate([ __metadata("design:paramtypes", [Renderer2, ElementRef])
], EmojiPickerComponent);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EmojiPickerComponent, [{
        type: Component,
        args: [{
                selector: "emoji-picker",
                template: `
    <emoji-content
      (emoji-selection)="selectionEmitter.emit($event)"
    ></emoji-content>
  `,
                host: {
                    "(document:click)": "onBackground($event)",
                    "(click)": "_lastHostMousedownEvent = $event",
                    "(window:resize)": "_windowResize.next($event)"
                },
                styles: [":host { position: absolute; z-index: 9999; display: none; }"]
            }]
    }], function () { return [{ type: ɵngcc0.Renderer2 }, { type: ɵngcc0.ElementRef }]; }, { selectionEmitter: [{
            type: Output,
            args: ["emoji-select"]
        }], pickerCloseEmitter: [{
            type: Output,
            args: ["picker-close"]
        }] }); })();
export { EmojiPickerComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamktcGlja2VyLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L25neC1lbW9qaS1waWNrZXIvbGliL2NvbXBvbmVudHMvZW1vamktcGlja2VyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLFVBQVUsRUFDVixTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBZ0J6RCxJQUFhLG9CQUFvQixHQUFqQyxNQUFhLG9CQUFvQjtBQUNqQyxJQVVFLFlBQW9CLFNBQW9CLEVBQVUsR0FBNEI7QUFDaEYsUUFEc0IsY0FBUyxHQUFULFNBQVMsQ0FBVztBQUFDLFFBQVMsUUFBRyxHQUFILEdBQUcsQ0FBeUI7QUFBQyxRQVZ2RCxxQkFBZ0IsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQ2hFLFFBQTBCLHVCQUFrQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDbEUsUUFLUyxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7QUFDNUMsUUFBUyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztBQUM3QyxRQUVJLElBQUksQ0FBQyxhQUFhO0FBQ3RCLGFBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFELGFBQU8sU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7QUFDM0IsWUFBUSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFD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QUksc0NBQXNDO0FBQzFDLFFBQUksSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLHVCQUF1QixJQUFJLEtBQUssQ0FBQyxpQkFBaUIsRUFBRTtBQUMzRSxZQUFNLE9BQU87QUFDYixTQUFLO0FBQ0wsUUFDSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hDLElBQUUsQ0FBQztBQUNILElBQ0UsV0FBVztBQUNiLFFBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0IsSUFBRSxDQUFDO0FBQ0gsQ0FBQzs7Ozs7Ozs7MklBQUE7QUFDRDtBQUE4QyxZQWpIYixTQUFTO0FBQUksWUFBVyxVQUFVO0FBQUc7QUFWNUM7QUFBYSxJQUFwQyxNQUFNLENBQUMsY0FBYyxDQUFDO0FBQUU7QUFDM0IsOERBRGdFO0FBQ3RDO0FBQWEsSUFBcEMsTUFBTSxDQUFDLGNBQWMsQ0FBQztBQUFFO0FBQXNDLGdFQUFDO0FBRnJELG9CQUFvQixvQkFkaEMsU0FBUyxDQUFDLFVBQ1QsUUFBUSxFQUFFLGNBQWMsakRBYXRCLGtDQVc2QixTQUFTLEVBQWUsVUFBVTtDQXRCakUsUUFBUSxFQUFFLFhBc0IwRCxHQVh6RCxvQkFBb0IsQ0EySGhDOztRQWxJRSxVQUNELElBQUksRUFBRTthQUNKO2NBQWtCLEVBQUUsc0JBQXNCO1VBQzFDLFNBQVMsRUFBRTs7UUFBa0MsY0FDN0MsaUJBQWlCLEVBQUU7YUFBNEI7RUFDaEQ7Z0JBVlE7cURBQTZELE9BV3ZFLENBQUM7Ozs7Ozs7Ozs7OztvQkE2SEY7QUFBQyxTQTVIWSxvQkFBb0I7QUFDaEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT3V0cHV0LFxuICBFbGVtZW50UmVmLFxuICBSZW5kZXJlcjIsXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBESVJFQ1RJT05TIH0gZnJvbSBcIi4uL21pc2MvcGlja2VyLWRpcmVjdGlvbnNcIjtcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgdGFrZVVudGlsLCBkZWJvdW5jZVRpbWUgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiBcImVtb2ppLXBpY2tlclwiLFxuICBzdHlsZXM6IFtcIjpob3N0IHsgcG9zaXRpb246IGFic29sdXRlOyB6LWluZGV4OiA5OTk5OyBkaXNwbGF5OiBub25lOyB9XCJdLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxlbW9qaS1jb250ZW50XG4gICAgICAoZW1vamktc2VsZWN0aW9uKT1cInNlbGVjdGlvbkVtaXR0ZXIuZW1pdCgkZXZlbnQpXCJcbiAgICA+PC9lbW9qaS1jb250ZW50PlxuICBgLFxuICBob3N0OiB7XG4gICAgXCIoZG9jdW1lbnQ6Y2xpY2spXCI6IFwib25CYWNrZ3JvdW5kKCRldmVudClcIixcbiAgICBcIihjbGljaylcIjogXCJfbGFzdEhvc3RNb3VzZWRvd25FdmVudCA9ICRldmVudFwiLFxuICAgIFwiKHdpbmRvdzpyZXNpemUpXCI6IFwiX3dpbmRvd1Jlc2l6ZS5uZXh0KCRldmVudClcIixcbiAgfSxcbn0pXG5leHBvcnQgY2xhc3MgRW1vamlQaWNrZXJDb21wb25lbnQge1xuICBAT3V0cHV0KFwiZW1vamktc2VsZWN0XCIpIHNlbGVjdGlvbkVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoXCJwaWNrZXItY2xvc2VcIikgcGlja2VyQ2xvc2VFbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIHB1YmxpYyBfbGFzdEhvc3RNb3VzZWRvd25FdmVudDtcbiAgcHVibGljIF9jdXJyZW50VGFyZ2V0OiBFbGVtZW50UmVmO1xuICBwdWJsaWMgX2N1cnJlbnREaXJlY3Rpb246IERJUkVDVElPTlM7XG5cbiAgcHVibGljIF93aW5kb3dSZXNpemUgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gIHB1YmxpYyBfZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9yZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIF9lbDogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4pIHtcbiAgICB0aGlzLl93aW5kb3dSZXNpemVcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQpLCBkZWJvdW5jZVRpbWUoMTAwKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5fY3VycmVudFRhcmdldCwgdGhpcy5fY3VycmVudERpcmVjdGlvbik7XG4gICAgICB9KTtcbiAgfVxuXG4gIGhpZGUoKSB7XG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUodGhpcy5fZWwubmF0aXZlRWxlbWVudCwgXCJkaXNwbGF5XCIsIFwibm9uZVwiKTtcbiAgfVxuXG4gIHNob3coKSB7XG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUodGhpcy5fZWwubmF0aXZlRWxlbWVudCwgXCJkaXNwbGF5XCIsIFwiYmxvY2tcIik7XG4gICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLl9jdXJyZW50VGFyZ2V0LCB0aGlzLl9jdXJyZW50RGlyZWN0aW9uKTtcbiAgfVxuXG4gIHNldFBvc2l0aW9uKFxuICAgIHRhcmdldDogRWxlbWVudFJlZixcbiAgICBkaXJlY3Rpb25Db2RlOiBESVJFQ1RJT05TID0gRElSRUNUSU9OUy5ib3R0b21cbiAgKSB7XG4gICAgaWYgKCF0YXJnZXQpIHtcbiAgICAgIHJldHVybiBjb25zb2xlLmVycm9yKFxuICAgICAgICBcIkVtb2ppLVBpY2tlcjogcG9zaXRpb25pbmcgZmFpbGVkIGR1ZSB0byBtaXNzaW5nIHRhcmdldCBlbGVtZW50IG9yIGRpcmVjdGlvbiBjb2RlXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUodGhpcy5fZWwubmF0aXZlRWxlbWVudCwgXCJ0cmFuc2Zvcm1cIiwgXCJcIik7XG5cbiAgICAvKiogU3RvcmUgYW5jaG9yIGFuZCBkaXJlY3Rpb24gKi9cbiAgICB0aGlzLl9jdXJyZW50VGFyZ2V0ID0gdGFyZ2V0O1xuICAgIHRoaXMuX2N1cnJlbnREaXJlY3Rpb24gPSBkaXJlY3Rpb25Db2RlO1xuXG4gICAgY29uc3QgdGFyZ2V0Qm9yZGVycyA9IHRhcmdldC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxuICAgICAgdGhpc0JvcmRlcnMgPSB0aGlzLl9lbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuXG4gICAgbGV0IGhlaWdodENvcnJlY3Rpb24gPSAwLFxuICAgICAgd2lkdGhDb3JyZWN0aW9uID0gMDtcblxuICAgIC8qKiBTZXR0aW5nIHVwIGNlbnRlcmluZyBvZiBwaWNrZXIgZm9yIGFsbCBjYXNlcyAqL1xuICAgIHN3aXRjaCAodGhpcy5fY3VycmVudERpcmVjdGlvbikge1xuICAgICAgY2FzZSBESVJFQ1RJT05TLnRvcDpcbiAgICAgIGNhc2UgRElSRUNUSU9OUy5ib3R0b206XG4gICAgICAgIHdpZHRoQ29ycmVjdGlvbiA9XG4gICAgICAgICAgdGFyZ2V0Qm9yZGVycy5sZWZ0IC1cbiAgICAgICAgICB0aGlzQm9yZGVycy5sZWZ0ICtcbiAgICAgICAgICAodGFyZ2V0Qm9yZGVycy53aWR0aCAtIHRoaXNCb3JkZXJzLndpZHRoKSAvIDI7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBESVJFQ1RJT05TLmxlZnQ6XG4gICAgICBjYXNlIERJUkVDVElPTlMucmlnaHQ6XG4gICAgICAgIGhlaWdodENvcnJlY3Rpb24gPVxuICAgICAgICAgIHRhcmdldEJvcmRlcnMudG9wIC1cbiAgICAgICAgICB0aGlzQm9yZGVycy50b3AgK1xuICAgICAgICAgICh0YXJnZXRCb3JkZXJzLmhlaWdodCAtIHRoaXNCb3JkZXJzLmhlaWdodCkgLyAyO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvKiogU2V0dGluZyB1cCByZWxhdGl2ZSBwb3NpdGlvbmluZyBmb3IgYWxsIGNhc2VzICovXG4gICAgc3dpdGNoICh0aGlzLl9jdXJyZW50RGlyZWN0aW9uKSB7XG4gICAgICBjYXNlIERJUkVDVElPTlMudG9wOlxuICAgICAgICBoZWlnaHRDb3JyZWN0aW9uID0gdGFyZ2V0Qm9yZGVycy50b3AgLSB0aGlzQm9yZGVycy5ib3R0b207XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBESVJFQ1RJT05TLmxlZnQ6XG4gICAgICAgIHdpZHRoQ29ycmVjdGlvbiA9IHRhcmdldEJvcmRlcnMubGVmdCAtIHRoaXNCb3JkZXJzLnJpZ2h0O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRElSRUNUSU9OUy5yaWdodDpcbiAgICAgICAgd2lkdGhDb3JyZWN0aW9uID0gdGFyZ2V0Qm9yZGVycy5yaWdodCAtIHRoaXNCb3JkZXJzLmxlZnQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBESVJFQ1RJT05TLmJvdHRvbTpcbiAgICAgICAgaGVpZ2h0Q29ycmVjdGlvbiA9IHRhcmdldEJvcmRlcnMuYm90dG9tIC0gdGhpc0JvcmRlcnMudG9wO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvKiogQ29ycmVjdGluZyBwb3NpdGlvbmluZyBkdWUgdG8gb3ZlcmZsb3cgcHJvYmxlbXMgKi9cbiAgICBpZiAodGhpc0JvcmRlcnMuYm90dG9tICsgaGVpZ2h0Q29ycmVjdGlvbiA+IHdpbmRvdy5pbm5lckhlaWdodCkge1xuICAgICAgaGVpZ2h0Q29ycmVjdGlvbiArPVxuICAgICAgICB3aW5kb3cuaW5uZXJIZWlnaHQgLSAodGhpc0JvcmRlcnMuYm90dG9tICsgaGVpZ2h0Q29ycmVjdGlvbik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXNCb3JkZXJzLnRvcCArIGhlaWdodENvcnJlY3Rpb24gPCAwKSB7XG4gICAgICBoZWlnaHRDb3JyZWN0aW9uIC09IHRoaXNCb3JkZXJzLnRvcCArIGhlaWdodENvcnJlY3Rpb247XG4gICAgfVxuXG4gICAgaWYgKHRoaXNCb3JkZXJzLnJpZ2h0ICsgd2lkdGhDb3JyZWN0aW9uID4gd2luZG93LmlubmVyV2lkdGgpIHtcbiAgICAgIHdpZHRoQ29ycmVjdGlvbiArPVxuICAgICAgICB3aW5kb3cuaW5uZXJXaWR0aCAtICh0aGlzQm9yZGVycy5yaWdodCArIHdpZHRoQ29ycmVjdGlvbik7XG4gICAgfVxuXG4gICAgaWYgKHRoaXNCb3JkZXJzLmxlZnQgKyB3aWR0aENvcnJlY3Rpb24gPCAwKSB7XG4gICAgICB3aWR0aENvcnJlY3Rpb24gLT0gdGhpc0JvcmRlcnMubGVmdCArIHdpZHRoQ29ycmVjdGlvbjtcbiAgICB9XG5cbiAgICAvKiogc2V0IHRoZSBwb3NpdGlvbiBhZGp1c3RtZW50cyB0byB0aGUgZW1vamkgcGlja2VyIGVsZW1lbnQgKi9cbiAgICB0aGlzLl9yZW5kZXJlci5zZXRTdHlsZShcbiAgICAgIHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsXG4gICAgICBcInRyYW5zZm9ybVwiLFxuICAgICAgYHRyYW5zbGF0ZSgke3dpZHRoQ29ycmVjdGlvbn1weCwke2hlaWdodENvcnJlY3Rpb259cHgpYFxuICAgICk7XG4gIH1cblxuICBvbkJhY2tncm91bmQoZXZlbnQpIHtcbiAgICAvKiogaW50ZXJuYWwgbW91c2Vkb3ducyBhcmUgaWdub3JlZCAqL1xuICAgIGlmIChldmVudCA9PT0gdGhpcy5fbGFzdEhvc3RNb3VzZWRvd25FdmVudCB8fCBldmVudC5lbW9qaVBpY2tlckV4ZW1wdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMucGlja2VyQ2xvc2VFbWl0dGVyLmVtaXQoZXZlbnQpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fZGVzdHJveWVkLm5leHQodHJ1ZSk7XG4gIH1cbn1cbiJdfQ==