import { __decorate, __metadata } from "tslib";
import { Component, EventEmitter, Output, ElementRef, Renderer2, } from "@angular/core";
import { DIRECTIONS } from "../misc/picker-directions";
import { Subject } from "rxjs";
import { takeUntil, debounceTime } from "rxjs/operators";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './emoji-content.component';
var EmojiPickerComponent = /** @class */ (function () {
    function EmojiPickerComponent(_renderer, _el) {
        var _this = this;
        this._renderer = _renderer;
        this._el = _el;
        this.selectionEmitter = new EventEmitter();
        this.pickerCloseEmitter = new EventEmitter();
        this._windowResize = new Subject();
        this._destroyed = new Subject();
        this._windowResize
            .pipe(takeUntil(this._destroyed), debounceTime(100))
            .subscribe(function (event) {
            _this.setPosition(_this._currentTarget, _this._currentDirection);
        });
    }
    EmojiPickerComponent.prototype.hide = function () {
        this._renderer.setStyle(this._el.nativeElement, "display", "none");
    };
    EmojiPickerComponent.prototype.show = function () {
        this._renderer.setStyle(this._el.nativeElement, "display", "block");
        this.setPosition(this._currentTarget, this._currentDirection);
    };
    EmojiPickerComponent.prototype.setPosition = function (target, directionCode) {
        if (directionCode === void 0) { directionCode = DIRECTIONS.bottom; }
        if (!target) {
            return console.error("Emoji-Picker: positioning failed due to missing target element or direction code");
        }
        this._renderer.setStyle(this._el.nativeElement, "transform", "");
        /** Store anchor and direction */
        this._currentTarget = target;
        this._currentDirection = directionCode;
        var targetBorders = target.nativeElement.getBoundingClientRect(), thisBorders = this._el.nativeElement.getBoundingClientRect();
        var heightCorrection = 0, widthCorrection = 0;
        /** Setting up centering of picker for all cases */
        switch (this._currentDirection) {
            case DIRECTIONS.top:
            case DIRECTIONS.bottom:
                widthCorrection =
                    targetBorders.left -
                        thisBorders.left +
                        (targetBorders.width - thisBorders.width) / 2;
                break;
            case DIRECTIONS.left:
            case DIRECTIONS.right:
                heightCorrection =
                    targetBorders.top -
                        thisBorders.top +
                        (targetBorders.height - thisBorders.height) / 2;
                break;
        }
        /** Setting up relative positioning for all cases */
        switch (this._currentDirection) {
            case DIRECTIONS.top:
                heightCorrection = targetBorders.top - thisBorders.bottom;
                break;
            case DIRECTIONS.left:
                widthCorrection = targetBorders.left - thisBorders.right;
                break;
            case DIRECTIONS.right:
                widthCorrection = targetBorders.right - thisBorders.left;
                break;
            case DIRECTIONS.bottom:
                heightCorrection = targetBorders.bottom - thisBorders.top;
                break;
        }
        /** Correcting positioning due to overflow problems */
        if (thisBorders.bottom + heightCorrection > window.innerHeight) {
            heightCorrection +=
                window.innerHeight - (thisBorders.bottom + heightCorrection);
        }
        if (thisBorders.top + heightCorrection < 0) {
            heightCorrection -= thisBorders.top + heightCorrection;
        }
        if (thisBorders.right + widthCorrection > window.innerWidth) {
            widthCorrection +=
                window.innerWidth - (thisBorders.right + widthCorrection);
        }
        if (thisBorders.left + widthCorrection < 0) {
            widthCorrection -= thisBorders.left + widthCorrection;
        }
        /** set the position adjustments to the emoji picker element */
        this._renderer.setStyle(this._el.nativeElement, "transform", "translate(" + widthCorrection + "px," + heightCorrection + "px)");
    };
    EmojiPickerComponent.prototype.onBackground = function (event) {
        /** internal mousedowns are ignored */
        if (event === this._lastHostMousedownEvent || event.emojiPickerExempt) {
            return;
        }
        this.pickerCloseEmitter.emit(event);
    };
    EmojiPickerComponent.prototype.ngOnDestroy = function () {
        this._destroyed.next(true);
    };
    EmojiPickerComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef }
    ]; };
    __decorate([
        Output("emoji-select"),
        __metadata("design:type", Object)
    ], EmojiPickerComponent.prototype, "selectionEmitter", void 0);
    __decorate([
        Output("picker-close"),
        __metadata("design:type", Object)
    ], EmojiPickerComponent.prototype, "pickerCloseEmitter", void 0);
    EmojiPickerComponent = __decorate([ __metadata("design:paramtypes", [Renderer2, ElementRef])
    ], EmojiPickerComponent);
EmojiPickerComponent.ɵfac = function EmojiPickerComponent_Factory(t) { return new (t || EmojiPickerComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
EmojiPickerComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: EmojiPickerComponent, selectors: [["emoji-picker"]], hostBindings: function EmojiPickerComponent_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("click", function EmojiPickerComponent_click_HostBindingHandler($event) { return ctx.onBackground($event); }, false, ɵngcc0.ɵɵresolveDocument)("click", function EmojiPickerComponent_click_HostBindingHandler($event) { return ctx._lastHostMousedownEvent = $event; })("resize", function EmojiPickerComponent_resize_HostBindingHandler($event) { return ctx._windowResize.next($event); }, false, ɵngcc0.ɵɵresolveWindow);
    } }, outputs: { selectionEmitter: "emoji-select", pickerCloseEmitter: "picker-close" }, decls: 1, vars: 0, consts: [[3, "emoji-selection"]], template: function EmojiPickerComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "emoji-content", 0);
        ɵngcc0.ɵɵlistener("emoji-selection", function EmojiPickerComponent_Template_emoji_content_emoji_selection_0_listener($event) { return ctx.selectionEmitter.emit($event); });
        ɵngcc0.ɵɵelementEnd();
    } }, directives: [ɵngcc1.EmojiContentComponent], styles: ["[_nghost-%COMP%] { position: absolute; z-index: 9999; display: none; }"] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EmojiPickerComponent, [{
        type: Component,
        args: [{
                selector: "emoji-picker",
                template: "\n    <emoji-content\n      (emoji-selection)=\"selectionEmitter.emit($event)\"\n    ></emoji-content>\n  ",
                host: {
                    "(document:click)": "onBackground($event)",
                    "(click)": "_lastHostMousedownEvent = $event",
                    "(window:resize)": "_windowResize.next($event)"
                },
                styles: [":host { position: absolute; z-index: 9999; display: none; }"]
            }]
    }], function () { return [{ type: ɵngcc0.Renderer2 }, { type: ɵngcc0.ElementRef }]; }, { selectionEmitter: [{
            type: Output,
            args: ["emoji-select"]
        }], pickerCloseEmitter: [{
            type: Output,
            args: ["picker-close"]
        }] }); })();
    return EmojiPickerComponent;
}());
export { EmojiPickerComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamktcGlja2VyLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsibmc6L25neC1lbW9qaS1waWNrZXIvbGliL2NvbXBvbmVudHMvZW1vamktcGlja2VyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osTUFBTSxFQUNOLFVBQVUsRUFDVixTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7O0FBZ0J6RDtBQUNvQixJQVVsQiw4QkFBb0IsU0FBb0IsRUFBVSxHQUE0QjtBQUNoRixRQURFLGlCQU1DO0FBQ0gsUUFQc0IsY0FBUyxHQUFULFNBQVMsQ0FBVztBQUFDLFFBQVMsUUFBRyxHQUFILEdBQUcsQ0FBeUI7QUFBQyxRQVZ2RCxxQkFBZ0IsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0FBQ2hFLFFBQTBCLHVCQUFrQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDbEUsUUFLUyxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7QUFDNUMsUUFBUyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztBQUM3QyxRQUVJLElBQUksQ0FBQyxhQUFhO0FBQ3RCLGFBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzFELGFBQU8sU0FBUyxDQUFDLFVBQUMsS0FBSztBQUFJLFlBQ25CLEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSSxDQUFDLGNBQWMsRUFBRSxLQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN0RSxRQUFNLENBQUMsQ0FBQyxDQUFD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LDJDQUFZLEdBQVosVUFBYSxLQUFLO0FBQ3BCLFFBQUksc0NBQXNDO0FBQzFDLFFBQUksSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLHVCQUF1QixJQUFJLEtBQUssQ0FBQyxpQkFBaUIsRUFBRTtBQUMzRSxZQUFNLE9BQU87QUFDYixTQUFLO0FBQ0wsUUFDSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3hDLElBQUUsQ0FBQztBQUVILElBQUUsMENBQVcsR0FBWDtBQUFjLFFBQ1osSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0IsSUFBRSxDQUFDO0FBQ0Y7QUFDK0QsZ0JBakgvQixTQUFTO0FBQUksZ0JBQVcsVUFBVTtBQUFHO0FBQVUsSUFWdEQ7QUFBYSxRQUFwQyxNQUFNLENBQUMsY0FBYyxDQUFDO0FBQUU7QUFDdkIsa0VBRDREO0FBQy9ELElBQXlCO0FBQWEsUUFBcEMsTUFBTSxDQUFDLGNBQWMsQ0FBQztBQUFFO0FBRTFCLG9FQUZpRTtBQUVsRSxJQUphLG9CQUFvQix3QkFkaEMsU0FBUyxDQUFDLGNBQ1QsUUFBUSxFQUFFLGNBQWMsekRBYWxCLGtDQVd5QixTQUFTLEVBQWUsVUFBVTthQXRCakUsUUFBUSxFQUFFLHZCQXNCMEQsT0FYekQsb0JBQW9CLENBMkhoQztxR0FsSUUsY0FDRCxJQUFJLEVBQUUsa0JBQ0osa0JBQWtCLEVBQUUsc0JBQXNCLGtCQUMxQztLQUFTLEVBQUUsa0NBQWtDLGtCQUM3QyxpQkFBaUIsRUFBRSw0QkFBNEIsZUFDaEQsdUJBVlE7U0FBNkQsV0FXdkUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQTZIRjtBQUFDLElBREQsMkJBQUM7QUFDQSxDQURBLEFBM0hELElBMkhDO0FBQ0QsU0E1SGEsb0JBQW9CO0FBQ2hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIE91dHB1dCxcbiAgRWxlbWVudFJlZixcbiAgUmVuZGVyZXIyLFxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRElSRUNUSU9OUyB9IGZyb20gXCIuLi9taXNjL3BpY2tlci1kaXJlY3Rpb25zXCI7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7IHRha2VVbnRpbCwgZGVib3VuY2VUaW1lIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogXCJlbW9qaS1waWNrZXJcIixcbiAgc3R5bGVzOiBbXCI6aG9zdCB7IHBvc2l0aW9uOiBhYnNvbHV0ZTsgei1pbmRleDogOTk5OTsgZGlzcGxheTogbm9uZTsgfVwiXSxcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZW1vamktY29udGVudFxuICAgICAgKGVtb2ppLXNlbGVjdGlvbik9XCJzZWxlY3Rpb25FbWl0dGVyLmVtaXQoJGV2ZW50KVwiXG4gICAgPjwvZW1vamktY29udGVudD5cbiAgYCxcbiAgaG9zdDoge1xuICAgIFwiKGRvY3VtZW50OmNsaWNrKVwiOiBcIm9uQmFja2dyb3VuZCgkZXZlbnQpXCIsXG4gICAgXCIoY2xpY2spXCI6IFwiX2xhc3RIb3N0TW91c2Vkb3duRXZlbnQgPSAkZXZlbnRcIixcbiAgICBcIih3aW5kb3c6cmVzaXplKVwiOiBcIl93aW5kb3dSZXNpemUubmV4dCgkZXZlbnQpXCIsXG4gIH0sXG59KVxuZXhwb3J0IGNsYXNzIEVtb2ppUGlja2VyQ29tcG9uZW50IHtcbiAgQE91dHB1dChcImVtb2ppLXNlbGVjdFwiKSBzZWxlY3Rpb25FbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KFwicGlja2VyLWNsb3NlXCIpIHBpY2tlckNsb3NlRW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwdWJsaWMgX2xhc3RIb3N0TW91c2Vkb3duRXZlbnQ7XG4gIHB1YmxpYyBfY3VycmVudFRhcmdldDogRWxlbWVudFJlZjtcbiAgcHVibGljIF9jdXJyZW50RGlyZWN0aW9uOiBESVJFQ1RJT05TO1xuXG4gIHB1YmxpYyBfd2luZG93UmVzaXplID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICBwdWJsaWMgX2Rlc3Ryb3llZCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBfZWw6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+KSB7XG4gICAgdGhpcy5fd2luZG93UmVzaXplXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5fZGVzdHJveWVkKSwgZGVib3VuY2VUaW1lKDEwMCkpXG4gICAgICAuc3Vic2NyaWJlKChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLnNldFBvc2l0aW9uKHRoaXMuX2N1cnJlbnRUYXJnZXQsIHRoaXMuX2N1cnJlbnREaXJlY3Rpb24pO1xuICAgICAgfSk7XG4gIH1cblxuICBoaWRlKCkge1xuICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIFwiZGlzcGxheVwiLCBcIm5vbmVcIik7XG4gIH1cblxuICBzaG93KCkge1xuICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIFwiZGlzcGxheVwiLCBcImJsb2NrXCIpO1xuICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5fY3VycmVudFRhcmdldCwgdGhpcy5fY3VycmVudERpcmVjdGlvbik7XG4gIH1cblxuICBzZXRQb3NpdGlvbihcbiAgICB0YXJnZXQ6IEVsZW1lbnRSZWYsXG4gICAgZGlyZWN0aW9uQ29kZTogRElSRUNUSU9OUyA9IERJUkVDVElPTlMuYm90dG9tXG4gICkge1xuICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICByZXR1cm4gY29uc29sZS5lcnJvcihcbiAgICAgICAgXCJFbW9qaS1QaWNrZXI6IHBvc2l0aW9uaW5nIGZhaWxlZCBkdWUgdG8gbWlzc2luZyB0YXJnZXQgZWxlbWVudCBvciBkaXJlY3Rpb24gY29kZVwiXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKHRoaXMuX2VsLm5hdGl2ZUVsZW1lbnQsIFwidHJhbnNmb3JtXCIsIFwiXCIpO1xuXG4gICAgLyoqIFN0b3JlIGFuY2hvciBhbmQgZGlyZWN0aW9uICovXG4gICAgdGhpcy5fY3VycmVudFRhcmdldCA9IHRhcmdldDtcbiAgICB0aGlzLl9jdXJyZW50RGlyZWN0aW9uID0gZGlyZWN0aW9uQ29kZTtcblxuICAgIGNvbnN0IHRhcmdldEJvcmRlcnMgPSB0YXJnZXQubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxcbiAgICAgIHRoaXNCb3JkZXJzID0gdGhpcy5fZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgIGxldCBoZWlnaHRDb3JyZWN0aW9uID0gMCxcbiAgICAgIHdpZHRoQ29ycmVjdGlvbiA9IDA7XG5cbiAgICAvKiogU2V0dGluZyB1cCBjZW50ZXJpbmcgb2YgcGlja2VyIGZvciBhbGwgY2FzZXMgKi9cbiAgICBzd2l0Y2ggKHRoaXMuX2N1cnJlbnREaXJlY3Rpb24pIHtcbiAgICAgIGNhc2UgRElSRUNUSU9OUy50b3A6XG4gICAgICBjYXNlIERJUkVDVElPTlMuYm90dG9tOlxuICAgICAgICB3aWR0aENvcnJlY3Rpb24gPVxuICAgICAgICAgIHRhcmdldEJvcmRlcnMubGVmdCAtXG4gICAgICAgICAgdGhpc0JvcmRlcnMubGVmdCArXG4gICAgICAgICAgKHRhcmdldEJvcmRlcnMud2lkdGggLSB0aGlzQm9yZGVycy53aWR0aCkgLyAyO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRElSRUNUSU9OUy5sZWZ0OlxuICAgICAgY2FzZSBESVJFQ1RJT05TLnJpZ2h0OlxuICAgICAgICBoZWlnaHRDb3JyZWN0aW9uID1cbiAgICAgICAgICB0YXJnZXRCb3JkZXJzLnRvcCAtXG4gICAgICAgICAgdGhpc0JvcmRlcnMudG9wICtcbiAgICAgICAgICAodGFyZ2V0Qm9yZGVycy5oZWlnaHQgLSB0aGlzQm9yZGVycy5oZWlnaHQpIC8gMjtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLyoqIFNldHRpbmcgdXAgcmVsYXRpdmUgcG9zaXRpb25pbmcgZm9yIGFsbCBjYXNlcyAqL1xuICAgIHN3aXRjaCAodGhpcy5fY3VycmVudERpcmVjdGlvbikge1xuICAgICAgY2FzZSBESVJFQ1RJT05TLnRvcDpcbiAgICAgICAgaGVpZ2h0Q29ycmVjdGlvbiA9IHRhcmdldEJvcmRlcnMudG9wIC0gdGhpc0JvcmRlcnMuYm90dG9tO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRElSRUNUSU9OUy5sZWZ0OlxuICAgICAgICB3aWR0aENvcnJlY3Rpb24gPSB0YXJnZXRCb3JkZXJzLmxlZnQgLSB0aGlzQm9yZGVycy5yaWdodDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIERJUkVDVElPTlMucmlnaHQ6XG4gICAgICAgIHdpZHRoQ29ycmVjdGlvbiA9IHRhcmdldEJvcmRlcnMucmlnaHQgLSB0aGlzQm9yZGVycy5sZWZ0O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRElSRUNUSU9OUy5ib3R0b206XG4gICAgICAgIGhlaWdodENvcnJlY3Rpb24gPSB0YXJnZXRCb3JkZXJzLmJvdHRvbSAtIHRoaXNCb3JkZXJzLnRvcDtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLyoqIENvcnJlY3RpbmcgcG9zaXRpb25pbmcgZHVlIHRvIG92ZXJmbG93IHByb2JsZW1zICovXG4gICAgaWYgKHRoaXNCb3JkZXJzLmJvdHRvbSArIGhlaWdodENvcnJlY3Rpb24gPiB3aW5kb3cuaW5uZXJIZWlnaHQpIHtcbiAgICAgIGhlaWdodENvcnJlY3Rpb24gKz1cbiAgICAgICAgd2luZG93LmlubmVySGVpZ2h0IC0gKHRoaXNCb3JkZXJzLmJvdHRvbSArIGhlaWdodENvcnJlY3Rpb24pO1xuICAgIH1cblxuICAgIGlmICh0aGlzQm9yZGVycy50b3AgKyBoZWlnaHRDb3JyZWN0aW9uIDwgMCkge1xuICAgICAgaGVpZ2h0Q29ycmVjdGlvbiAtPSB0aGlzQm9yZGVycy50b3AgKyBoZWlnaHRDb3JyZWN0aW9uO1xuICAgIH1cblxuICAgIGlmICh0aGlzQm9yZGVycy5yaWdodCArIHdpZHRoQ29ycmVjdGlvbiA+IHdpbmRvdy5pbm5lcldpZHRoKSB7XG4gICAgICB3aWR0aENvcnJlY3Rpb24gKz1cbiAgICAgICAgd2luZG93LmlubmVyV2lkdGggLSAodGhpc0JvcmRlcnMucmlnaHQgKyB3aWR0aENvcnJlY3Rpb24pO1xuICAgIH1cblxuICAgIGlmICh0aGlzQm9yZGVycy5sZWZ0ICsgd2lkdGhDb3JyZWN0aW9uIDwgMCkge1xuICAgICAgd2lkdGhDb3JyZWN0aW9uIC09IHRoaXNCb3JkZXJzLmxlZnQgKyB3aWR0aENvcnJlY3Rpb247XG4gICAgfVxuXG4gICAgLyoqIHNldCB0aGUgcG9zaXRpb24gYWRqdXN0bWVudHMgdG8gdGhlIGVtb2ppIHBpY2tlciBlbGVtZW50ICovXG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUoXG4gICAgICB0aGlzLl9lbC5uYXRpdmVFbGVtZW50LFxuICAgICAgXCJ0cmFuc2Zvcm1cIixcbiAgICAgIGB0cmFuc2xhdGUoJHt3aWR0aENvcnJlY3Rpb259cHgsJHtoZWlnaHRDb3JyZWN0aW9ufXB4KWBcbiAgICApO1xuICB9XG5cbiAgb25CYWNrZ3JvdW5kKGV2ZW50KSB7XG4gICAgLyoqIGludGVybmFsIG1vdXNlZG93bnMgYXJlIGlnbm9yZWQgKi9cbiAgICBpZiAoZXZlbnQgPT09IHRoaXMuX2xhc3RIb3N0TW91c2Vkb3duRXZlbnQgfHwgZXZlbnQuZW1vamlQaWNrZXJFeGVtcHQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnBpY2tlckNsb3NlRW1pdHRlci5lbWl0KGV2ZW50KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX2Rlc3Ryb3llZC5uZXh0KHRydWUpO1xuICB9XG59XG4iXX0=